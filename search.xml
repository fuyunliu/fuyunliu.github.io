<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>八大排序算法的 Python 实现</title>
    <url>/2018/03/14/8-sort-algorithm/</url>
    <content><![CDATA[<!-- toc -->

<h2 id="插入排序"><a href="#插入排序" class="headerlink" title="插入排序"></a>插入排序</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insert_sort</span>(<span class="params">lists</span>):</span></span><br><span class="line">    count = <span class="built_in">len</span>(lists)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, count):</span><br><span class="line">        key = lists[i]</span><br><span class="line">        j = i - <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> j &gt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> lists[j] &gt; key:</span><br><span class="line">                lists[j + <span class="number">1</span>] = lists[j]</span><br><span class="line">                lists[j] = key</span><br><span class="line">            j -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> lists</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p><img src="/images/Insertion_sort_animation.gif" class="lazyload" data-srcset="/images/Insertion_sort_animation.gif" srcset="data:image/png;base64,666" alt="insert_sort"></p>
<h2 id="希尔排序"><a href="#希尔排序" class="headerlink" title="希尔排序"></a>希尔排序</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shell_sort</span>(<span class="params">lists</span>):</span></span><br><span class="line">    count = <span class="built_in">len</span>(lists)</span><br><span class="line">    step = <span class="number">2</span></span><br><span class="line">    group = count // step</span><br><span class="line">    <span class="keyword">while</span> group &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, group):</span><br><span class="line">            j = i + group</span><br><span class="line">            <span class="keyword">while</span> j &lt; count:</span><br><span class="line">                k = j - group</span><br><span class="line">                key = lists[j]</span><br><span class="line">                <span class="keyword">while</span> k &gt;= <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> lists[k] &gt; key:</span><br><span class="line">                        lists[k + group] = lists[k]</span><br><span class="line">                        lists[k] = key</span><br><span class="line">                    k -= group</span><br><span class="line">                j += group</span><br><span class="line">        group //= step</span><br><span class="line">    <span class="keyword">return</span> lists</span><br></pre></td></tr></table></figure>

<p><img src="/images/Sorting_shellsort_anim.gif" class="lazyload" data-srcset="/images/Sorting_shellsort_anim.gif" srcset="data:image/png;base64,666" alt="shell_sort"></p>
<h2 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bubble_sort</span>(<span class="params">lists</span>):</span></span><br><span class="line">    count = <span class="built_in">len</span>(lists)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, count):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, count):</span><br><span class="line">            <span class="keyword">if</span> lists[i] &gt; lists[j]:</span><br><span class="line">                lists[i], lists[j] = lists[j], lists[i]</span><br><span class="line">    <span class="keyword">return</span> lists</span><br></pre></td></tr></table></figure>

<p><img src="/images/Bubble_sort_animation.gif" class="lazyload" data-srcset="/images/Bubble_sort_animation.gif" srcset="data:image/png;base64,666" alt="bubble_sort"></p>
<h2 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">qs = <span class="keyword">lambda</span> xs: ((<span class="built_in">len</span>(xs) &lt;= <span class="number">1</span> <span class="keyword">and</span> [xs]) <span class="keyword">or</span> [qs([x <span class="keyword">for</span> x <span class="keyword">in</span> xs[<span class="number">1</span>:] <span class="keyword">if</span> x &lt; xs[</span><br><span class="line">                 <span class="number">0</span>]]) + [xs[<span class="number">0</span>]] + qs([x <span class="keyword">for</span> x <span class="keyword">in</span> xs[<span class="number">1</span>:] <span class="keyword">if</span> x &gt;= xs[<span class="number">0</span>]])])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quick_sort</span>(<span class="params">lists, left=<span class="number">0</span>, right=<span class="number">9</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> left &gt;= right:</span><br><span class="line">        <span class="keyword">return</span> lists</span><br><span class="line">    key = lists[left]</span><br><span class="line">    low = left</span><br><span class="line">    high = right</span><br><span class="line">    <span class="keyword">while</span> left &lt; right:</span><br><span class="line">        <span class="keyword">while</span> left &lt; right <span class="keyword">and</span> lists[right] &gt;= key:</span><br><span class="line">            right -= <span class="number">1</span></span><br><span class="line">        lists[left] = lists[right]</span><br><span class="line">        <span class="keyword">while</span> left &lt; right <span class="keyword">and</span> lists[left] &lt;= key:</span><br><span class="line">            left += <span class="number">1</span></span><br><span class="line">        lists[right] = lists[left]</span><br><span class="line">    lists[right] = key</span><br><span class="line">    quick_sort(lists, low, left - <span class="number">1</span>)</span><br><span class="line">    quick_sort(lists, left + <span class="number">1</span>, high)</span><br><span class="line">    <span class="keyword">return</span> lists</span><br></pre></td></tr></table></figure>

<p><img src="/images/Sorting_quicksort_anim.gif" class="lazyload" data-srcset="/images/Sorting_quicksort_anim.gif" srcset="data:image/png;base64,666" alt="quick_sort"></p>
<h2 id="选择排序"><a href="#选择排序" class="headerlink" title="选择排序"></a>选择排序</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_sort</span>(<span class="params">lists</span>):</span></span><br><span class="line">    count = <span class="built_in">len</span>(lists)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, count):</span><br><span class="line">        <span class="built_in">min</span> = i</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, count):</span><br><span class="line">            <span class="keyword">if</span> lists[<span class="built_in">min</span>] &gt; lists[j]:</span><br><span class="line">                <span class="built_in">min</span> = j</span><br><span class="line">        lists[<span class="built_in">min</span>], lists[i] = lists[i], lists[<span class="built_in">min</span>]</span><br><span class="line">    <span class="keyword">return</span> lists</span><br></pre></td></tr></table></figure>

<p><img src="/images/Selection_sort_animation.gif" class="lazyload" data-srcset="/images/Selection_sort_animation.gif" srcset="data:image/png;base64,666" alt="select_sort"></p>
<h2 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">adjust_heap</span>(<span class="params">lists, i, size</span>):</span></span><br><span class="line">    lchild = <span class="number">2</span> * i + <span class="number">1</span></span><br><span class="line">    rchild = <span class="number">2</span> * i + <span class="number">2</span></span><br><span class="line">    <span class="built_in">max</span> = i</span><br><span class="line">    <span class="keyword">if</span> i &lt; size // <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> lchild &lt; size <span class="keyword">and</span> lists[lchild] &gt; lists[<span class="built_in">max</span>]:</span><br><span class="line">            <span class="built_in">max</span> = lchild</span><br><span class="line">        <span class="keyword">if</span> rchild &lt; size <span class="keyword">and</span> lists[rchild] &gt; lists[<span class="built_in">max</span>]:</span><br><span class="line">            <span class="built_in">max</span> = rchild</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">max</span> != i:</span><br><span class="line">            lists[<span class="built_in">max</span>], lists[i] = lists[i], lists[<span class="built_in">max</span>]</span><br><span class="line">            adjust_heap(lists, <span class="built_in">max</span>, size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_heap</span>(<span class="params">lists, size</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, (size // <span class="number">2</span>))[::-<span class="number">1</span>]:</span><br><span class="line">        adjust_heap(lists, i, size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">heap_sort</span>(<span class="params">lists</span>):</span></span><br><span class="line">    size = <span class="built_in">len</span>(lists)</span><br><span class="line">    build_heap(lists, size)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, size)[::-<span class="number">1</span>]:</span><br><span class="line">        lists[<span class="number">0</span>], lists[i] = lists[i], lists[<span class="number">0</span>]</span><br><span class="line">        adjust_heap(lists, <span class="number">0</span>, i)</span><br><span class="line">    <span class="keyword">return</span> lists</span><br></pre></td></tr></table></figure>

<p><img src="/images/Sorting_heapsort_anim.gif" class="lazyload" data-srcset="/images/Sorting_heapsort_anim.gif" srcset="data:image/png;base64,666" alt="heap_sort"></p>
<h2 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge</span>(<span class="params">left, right</span>):</span></span><br><span class="line">    i, j = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(left) <span class="keyword">and</span> j &lt; <span class="built_in">len</span>(right):</span><br><span class="line">        <span class="keyword">if</span> left[i] &lt;= right[j]:</span><br><span class="line">            result.append(left[i])</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result.append(right[j])</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">    result += left[i:]</span><br><span class="line">    result += right[j:]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge_sort</span>(<span class="params">lists</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(lists) &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> lists</span><br><span class="line">    num = <span class="built_in">len</span>(lists) // <span class="number">2</span></span><br><span class="line">    left = merge_sort(lists[:num])</span><br><span class="line">    right = merge_sort(lists[num:])</span><br><span class="line">    <span class="keyword">return</span> merge(left, right)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Merge_sort_animation2.gif" class="lazyload" data-srcset="/images/Merge_sort_animation2.gif" srcset="data:image/png;base64,666" alt="merge_sort"></p>
<h2 id="基数排序"><a href="#基数排序" class="headerlink" title="基数排序"></a>基数排序</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">radix_sort</span>(<span class="params">lists, radix=<span class="number">10</span></span>):</span></span><br><span class="line">    k = <span class="built_in">int</span>(math.ceil(math.log(<span class="built_in">max</span>(lists), radix)))</span><br><span class="line">    bucket = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(radix)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, k + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> lists:</span><br><span class="line">            bucket[j // (radix**(i - <span class="number">1</span>)) % radix].append(j)</span><br><span class="line">        <span class="keyword">del</span> lists[:]</span><br><span class="line">        <span class="keyword">for</span> z <span class="keyword">in</span> bucket:</span><br><span class="line">            lists += z</span><br><span class="line">            <span class="keyword">del</span> z[:]</span><br><span class="line">    <span class="keyword">return</span> lists</span><br></pre></td></tr></table></figure>

<p><img src="/images/radix_sort.gif" class="lazyload" data-srcset="/images/radix_sort.gif" srcset="data:image/png;base64,666" alt="merge_sort"></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line">original_test = <span class="built_in">list</span>(random.randint(<span class="number">1</span>, <span class="number">100</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line">print(<span class="string">&quot;原始列表：    %s&quot;</span> % original_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入排序</span></span><br><span class="line">insert_test = insert_sort(original_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 希尔排序</span></span><br><span class="line">shell_test = shell_sort(original_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 冒泡排序</span></span><br><span class="line">bubble_test = bubble_sort(original_test)</span><br><span class="line"></span><br><span class="line">快速排序</span><br><span class="line">quick_test = quick_sort(original_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接选择排序</span></span><br><span class="line">select_test = select_sort(original_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 堆排序</span></span><br><span class="line">heap_test = heap_sort(original_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 归并排序</span></span><br><span class="line">merge_test = merge_sort(original_test)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基数排序</span></span><br><span class="line">radix_test = radix_sort(original_test)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;插入排序：    %s&quot;</span> % insert_test)</span><br><span class="line">print(<span class="string">&quot;希尔排序：    %s&quot;</span> % shell_test)</span><br><span class="line">print(<span class="string">&quot;冒泡排序：    %s&quot;</span> % bubble_test)</span><br><span class="line">print(<span class="string">&quot;快速排序：    %s&quot;</span> % quick_test)</span><br><span class="line">print(<span class="string">&quot;直接选择排序：%s&quot;</span> % select_test)</span><br><span class="line">print(<span class="string">&quot;堆排序：      %s&quot;</span> % heap_test)</span><br><span class="line">print(<span class="string">&quot;归并排序：    %s&quot;</span> % merge_test)</span><br><span class="line">print(<span class="string">&quot;基数排序：    %s&quot;</span> % radix_test)</span><br><span class="line">print(<span class="string">&quot;快速排序：    %s&quot;</span> % qs(original_test))</span><br></pre></td></tr></table></figure>

<p>本文来自：<a href="http://python.jobbole.com/82270">八大排序算法的 Python 实现</a></p>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Python3</tag>
      </tags>
  </entry>
  <entry>
    <title>Asyncio 笔记</title>
    <url>/2018/11/11/asyncio-tutorial/</url>
    <content><![CDATA[<!-- toc -->

<!-- markdownlint-disable MD033 -->

<blockquote><p>并发是指一次处理多件事。
并行是指一次做多件事。
二者不同，但是有联系。
一个关于结构，一个关于执行。
并发用于制定方案，用来解决可能（但未必）并行的问题。</p>
<p align="right">——Rob Pike
Go 语言的创造者之一</p></blockquote>

<a id="more"></a>

<hr>
<h2 id="异步版-hello-world"><a href="#异步版-hello-world" class="headerlink" title="异步版 hello-world"></a>异步版 <code>hello-world</code></h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    print(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">.1</span>)</span><br><span class="line">    print(<span class="string">&#x27;world&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># python3.7 提供</span></span><br><span class="line">asyncio.run(main())</span><br><span class="line"></span><br><span class="line"><span class="comment"># main 函数是个协程，直接运行不会执行操作</span></span><br><span class="line"><span class="comment"># main() --&gt; &lt;coroutine object main at 0x109be6d48&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="运行协程的三种方式"><a href="#运行协程的三种方式" class="headerlink" title="运行协程的三种方式"></a>运行协程的三种方式</h2><ul>
<li><code>asyncio.run()</code></li>
<li>使用 <code>await</code> 关键字</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">say_after</span>(<span class="params">delay, what</span>):</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(delay)</span><br><span class="line">    print(what)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    print(<span class="string">f&quot;started at <span class="subst">&#123;time.strftime(<span class="string">&#x27;%X&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> say_after(<span class="number">1</span>, <span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> say_after(<span class="number">2</span>, <span class="string">&#x27;world&#x27;</span>)</span><br><span class="line">    print(<span class="string">f&quot;finished at <span class="subst">&#123;time.strftime(<span class="string">&#x27;%X&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>asyncio.create_task()</code> 创建一个 <code>Task</code> 对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 直接对上面的 main 函数进行修改</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    t1 = asyncio.create_task(say_after(<span class="number">1</span>, <span class="string">&#x27;hello&#x27;</span>))</span><br><span class="line">    t2 = asyncio.create_task(say_after(<span class="number">2</span>, <span class="string">&#x27;world&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    print(<span class="string">f&quot;started at <span class="subst">&#123;time.strftime(<span class="string">&#x27;%X&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> t1</span><br><span class="line">    <span class="keyword">await</span> t2</span><br><span class="line"></span><br><span class="line">    print(<span class="string">f&quot;finished at <span class="subst">&#123;time.strftime(<span class="string">&#x27;%X&#x27;</span>)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Awaitable-对象"><a href="#Awaitable-对象" class="headerlink" title="Awaitable 对象"></a>Awaitable 对象</h2><p><code>awaitable</code> 对象是指可以在 <code>await</code> 表达式中使用的对象。</p>
<p><code>coroutines</code>, <code>Tasks</code> 和 <code>Futures</code> 是 <code>awaitable</code> 对象。</p>
<ul>
<li>协程 <code>coroutines</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">nested</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这中方式不会执行 nested 函数</span></span><br><span class="line">    nested()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># await</span></span><br><span class="line">    print(<span class="keyword">await</span> nested())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<ul>
<li>任务 <code>Tasks</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">nested</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    t = asyncio.create_task(nested())</span><br><span class="line">    <span class="keyword">await</span> t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<ul>
<li>期物 <code>Futures</code></li>
</ul>
<h2 id="并发执行-Tasks"><a href="#并发执行-Tasks" class="headerlink" title="并发执行 Tasks"></a>并发执行 Tasks</h2><p>使用 <code>asyncio.gather</code> 并发执行 <code>Tasks</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">factorial</span>(<span class="params">name, number</span>):</span></span><br><span class="line">    f = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, number + <span class="number">1</span>):</span><br><span class="line">        print(<span class="string">f&quot;Task <span class="subst">&#123;name&#125;</span>: Compute factorial(<span class="subst">&#123;i&#125;</span>)...&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">        f *= i</span><br><span class="line">    print(<span class="string">f&quot;Task <span class="subst">&#123;name&#125;</span>: factorial(<span class="subst">&#123;number&#125;</span>) = <span class="subst">&#123;f&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(</span><br><span class="line">        factorial(<span class="string">&#x27;A&#x27;</span>, <span class="number">2</span>),</span><br><span class="line">        factorial(<span class="string">&#x27;B&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">        factorial(<span class="string">&#x27;C&#x27;</span>, <span class="number">4</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h2 id="线程和协程的对比"><a href="#线程和协程的对比" class="headerlink" title="线程和协程的对比"></a>线程和协程的对比</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 线程版以动画形式显示文本旋转指针</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Signal</span>:</span></span><br><span class="line">    go = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spin</span>(<span class="params">msg, signal</span>):</span></span><br><span class="line">    write, flush = sys.stdout.write, sys.stdout.flush</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> itertools.cycle(<span class="string">&#x27;|/-\\&#x27;</span>):</span><br><span class="line">        status = char + <span class="string">&#x27; &#x27;</span> + msg</span><br><span class="line">        write(status)</span><br><span class="line">        flush()</span><br><span class="line">        write(<span class="string">&#x27;\x08&#x27;</span> * <span class="built_in">len</span>(status))</span><br><span class="line">        time.sleep(<span class="number">.1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> signal.go:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    write(<span class="string">&#x27; &#x27;</span> * <span class="built_in">len</span>(status) + <span class="string">&#x27;\x08&#x27;</span> * <span class="built_in">len</span>(status))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">slow_funtion</span>():</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">supervisor</span>():</span></span><br><span class="line">    signal = Signal()</span><br><span class="line">    spinner = threading.Thread(</span><br><span class="line">        target=spin,</span><br><span class="line">        args=(<span class="string">&#x27;thinking!&#x27;</span>, signal))</span><br><span class="line">    print(<span class="string">&#x27;spinner object: &#x27;</span>, spinner)</span><br><span class="line">    spinner.start()</span><br><span class="line">    result = slow_funtion()</span><br><span class="line">    signal.go = <span class="literal">False</span></span><br><span class="line">    spinner.join()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    result = supervisor()</span><br><span class="line">    print(<span class="string">&#x27;Answer: &#x27;</span>, result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 协程版以动画形式显示文本旋转指针</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">spin</span>(<span class="params">msg</span>):</span></span><br><span class="line">    write, flush = sys.stdout.write, sys.stdout.flush</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> itertools.cycle(<span class="string">&#x27;|/-\\&#x27;</span>):</span><br><span class="line">        status = char + <span class="string">&#x27; &#x27;</span> + msg</span><br><span class="line">        write(status)</span><br><span class="line">        flush()</span><br><span class="line">        write(<span class="string">&#x27;\x08&#x27;</span> * <span class="built_in">len</span>(status))</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">.1</span>)</span><br><span class="line">        <span class="keyword">except</span> asyncio.CancelledError:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    write(<span class="string">&#x27; &#x27;</span> * <span class="built_in">len</span>(status) + <span class="string">&#x27;\x08&#x27;</span> * <span class="built_in">len</span>(status))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">slow_funtion</span>():</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">supervisor</span>():</span></span><br><span class="line">    spinner = asyncio.create_task(spin(<span class="string">&#x27;thinking!&#x27;</span>))</span><br><span class="line">    print(<span class="string">&#x27;spinner object: &#x27;</span>, spinner)</span><br><span class="line">    result = <span class="keyword">await</span> slow_funtion()</span><br><span class="line">    spinner.cancel()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一般执行方式</span></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">result = loop.run_until_complete(supervisor())</span><br><span class="line">loop.close()</span><br><span class="line">print(<span class="string">&#x27;Answer: &#x27;</span>, result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># python3.7 执行方式</span></span><br><span class="line">asyncio.run(supervisor())</span><br></pre></td></tr></table></figure>

<ul>
<li>Task 对象像是实现协作式多任务的库（如 <code>gevent</code>）中的绿色线程（<code>green thread</code>）。</li>
<li>Task 对象用于驱动协程，Thread 对象用于调用可调用对象。</li>
<li>Task 对象不由自己手动实例化，而是由 <code>asyncio.create_task</code> 方法获取。</li>
<li>获取的 Task 对象已经排定了运行时间，而 Thread 实例需要调用 <code>start</code> 方法运行。</li>
<li>异步版 <code>slow_funtion</code> 是协程，由 <code>await</code> （就是 <code>yield from</code>）驱动。</li>
<li>终止线程需要借助外部变量 <code>go</code>,终止 Task 可以调用 <code>Task.cancel()</code> 实例方法，在协程内部抛出 <code>CancelledError</code> 异常，协程内部也可以捕获这个异常，处理终止请求。</li>
</ul>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Python3</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 离线安装 MySQL</title>
    <url>/2018/09/06/centos-install-mysql/</url>
    <content><![CDATA[<p>记录一下 CentOS 离线安装 MySQL 并配置多实列主从复制的过程，<br>如果有旧版 Mariadb，先卸载旧版 Mariadb。</p>
<a id="more"></a>

<!-- toc -->

<h2 id="卸载系统自带的-Mariadb"><a href="#卸载系统自带的-Mariadb" class="headerlink" title="卸载系统自带的 Mariadb"></a>卸载系统自带的 Mariadb</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">rpm -qa|grep mariadb        <span class="comment"># 查询出已安装的 mariadb</span></span><br><span class="line">rpm -e --nodeps filename    <span class="comment"># 上面列出的所有文件</span></span><br><span class="line">rm -f /etc/my.cnf           <span class="comment"># 删除配置文件</span></span><br></pre></td></tr></table></figure>

<h2 id="创建-mysql-用户组"><a href="#创建-mysql-用户组" class="headerlink" title="创建 mysql 用户组"></a>创建 mysql 用户组</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">groupadd mysql</span><br><span class="line">useradd -g mysql mysql</span><br></pre></td></tr></table></figure>

<h2 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz</span><br></pre></td></tr></table></figure>

<h2 id="解压文件到目录-usr-local"><a href="#解压文件到目录-usr-local" class="headerlink" title="解压文件到目录 /usr/local"></a>解压文件到目录 /usr/local</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cp mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz /usr/<span class="built_in">local</span>/mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># xz 结尾的是经过两层压缩的压缩包</span></span><br><span class="line"><span class="comment"># 先解压 xz</span></span><br><span class="line">xz -d your_file_name.tar.xz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再解压 tar</span></span><br><span class="line">tar -xvf your_file_name.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接解压</span></span><br><span class="line">tar xvJf your_file_name.tar.xz</span><br><span class="line"></span><br><span class="line">tar xvJf mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line">mv mysql-8.0.12-linux-glibc2.12-x86_64 mysql</span><br></pre></td></tr></table></figure>

<h2 id="配置-etc-my-cnf"><a href="#配置-etc-my-cnf" class="headerlink" title="配置 /etc/my.cnf"></a>配置 /etc/my.cnf</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[mysqld_multi]</span><br><span class="line">mysqld     = /usr/<span class="built_in">local</span>/mysql/bin/mysqld_safe</span><br><span class="line">mysqladmin = /usr/<span class="built_in">local</span>/mysql/bin/mysqladmin</span><br><span class="line">user       = root</span><br><span class="line"></span><br><span class="line"><span class="comment"># The MySQL server</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line">[mysqld1]</span><br><span class="line">port                =33306</span><br><span class="line">datadir             =/data/mysqldata/data1</span><br><span class="line">socket              =/var/lib/mysql/mysql1.sock</span><br><span class="line">pid-file            =/var/lib/mysql/mysql1.pid</span><br><span class="line">user                =mysql</span><br><span class="line">server_id           =33306</span><br><span class="line">log_bin             =/data/mysqldata/data1/mysql-bin</span><br><span class="line">log_bin_index       =/data/mysqldata/data1/mysql-bin.index</span><br><span class="line">expire_logs_days    =10  <span class="comment"># 按需设置过期时间，表示保留最近10天的日志</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line">[mysqld2]</span><br><span class="line">port                =33307</span><br><span class="line">datadir             =/data/mysqldata/data2</span><br><span class="line">socket              =/var/lib/mysql/mysql2.sock</span><br><span class="line">pid-file            =/var/lib/mysql/mysql2.pid</span><br><span class="line">user                =mysql</span><br><span class="line">server_id           =33307</span><br><span class="line">log_bin             =/data/mysqldata/data2/mysql-bin</span><br><span class="line">log_bin_index       =/data/mysqldata/data2/mysql-bin.index</span><br><span class="line">expire_logs_days    =10  <span class="comment"># 按需设置过期时间，表示保留最近10天的日志</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br></pre></td></tr></table></figure>

<h2 id="初始化数据目录"><a href="#初始化数据目录" class="headerlink" title="初始化数据目录"></a>初始化数据目录</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir /var/lib/mysql</span><br><span class="line">chown -R mysql:mysql /var/lib/mysql</span><br><span class="line"></span><br><span class="line">mkdir /data/mysqldata</span><br><span class="line">chown -R mysql:mysql /data/mysqldata</span><br><span class="line"></span><br><span class="line">mkdir /data/mysqldata/data1</span><br><span class="line">chown -R mysql:mysql /data/mysqldata/data1</span><br><span class="line"></span><br><span class="line">mkdir /data/mysqldata/data2</span><br><span class="line">chown -R mysql:mysql /data/mysqldata/data2</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mysql/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这种初始化数据库目录的方式过时了</span></span><br><span class="line">./mysql_install_db --basedir=/usr/<span class="built_in">local</span>/mysql --datadir=/data/mysqldata/data1 --user=mysql</span><br><span class="line">./mysql_install_db --basedir=/usr/<span class="built_in">local</span>/mysql --datadir=/data/mysqldata/data2 --user=mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新的初始化数据库目录方式，会在终端打印一个临时登入密码。</span></span><br><span class="line">./mysqld --initialize --basedir=/usr/<span class="built_in">local</span>/mysql --datadir=/data/mysqldata/data1 --user=mysql --console</span><br><span class="line">./mysqld --initialize --basedir=/usr/<span class="built_in">local</span>/mysql --datadir=/data/mysqldata/data2 --user=mysql --console</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="启动实例"><a href="#启动实例" class="headerlink" title="启动实例"></a>启动实例</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/mysql/bin</span><br><span class="line">mysqld_multi start 1</span><br><span class="line">mysqld_multi start 2</span><br><span class="line">mysqld_multi report</span><br></pre></td></tr></table></figure>

<h2 id="主库创建同步账号"><a href="#主库创建同步账号" class="headerlink" title="主库创建同步账号"></a>主库创建同步账号</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 用刚才初始化数据库目录生成的临时密码登入</span></span><br><span class="line">./mysql -S /var/lib/mysql/mysql1.sock -p your-password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果忘记密码，可以在 my.cnf 的 mysqld 块中添加一行 skip-grant-tables = 1</span></span><br><span class="line"><span class="comment"># 可以进行无密码登入，修改成功之后去掉这一行然后重启数据库。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 root 密码</span></span><br><span class="line">USE mysql;</span><br><span class="line">UPDATE user SET authentication_string = PASSWORD(<span class="string">&#x27;new-password&#x27;</span>), password_expired = <span class="string">&#x27;N&#x27;</span>, password_last_changed = NOW() WHERE user = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权账户使得局域网内的机器可以访问数据库</span></span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;new-password&#x27;</span> WITH GRANT OPTION;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个同步账户</span></span><br><span class="line">CREATE USER <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;repl-password&#x27;</span>;</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">SHOW MASTER STATUS;</span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果忘记设置日志过期时间，可以进入数据库进行全局设置，并手动清理过期日志</span></span><br><span class="line"><span class="comment"># 不要在数据库目录进行删除日志，这样会使得数据库日志索引不一致，导致自动清理失效</span></span><br><span class="line">SET GLOBAL EXPIRE_LOGS_DAYS = 10;</span><br><span class="line">FLUSH LOGS;  <span class="comment"># 触发日志清理，一般是在有新的日志生成的时候触发检查一次。</span></span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以手动删除某个日志之前的所有日志</span></span><br><span class="line">PURGE BINARY LOGS TO <span class="string">&#x27;mysql-bin.000080&#x27;</span>;  <span class="comment"># 删除 80 之前的日志</span></span><br><span class="line">SHOW BINARY LOGS;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改从库的配置文件</span></span><br><span class="line">server-id          =2</span><br><span class="line">relay-log          =/dbdata/data/relay-log</span><br><span class="line">relay-log-index    =/dbdata/data/relay-log.index</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入数据库执行</span></span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">MASTER_HOST=‘master_host_name’, <span class="comment"># 主库的主机名</span></span><br><span class="line">MASTER_PORT=port_number <span class="comment"># 主库的端口号</span></span><br><span class="line">MASTER_USER=‘replication_user_name’, <span class="comment"># 复制的数据库用户名</span></span><br><span class="line">MASTER_PASSWORD=‘replication_password’, <span class="comment"># 复制的用户密码</span></span><br><span class="line">MASTER_LOG_FILE=‘recorded_log_file_name’, <span class="comment"># 主库的日志文件名</span></span><br><span class="line">MASTER_LOG_POS=recorded_log_position; <span class="comment"># 主库的日志文件位置</span></span><br><span class="line"></span><br><span class="line">start slave;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>CentOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos 安装 PhantomJS</title>
    <url>/2018/11/21/centos-install-phantomjs/</url>
    <content><![CDATA[<p>PhantomJS 已经不再开发了，Seleniumn 也警告使用 PhantomJS 是过时的，推荐使用 headless 版的 Chrome 或者 Firefox，但是有时候需要用到，够用就行，而且在 Linux 下安装也相对简单。</p>
<a id="more"></a>

<!-- toc -->

<h2 id="安装-fontconfig-依赖"><a href="#安装-fontconfig-依赖" class="headerlink" title="安装 fontconfig 依赖"></a>安装 fontconfig 依赖</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install -y fontconfig freetype freetype-devel fontconfig-devel libstdc++</span><br></pre></td></tr></table></figure>

<h2 id="下载-PhantomJS-并解压"><a href="#下载-PhantomJS-并解压" class="headerlink" title="下载 PhantomJS 并解压"></a>下载 PhantomJS 并解压</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装到此目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar -jxvf phantomjs-2.1.1-linux-x86_64.tar.bz2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名</span></span><br><span class="line">mv phantomjs-2.1.1-linux-x86_64 phantomjs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加软链接</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/phantomjs/bin/phantomjs /usr/bin/phantomjs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">phantomjs --version</span><br></pre></td></tr></table></figure>

<h2 id="用-Sselenium-驱动-PhantomJS"><a href="#用-Sselenium-驱动-PhantomJS" class="headerlink" title="用 Sselenium 驱动 PhantomJS"></a>用 Sselenium 驱动 PhantomJS</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.desired_capabilities <span class="keyword">import</span> DesiredCapabilities</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改浏览器头</span></span><br><span class="line">dcap = <span class="built_in">dict</span>(DesiredCapabilities.PHANTOMJS)</span><br><span class="line">dcap[<span class="string">&quot;phantomjs.page.settings.userAgent&quot;</span>] = <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36&quot;</span></span><br><span class="line">driver = webdriver.PhantomJS(desired_capabilities=dcap)</span><br><span class="line">driver.set_page_load_timeout(<span class="number">10</span>)</span><br><span class="line">driver.set_script_timeout(<span class="number">10</span>)</span><br><span class="line">driver.get(<span class="string">&quot;https://www.baidu.com&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="推荐使用的-Chrome-用法"><a href="#推荐使用的-Chrome-用法" class="headerlink" title="推荐使用的 Chrome 用法"></a>推荐使用的 Chrome 用法</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无界面浏览器</span></span><br><span class="line">options = Options()</span><br><span class="line">options.add_argument(<span class="string">&#x27;headless&#x27;</span>)</span><br><span class="line">options.add_argument(<span class="string">&#x27;disable-gpu&#x27;</span>)</span><br><span class="line">options.add_argument(<span class="string">&#x27;window-size=1200x600&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用 javascript</span></span><br><span class="line">prefs = &#123;<span class="string">&#x27;profile.managed_default_content_settings.javascript&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">options.add_experimental_option(<span class="string">&quot;prefs&quot;</span>, prefs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁止弹出式窗口</span></span><br><span class="line">prefs = &#123;<span class="string">&quot;profile.default_content_setting_values.notifications&quot;</span>: <span class="number">2</span>&#125;</span><br><span class="line">options.add_experimental_option(<span class="string">&quot;prefs&quot;</span>, prefs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用图片</span></span><br><span class="line">prefs = &#123;<span class="string">&#x27;profile.managed_default_content_settings.images&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">options.add_experimental_option(<span class="string">&quot;prefs&quot;</span>, prefs)</span><br><span class="line"></span><br><span class="line">driver = webdriver.Chrome(chrome_options=options)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行JS</span></span><br><span class="line">driver.execute_script(<span class="string">&#x27;window.scrollTo(0, 0)&#x27;</span>)  <span class="comment"># scroll to top</span></span><br><span class="line">driver.execute_script(<span class="string">&#x27;window.scrollTo(0, document.body.scrollHeight)&#x27;</span>)  <span class="comment"># end</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Python3</tag>
        <tag>CentOS</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 编译安装 Python3</title>
    <url>/2018/03/12/centos-install-python3/</url>
    <content><![CDATA[<p>记录一下 CentOS 编译安装 Python3 的过程。</p>
<a id="more"></a>

<!-- toc -->

<h2 id="安装系统相关依赖"><a href="#安装系统相关依赖" class="headerlink" title="安装系统相关依赖"></a>安装系统相关依赖</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install -y zlib-devel bzip2 bzip2-devel readline-devel sqlite sqlite-devel openssl-static openssl-devel xz xz-devel libffi-devel findutils gcc wget</span><br></pre></td></tr></table></figure>

<h2 id="下载-python3-包"><a href="#下载-python3-包" class="headerlink" title="下载 python3 包"></a>下载 python3 包</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://www.python.org/ftp/python/3.6.9/Python-3.6.10.tgz</span><br></pre></td></tr></table></figure>

<h2 id="解压到当前目录"><a href="#解压到当前目录" class="headerlink" title="解压到当前目录"></a>解压到当前目录</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar -zxvf Python-3.6.10.tgz</span><br></pre></td></tr></table></figure>

<h2 id="进入生成的目录进行配置"><a href="#进入生成的目录进行配置" class="headerlink" title="进入生成的目录进行配置"></a>进入生成的目录进行配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/python3 --enable-loadable-sqlite-extensions --enable-optimizations</span><br></pre></td></tr></table></figure>

<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="添加软连接"><a href="#添加软连接" class="headerlink" title="添加软连接"></a>添加软连接</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/python3/bin/python3 /usr/bin/python3</span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><code>yum</code> 搜索可用包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum search python3 | grep devel</span><br></pre></td></tr></table></figure>

<p>一键更新 <code>python</code> 包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip list --outdated --format=freeze | grep -v <span class="string">&#x27;^\-e&#x27;</span> | cut -d = -f 1  | xargs -n1 pip install -U</span><br></pre></td></tr></table></figure>

<p>切换豆瓣源</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 编辑 .pip/pip.conf 添加如下内容</span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line">index-url = https://pypi.douban.com/simple</span><br><span class="line">trusted-host = pypi.douban.com</span><br><span class="line"></span><br><span class="line">[list]</span><br><span class="line">format = columns</span><br></pre></td></tr></table></figure>

<p>离线安装python包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 离线安装，指定寻找包的目录为 packages</span></span><br><span class="line">python3 -m pip install --no-index --find-links=packages -r requirements.txt</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Python3</tag>
        <tag>CentOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 处理 Csv 文件常见错误</title>
    <url>/2018/12/03/csv-error/</url>
    <content><![CDATA[<p>在用 Python 处理 csv 文件时遇到2个错误，记录下处理方法。</p>
<a id="more"></a>

<!-- toc -->

<h2 id="字段包含-NULL-值"><a href="#字段包含-NULL-值" class="headerlink" title="字段包含 NULL 值"></a>字段包含 NULL 值</h2><p>csv 文件中字段包含 NULL 值会出错，解决方法是读取文件时把 NULL 值替换为空字符串。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;test.csv&#x27;</span>, <span class="string">&#x27;rt&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    fc = csv.DictReader((line.replace(<span class="string">&#x27;\0&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> line <span class="keyword">in</span> f))</span><br><span class="line">    <span class="comment"># do something with fc</span></span><br></pre></td></tr></table></figure>

<h2 id="OverflowError-and-maxInt"><a href="#OverflowError-and-maxInt" class="headerlink" title="OverflowError and maxInt"></a>OverflowError and maxInt</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">maxInt = sys.maxsize</span><br><span class="line">decrement = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> decrement:</span><br><span class="line">    <span class="comment"># decrease the maxInt value by factor 10</span></span><br><span class="line">    <span class="comment"># as long as the OverflowError occurs.</span></span><br><span class="line"></span><br><span class="line">    decrement = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        csv.field_size_limit(maxInt)</span><br><span class="line">    <span class="keyword">except</span> OverflowError:</span><br><span class="line">        maxInt = <span class="built_in">int</span>(maxInt / <span class="number">10</span>)</span><br><span class="line">        decrement = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;test.csv&#x27;</span>, <span class="string">&#x27;rt&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    fc = csv.DictReader(f)</span><br><span class="line">    <span class="comment"># do something with fc</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Python3</tag>
      </tags>
  </entry>
  <entry>
    <title>几种启动 Flask 应用的方式</title>
    <url>/2018/03/12/flask-start-up/</url>
    <content><![CDATA[<p>记录几种启动 Flask 应用的方式</p>
<a id="more"></a>

<!-- toc -->

<p>首先写一个简单的 <code>index.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello, world!&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="最简单的启动方式"><a href="#最简单的启动方式" class="headerlink" title="最简单的启动方式"></a>最简单的启动方式</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>这只能用于开发模式，可以设置<code>debug=True</code>开启调试模式，并且这是单线程同步的。</p>
<h2 id="用-tornado-驱动-flask"><a href="#用-tornado-驱动-flask" class="headerlink" title="用 tornado 驱动 flask"></a>用 <code>tornado</code> 驱动 <code>flask</code></h2><p>写一个<code>server.py</code>，并将上面<code>index.py</code>中的启动代码去掉，终端运行<code>python server.py</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tornado.wsgi <span class="keyword">import</span> WSGIContainer</span><br><span class="line"><span class="keyword">from</span> tornado.httpserver <span class="keyword">import</span> HTTPServer</span><br><span class="line"><span class="keyword">from</span> tornado.ioloop <span class="keyword">import</span> IOLoop</span><br><span class="line"><span class="keyword">from</span> index <span class="keyword">import</span> app</span><br><span class="line">http_server = HTTPServer(WSGIContainer(app))</span><br><span class="line">http_server.listen(<span class="number">5000</span>)  <span class="comment"># flask默认的端口</span></span><br><span class="line">IOLoop.instance().start()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这也是同步的，同一时间只能处理一个请求，可以写个简单的接口测试一下。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello, world!&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        print(n)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用postman同时发起5个请求，后台按顺序打印0-9，5个请求是一个一个执行的。</p>
<h2 id="用-twisted-驱动-flask"><a href="#用-twisted-驱动-flask" class="headerlink" title="用 twisted 驱动 flask"></a>用 <code>twisted</code> 驱动 <code>flask</code></h2><p>这个可以同时处理多个请求。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello, world!&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        print(n)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    reactor_args = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_twisted_wsgi</span>():</span></span><br><span class="line">        <span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor</span><br><span class="line">        <span class="keyword">from</span> twisted.web.server <span class="keyword">import</span> Site</span><br><span class="line">        <span class="keyword">from</span> twisted.web.wsgi <span class="keyword">import</span> WSGIResource</span><br><span class="line"></span><br><span class="line">        resource = WSGIResource(reactor, reactor.getThreadPool(), app)</span><br><span class="line">        site = Site(resource)</span><br><span class="line">        reactor.listenTCP(<span class="number">5000</span>, site)</span><br><span class="line">        reactor.run(**reactor_args)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> app.debug:</span><br><span class="line">        <span class="comment"># Disable twisted signal handlers in development only.</span></span><br><span class="line">        reactor_args[<span class="string">&#x27;installSignalHandlers&#x27;</span>] = <span class="number">0</span></span><br><span class="line">        <span class="comment"># Turn on auto reload.</span></span><br><span class="line">        <span class="keyword">import</span> werkzeug.serving</span><br><span class="line">        run_twisted_wsgi = werkzeug.serving.run_with_reloader(run_twisted_wsgi)</span><br><span class="line"></span><br><span class="line">    run_twisted_wsgi()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 通过 Thrift 操作 Hbase</title>
    <url>/2018/11/14/hbase-thrift/</url>
    <content><![CDATA[<!-- toc -->

<p>记录 Python 通过 Thrift 操作 Hbase 的通用操作方法。</p>
<a id="more"></a>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</span><br><span class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</span><br><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"><span class="keyword">from</span> hbase <span class="keyword">import</span> Hbase</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect to HBase Thrift server</span></span><br><span class="line">transport = TTransport.TBufferedTransport(TSocket.TSocket(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">9090</span>))</span><br><span class="line">protocol = TBinaryProtocol.TBinaryProtocolAccelerated(transport)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create and open the client connection</span></span><br><span class="line">client = Hbase.Client(protocol)</span><br><span class="line">transport.<span class="built_in">open</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect to Elasticsearch server</span></span><br><span class="line">es = Elasticsearch(<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">                   http_auth=(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>), port=<span class="string">&#x27;9200&#x27;</span>,</span><br><span class="line">                   timeout=<span class="number">30</span>, max_retries=<span class="number">10</span>, retry_on_timeout=<span class="literal">True</span></span><br><span class="line">                   )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch_one</span>(<span class="params">index, doc_type, body, size=<span class="number">1</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;查询es获取第一条匹配的数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">        index &#123;str&#125; -- 索引</span></span><br><span class="line"><span class="string">        doc_type &#123;str&#125; -- 类型</span></span><br><span class="line"><span class="string">        body &#123;dict&#125; -- 查询语句</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Keyword Arguments:</span></span><br><span class="line"><span class="string">        size &#123;int&#125; -- 返回数量 (default: &#123;1&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict -- 一条数据，没有结果返回 None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    res = es.search(index=index, doc_type=doc_type,</span><br><span class="line">                    scroll=<span class="string">&#x27;2m&#x27;</span>, body=body,</span><br><span class="line">                    size=size)</span><br><span class="line">    hits = res[<span class="string">&#x27;hits&#x27;</span>][<span class="string">&#x27;hits&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> hits[<span class="number">0</span>] <span class="keyword">if</span> hits <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch_all</span>(<span class="params">index, doc_type, body, size=<span class="number">100</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;查询es获取所有匹配的结果</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">        index &#123;str&#125; -- 索引</span></span><br><span class="line"><span class="string">        doc_type &#123;str&#125; -- 类型</span></span><br><span class="line"><span class="string">        body &#123;dict&#125; -- 查询语句</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Keyword Arguments:</span></span><br><span class="line"><span class="string">        size &#123;int&#125; -- 返回数量 (default: &#123;100&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        list -- 结果集</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    res = es.search(index=index, doc_type=doc_type,</span><br><span class="line">                    scroll=<span class="string">&#x27;2m&#x27;</span>, body=body,</span><br><span class="line">                    size=size)</span><br><span class="line">    <span class="keyword">return</span> res[<span class="string">&#x27;hits&#x27;</span>][<span class="string">&#x27;hits&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_term</span>(<span class="params">field, value</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;term</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">        field &#123;str&#125; -- 字段</span></span><br><span class="line"><span class="string">        value &#123;str&#125; -- 值</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict -- 查询语句</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    body = &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">                field: &#123;</span><br><span class="line">                    <span class="string">&quot;value&quot;</span>: value</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> body</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_terms</span>(<span class="params">field, values</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;terms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">        field &#123;str&#125; -- 字段</span></span><br><span class="line"><span class="string">        values &#123;list&#125; -- 列表</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict -- 查询语句</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    body = &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                field: values</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> body</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_row_with_columns</span>(<span class="params">table_name, rowkey, columns</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;根据 rowkey 从 hbase 获取一条数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">        table_name &#123;str&#125; -- 表名</span></span><br><span class="line"><span class="string">        rowkey &#123;str&#125; -- rowkey</span></span><br><span class="line"><span class="string">        attributes &#123;list&#125; -- 属性列表</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict -- 一条数据，没有则返回None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    table_name = table_name.encode()</span><br><span class="line">    rowkey = rowkey.encode()</span><br><span class="line">    columns = [(<span class="string">&#x27;0:&#x27;</span> + c).encode() <span class="keyword">for</span> c <span class="keyword">in</span> columns]</span><br><span class="line">    res = client.getRowWithColumns(table_name, rowkey, columns, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> res:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    d = &#123;</span><br><span class="line">        k.decode().split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">1</span>]: v.value.decode()</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> res[<span class="number">0</span>].columns.items()</span><br><span class="line">    &#125;</span><br><span class="line">    d[<span class="string">&#x27;rowkey&#x27;</span>] = res[<span class="number">0</span>].row.decode()</span><br><span class="line">    <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_rows_with_columns</span>(<span class="params">table_name, rowkeys, columns</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;根据 rowkeys 从 hbase 获取所有匹配的数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">        table_name &#123;str&#125; -- 表名</span></span><br><span class="line"><span class="string">        rowkeys &#123;list&#125; -- rowkey 列表</span></span><br><span class="line"><span class="string">        columns &#123;list&#125; -- 指定返回字段</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        list -- 数据结果集</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data = []</span><br><span class="line">    table_name = table_name.encode()</span><br><span class="line">    rowkeys = [k.encode() <span class="keyword">for</span> k <span class="keyword">in</span> rowkeys]</span><br><span class="line">    columns = [(<span class="string">&#x27;0:&#x27;</span> + c).encode() <span class="keyword">for</span> c <span class="keyword">in</span> columns]</span><br><span class="line">    res = client.getRowsWithColumns(table_name, rowkeys, columns, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">        d = &#123;</span><br><span class="line">            k.decode().split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">1</span>]: v.value.decode()</span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> r.columns.items()</span><br><span class="line">        &#125;</span><br><span class="line">        d[<span class="string">&#x27;rowkey&#x27;</span>] = r.row.decode()</span><br><span class="line">        data.append(d)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Python3</tag>
      </tags>
  </entry>
  <entry>
    <title>Postgresql Tutorial</title>
    <url>/2021/03/14/postgresql-tutorial/</url>
    <content><![CDATA[<p>psql 数据库名  –连接数据库<br>select rolname,rolpassword from pg_authid;–查看用户名密码<br>select usename,passwd from pg_shadow;–查看用户名密码<br>select version();    – 查看版本<br>select current_database();–查看当前数据库<br>\l                    –查看所有数据库<br>\dt                    –查看表<br>\password username    –修改密码<br>\password           –设置密码。<br>?                  –查看psql命令列表。<br>\c [database_name]  –连接其他数据库，切换数据库。<br>\conninfo           –列出当前数据库和连接的信息。<br>\d                  –列出当前数据库的所有表格。<br>\d [table_name]     –列出某一张表格的结构。<br>\du                 –列出所有用户。<br>\e                  –打开文本编辑器。<br>help                –帮助<br>\h                  –查看SQL命令的解释，比如\h select。<br>\q                    –退出</p>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 脚本自动重载</title>
    <url>/2018/03/09/python-reloader/</url>
    <content><![CDATA[<p>Django 和 Flask 应用开启 debug 模式之后都能检测代码的变化然后自动重载，于是去找实现代码，发现 Flask 是用的 werkzeug 库里面的功能，而 Django 的不好用于自己写的脚本，因为和 Django 应用结合了。</p>
<a id="more"></a>

<!-- toc -->

<p>下面是 werkzeug 中的 _reloader 模块中的 run_with_reloader 函数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_with_reloader</span>(<span class="params">main_func, extra_files=<span class="literal">None</span>, interval=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      reloader_type=<span class="string">&#x27;auto&#x27;</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run the given function in an independent python interpreter.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> signal</span><br><span class="line">    reloader = reloader_loops[reloader_type](extra_files, interval)</span><br><span class="line">    signal.signal(signal.SIGTERM, <span class="keyword">lambda</span> *args: sys.exit(<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> os.environ.get(<span class="string">&#x27;WERKZEUG_RUN_MAIN&#x27;</span>) == <span class="string">&#x27;true&#x27;</span>:</span><br><span class="line">            t = threading.Thread(target=main_func, args=())</span><br><span class="line">            t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">            t.start()</span><br><span class="line">            reloader.run()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sys.exit(reloader.restart_with_reloader())</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用法如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        print(<span class="string">&quot;hello, world!&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    run_with_reloader(main)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是执行函数不能传参，修改 run_with_reloader 如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_with_reloader</span>(<span class="params">main_func, args=(<span class="params"></span>), kwargs=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      extra_files=<span class="literal">None</span>, interval=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      reloader_type=<span class="string">&#x27;auto&#x27;</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run the given function in an independent python interpreter.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="keyword">import</span> signal</span><br><span class="line">    <span class="keyword">import</span> threading</span><br><span class="line">    <span class="keyword">from</span> werkzeug._reloader <span class="keyword">import</span> reloader_loops</span><br><span class="line">    reloader = reloader_loops[reloader_type](extra_files, interval)</span><br><span class="line">    signal.signal(signal.SIGTERM, <span class="keyword">lambda</span> *args: sys.exit(<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> os.environ.get(<span class="string">&#x27;WERKZEUG_RUN_MAIN&#x27;</span>) == <span class="string">&#x27;true&#x27;</span>:</span><br><span class="line">            t = threading.Thread(target=main_func, args=args, kwargs=kwargs)</span><br><span class="line">            t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">            t.start()</span><br><span class="line">            reloader.run()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sys.exit(reloader.restart_with_reloader())</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后就能传参了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">name, age</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        print(<span class="string">&quot;hello, &quot;</span>, name, <span class="string">&#x27;!&#x27;</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        print(age)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    run_with_reloader(main, args=(<span class="string">&#x27;foo&#x27;</span>, <span class="number">20</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Python3</tag>
      </tags>
  </entry>
  <entry>
    <title>RDS for MySQL 备份文件恢复到自建数据库</title>
    <url>/2018/09/13/rds-for-mysql/</url>
    <content><![CDATA[<p>云数据库MySQL版使用开源软件Percona Xtrabackup对数据库进行备份，所以您可以使用该软件将云数据库MySQL的备份文件恢复到自建数据库中，本文将介绍详细的操作步骤。</p>
<a id="more"></a>

<!-- toc -->

<h2 id="软件说明"><a href="#软件说明" class="headerlink" title="软件说明"></a>软件说明</h2><ol>
<li>MySQL 5.6.41</li>
<li>Percona XtraBackup 2.2.9</li>
<li><a href="http://oss.aliyuncs.com/aliyunecs/rds_backup_extract.sh?spm=a2c4g.11186623.2.6.3f4d5cf8Ze2ycZ&file=rds_backup_extract.sh">rds_backup_extract.sh</a></li>
</ol>
<h2 id="解压数据库备份文件"><a href="#解压数据库备份文件" class="headerlink" title="解压数据库备份文件"></a>解压数据库备份文件</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">unzip -P密码 mysql_data_backup.tar.gz.zip</span><br><span class="line">bash rds_backup_extract -f mysql_data_backup.tar.gz -C /data/mysql/data</span><br></pre></td></tr></table></figure>

<h2 id="修改配置文件-backup-my-cnf-如下"><a href="#修改配置文件-backup-my-cnf-如下" class="headerlink" title="修改配置文件 backup-my.cnf 如下"></a>修改配置文件 backup-my.cnf 如下</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This MySQL options file was generated by innobackupex.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The MySQL server</span></span><br><span class="line">[mysqld]</span><br><span class="line">innodb_checksum_algorithm=innodb</span><br><span class="line"><span class="comment"># innodb_log_checksum_algorithm=innodb</span></span><br><span class="line">innodb_data_file_path=ibdata1:200M:autoextend</span><br><span class="line">innodb_log_files_in_group=2</span><br><span class="line">innodb_log_file_size=1572864000</span><br><span class="line"><span class="comment"># innodb_fast_checksum=false</span></span><br><span class="line"><span class="comment"># innodb_page_size=16384</span></span><br><span class="line"><span class="comment"># innodb_log_block_size=512</span></span><br><span class="line">innodb_undo_directory=.</span><br><span class="line">innodb_undo_tablespaces=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># rds_encrypt_data=false</span></span><br><span class="line"><span class="comment"># innodb_encrypt_algorithm=aes_128_ecb</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="修改文件属主"><a href="#修改文件属主" class="headerlink" title="修改文件属主"></a>修改文件属主</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">chown -R mysql:mysql /data/mysql/data</span><br></pre></td></tr></table></figure>

<h2 id="恢复数据文件"><a href="#恢复数据文件" class="headerlink" title="恢复数据文件"></a>恢复数据文件</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">chmod 400 /data/mysql/data/backup-my.cnf</span><br><span class="line">innobackupex --defaults-file=/data/mysql/data/backup-my.cnf --apply-log /data/mysql/data</span><br></pre></td></tr></table></figure>

<h2 id="启动数据库并登入验证"><a href="#启动数据库并登入验证" class="headerlink" title="启动数据库并登入验证"></a>启动数据库并登入验证</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mysqld_safe --defaults-file=/data/mysql/data/backup-my.cnf --user=mysql --datadir=/data/mysql/data --skip-grant-tables &amp;</span><br></pre></td></tr></table></figure>

<h2 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h2><p>恢复完成后，表 mysql.user 中是不包含 RDS 中创建的用户，需要新建，新建用户前请执行如下 SQL：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> mysql.db <span class="keyword">where</span> <span class="keyword">user</span>&lt;&gt;<span class="string">&#x27;root&#x27;</span> <span class="keyword">and</span> <span class="keyword">char_length</span>(<span class="keyword">user</span>)&gt;<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> mysql.tables_priv <span class="keyword">where</span> <span class="keyword">user</span>&lt;&gt;<span class="string">&#x27;root&#x27;</span> <span class="keyword">and</span> <span class="keyword">char_length</span>(<span class="keyword">user</span>)&gt;<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://help.aliyun.com/knowledge_detail/41817.html">阿里云数据备份/恢复</a></p>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>CentOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Screen 使用教程</title>
    <url>/2018/03/13/screen-usage/</url>
    <content><![CDATA[<p>GNU Screen是一款由GNU计划开发的用于命令行终端切换的自由软件。用户可以通过该软件同时连接多个本地或远程的命令行会话，并在其间自由切换。</p>
<a id="more"></a>

<!-- toc -->

<h2 id="安装-screen"><a href="#安装-screen" class="headerlink" title="安装 screen"></a>安装 screen</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install -y screen</span><br></pre></td></tr></table></figure>

<h2 id="screen-常用命令"><a href="#screen-常用命令" class="headerlink" title="screen 常用命令"></a>screen 常用命令</h2><p>新建一个Screen Session</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">screen -S session_name</span><br></pre></td></tr></table></figure>

<p>将当前Screen Session放到后台</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">CTRL + A + D</span><br></pre></td></tr></table></figure>

<p>唤起一个Screen Session</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">screen -r session_name</span><br></pre></td></tr></table></figure>

<p>分享一个Screen Session</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">screen -x session_name</span><br></pre></td></tr></table></figure>

<p>终止一个Screen Session</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br><span class="line">or</span><br><span class="line">CTRL + D</span><br></pre></td></tr></table></figure>

<p>默认显示一屏的内容，要查看之前内容，如下操作：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Ctrl + A ESC</span><br></pre></td></tr></table></figure>

<p>列表所有的会话</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">screen -ls</span><br></pre></td></tr></table></figure>

<p>进入某个会话</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">screen -r session_name</span><br></pre></td></tr></table></figure>

<p>如果进不去，则</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">screen -d session_name</span><br></pre></td></tr></table></figure>

<p>再</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">screen -r session_name</span><br></pre></td></tr></table></figure>

<p><code>ctrl + A + N</code> 切换窗口</p>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>CentOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Selenium 在 Ubuntu 服务器上的使用</title>
    <url>/2018/08/13/selenium-linux/</url>
    <content><![CDATA[<h2 id="安装-chrome"><a href="#安装-chrome" class="headerlink" title="安装 chrome"></a>安装 chrome</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main&#x27;</span> | sudo tee /etc/apt/sources.list.d/google-chrome.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install google-chrome-stable</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<!-- toc -->

<h2 id="安装-chromedriver"><a href="#安装-chromedriver" class="headerlink" title="安装 chromedriver"></a>安装 chromedriver</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget -N https://chromedriver.storage.googleapis.com/2.41/chromedriver_linux64.zip</span><br><span class="line">unzip chromedriver_linux64.zip</span><br><span class="line">chmod +x chromedriver</span><br><span class="line">cp chromedriver /usr/bin/</span><br></pre></td></tr></table></figure>

<h2 id="安装-Xvfb"><a href="#安装-Xvfb" class="headerlink" title="安装 Xvfb"></a>安装 Xvfb</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt-get -y install xvfb gtk2-engines-pixbuf</span><br><span class="line">sudo apt-get -y install xfonts-cyrillic xfonts-100dpi xfonts-75dpi xfonts-base xfonts-scalable</span><br><span class="line"><span class="comment"># 截图功能，可选</span></span><br><span class="line">sudo apt-get -y install imagemagick x11-apps</span><br><span class="line">Xvfb -ac :99 -screen 0 1280x1024x16 &amp; <span class="built_in">export</span> DISPLAY=:99</span><br></pre></td></tr></table></figure>

<h2 id="测试脚本"><a href="#测试脚本" class="headerlink" title="测试脚本"></a>测试脚本</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--disable-gpu&#x27;</span>)</span><br><span class="line">driver = webdriver.Chrome(chrome_options=chrome_options,executable_path=<span class="string">&#x27;/usr/bin/chromedriver&#x27;</span>)</span><br><span class="line">driver.get(<span class="string">&quot;https://www.baidu.com&quot;</span>)</span><br><span class="line">print(driver.title)</span><br><span class="line">driver.quit()</span><br></pre></td></tr></table></figure>

<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p><code>ubuntu server 18.04</code> 虽然内置 <code>python3</code> 版本，但是没有 <code>pip</code><br>在 <code>/etc/apt/sources.list</code> 添加下列源</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">deb http://cn.archive.ubuntu.com/ubuntu bionic main multiverse restricted universe</span><br><span class="line">deb http://cn.archive.ubuntu.com/ubuntu bionic-updates main multiverse restricted universe</span><br><span class="line">deb http://cn.archive.ubuntu.com/ubuntu bionic-security main multiverse restricted universe</span><br><span class="line">deb http://cn.archive.ubuntu.com/ubuntu bionic-proposed main multiverse restricted universe</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install python3-pip</span><br></pre></td></tr></table></figure>

<h2 id="再用-pip-安装-selenium"><a href="#再用-pip-安装-selenium" class="headerlink" title="再用 pip 安装 selenium"></a>再用 pip 安装 selenium</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pip3 install selenium</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Python3</tag>
      </tags>
  </entry>
  <entry>
    <title>Session 、Cookie 和 JWT 详解</title>
    <url>/2021/04/17/session-cookie-jwt/</url>
    <content><![CDATA[<!-- toc -->

<h2 id="什么是-Cookie"><a href="#什么是-Cookie" class="headerlink" title="什么是 Cookie"></a>什么是 Cookie</h2><p>HTTP Cookie（也叫 Web Cookie 或浏览器 Cookie）是服务器发送到用户浏览器并保存在本地的一小块数据，它会在浏览器下次向同一服务器再发起请求时被携带并发送到服务器上。通常，它用于告知服务端两个请求是否来自同一浏览器，如保持用户的登录状态。Cookie 使基于无状态的HTTP协议记录稳定的状态信息成为了可能。</p>
<p>Cookie 主要用于以下三个方面：</p>
<ol>
<li>会话状态管理（如用户登录状态、购物车、游戏分数或其它需要记录的信息）</li>
<li>个性化设置（如用户自定义设置、主题等）</li>
<li>浏览器行为跟踪（如跟踪分析用户行为等）</li>
</ol>
<a id="more"></a>

<h2 id="什么是-Session"><a href="#什么是-Session" class="headerlink" title="什么是 Session"></a>什么是 Session</h2><p>Session 代表着服务器和客户端一次会话的过程。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当客户端关闭会话，或者 Session 超时失效时会话结束。</p>
<h2 id="Session-和-Cookie-的区别"><a href="#Session-和-Cookie-的区别" class="headerlink" title="Session 和 Cookie 的区别"></a>Session 和 Cookie 的区别</h2><ol>
<li>作用范围不同，Cookie 保存在客户端（浏览器），Session 保存在服务器端。</li>
<li>存取方式的不同，Cookie 只能保存 ASCII，Session 可以存任意数据类型，一般情况下我们可以在 Session 中保持一些常用变量信息，比如说 UserId 等。</li>
<li>有效期不同，Cookie 可设置为长时间保持，比如我们经常使用的默认登录功能，Session 一般失效时间较短，客户端关闭或者 Session 超时都会失效。</li>
<li>隐私策略不同，Cookie 存储在客户端，比较容易遭到不法获取，早期有人将用户的登录名和密码存储在 Cookie 中导致信息被窃取；Session 存储在服务端，安全性相对 Cookie 要好一些。</li>
<li>存储大小不同， 单个 Cookie 保存的数据不能超过 4K，Session 可存储数据远高于 Cookie。</li>
<li>Cookie 是客户端技术，Session 是服务端技术，Session 借助 Cookie 存储 sessionid。</li>
<li>如果浏览器禁用 Cookie，可以使用 POST 提交 sessionid 或者使用 JWT 技术。</li>
</ol>
<h2 id="分布式-Session"><a href="#分布式-Session" class="headerlink" title="分布式 Session"></a>分布式 Session</h2><p>在互联网公司为了可以支撑更大的流量，后端往往需要多台服务器共同来支撑前端用户请求，那如果用户在 A 服务器登录了，第二次请求跑到服务 B 就会出现登录失效问题。</p>
<p>分布式 Session 一般会有以下几种解决方案：</p>
<ol>
<li>Nginx ip_hash 策略，服务端使用 Nginx 代理，每个请求按访问 IP 的 hash 分配，这样来自同一 IP 固定访问一个后台服务器，避免了在服务器 A 创建 Session，第二次分发到服务器 B 的现象。</li>
<li>Session 复制，任何一个服务器上的 Session 发生改变（增删改），该节点会把这个 Session 的所有内容序列化，然后广播给所有其它节点。</li>
<li>共享 Session，服务端无状态话，将用户的 Session 等信息使用缓存中间件来统一管理，保障分发到每一个服务器的响应结果都一致。</li>
</ol>
<h2 id="跨域请求"><a href="#跨域请求" class="headerlink" title="跨域请求"></a>跨域请求</h2><p>同源策略/SOP（Same origin policy）是一种约定，由 Netscape 公司 1995年引入浏览器，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，浏览器很容易受到 XSS、CSFR 等攻击。所谓同源是指”协议+域名+端口”三者相同，即便两个不同的域名指向同一个 ip 地址，也非同源。</p>
<p>解决方案：</p>
<ol>
<li>Nginx 代理</li>
<li>Jsonp 跨域</li>
<li>JWT 认证</li>
</ol>
<h2 id="JWT-数据结构"><a href="#JWT-数据结构" class="headerlink" title="JWT 数据结构"></a>JWT 数据结构</h2><h3 id="Encoded"><a href="#Encoded" class="headerlink" title="Encoded"></a>Encoded</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure>

<h3 id="Decoded"><a href="#Decoded" class="headerlink" title="Decoded"></a>Decoded</h3><h4 id="Header-头部"><a href="#Header-头部" class="headerlink" title="Header (头部)"></a>Header (头部)</h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;kid&quot;</span>: <span class="string">&quot;Key ID&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cty&quot;</span>: <span class="string">&quot;Content Type&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;enc&quot;</span>: <span class="string">&quot;Encrypt Algorithm&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Payload-负载"><a href="#Payload-负载" class="headerlink" title="Payload (负载)"></a>Payload (负载)</h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;iss&quot;</span>: <span class="string">&quot;issuer(签发人)&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;exp&quot;</span>: <span class="string">&quot;expiration time(过期时间)&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sub&quot;</span>: <span class="string">&quot;subject(主题)&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;aud&quot;</span>: <span class="string">&quot;audience(受众)&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;nbf&quot;</span>: <span class="string">&quot;Not Before(生效时间)&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;iat&quot;</span>: <span class="string">&quot;Issued At(签发时间)&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;JWT ID(编号)&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Signature-签名"><a href="#Signature-签名" class="headerlink" title="Signature (签名)"></a>Signature (签名)</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + &quot;.&quot; +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line"></span><br><span class="line">your-256-bit-secret</span><br><span class="line"></span><br><span class="line">) secret base64 encoded</span><br></pre></td></tr></table></figure>

<p>JWT = Header.Payload.Signature</p>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>JWT</tag>
        <tag>Session</tag>
        <tag>Cookie</tag>
      </tags>
  </entry>
  <entry>
    <title>Instagram 的分片与 ID 设计</title>
    <url>/2020/06/03/sharding-ids-at-instagram/</url>
    <content><![CDATA[<!-- toc -->

<p>Instagram上有大量的数据，每分钟就有超过25张的图片和90个点赞。为了确保所有重要的数据都能被合理存储并且及时得被提取应用，我们对数据进行了分片（sharding）——也就是说，我们把数据放到多个桶（bucket）中，每个桶里都有一部分数据。</p>
<p>我们的应用服务器上运行的是Django， 后端数据库是PostgreSQL。对数据分片首先要决定是否要保留PostgreSQL作为主要的数据存储库，是否要采用其他的数据库。经过评估一些不同的数据库解决方案，我们最终确定最适合的方案是在PostgreSQL数据库集群上实现数据分片。</p>
<p>然而在把数据写到数据库之前，我们还要解决如何给数据（例如Instagram上发布的没一张图片）加上唯一标识符的问题。在单一数据库上的典型解法——使用数据库自带的自增主键功能——在当数据需要被同时插入到多个数据库时就不适用了。文章的下面就来讲讲我们是如何解决这个问题的</p>
<a id="more"></a>

<p>开始前，我们先列出系统所需要的所有重要的功能。</p>
<blockquote>
<ol>
<li>产生的数据ID需是可以按时间排序的。（比如对一列图片数据的ID进行排序，可以不需要提取太多图片本身的信息）</li>
<li>理想的ID是64位的。（这样索引更小，存储也更优，像Redis）</li>
<li>系统要尽量少的引用“可变动因素”——在很少工程师的情况下还可以扩张Instagram的很大一部分原因就是，我们相信简单易懂的方案。</li>
</ol>
</blockquote>
<h2 id="现有的解决方案"><a href="#现有的解决方案" class="headerlink" title="现有的解决方案"></a>现有的解决方案</h2><h3 id="由Web应用层生成ID"><a href="#由Web应用层生成ID" class="headerlink" title="由Web应用层生成ID"></a>由Web应用层生成ID</h3><p>这种方案将ID的生成完全交到应用层，而不是数据库。例如，MongoDB的ObjectId，就是12字节长并且在最前面加上时间戳进行编码。另一个流行的方案是使用UUIDs。</p>
<p>优点：</p>
<blockquote>
<ol>
<li>每个应用线程独立生成ID，最小的降低ID生成的失败和竞争。</li>
<li>如果用时间戳作为ID的起始部分，那么ID可以按时间排序。</li>
</ol>
</blockquote>
<p>缺点：</p>
<blockquote>
<ol>
<li>通常需要更多的存储空间（96位或者更多）来确保ID的合理唯一性。</li>
<li>一些UUID类型完全是随机的，无法排序。</li>
</ol>
</blockquote>
<h3 id="通过单独的服务产生ID"><a href="#通过单独的服务产生ID" class="headerlink" title="通过单独的服务产生ID"></a>通过单独的服务产生ID</h3><p>例如：Twitter的Snowflake，是一个Thrift服务，使用了Apache Zookeeper来协调各个结点并且产生64为的唯一ID。</p>
<p>优点：</p>
<blockquote>
<ol>
<li>Snowflake的ID只有64位，是UUID的一半。</li>
<li>可以放时间戳到ID头，从而可以按时间排序。</li>
<li>分布式系统保证了系统结点不会挂掉。</li>
</ol>
</blockquote>
<p>缺点：</p>
<blockquote>
<p>增加了复杂性，而且引入了更多的“可变动因素”（如ZooKeeper, Snowflake服务器）到系统构架中。</p>
</blockquote>
<h3 id="数据库票据（DB-Ticket）服务器"><a href="#数据库票据（DB-Ticket）服务器" class="headerlink" title="数据库票据（DB Ticket）服务器"></a>数据库票据（DB Ticket）服务器</h3><p>利用数据库自带的自增特性来确保唯一性。Flicker采用这一方法，不过还用了两台ticket数据库（一个生成偶数，一个生成奇数）来避免单点失败。</p>
<p>优点：</p>
<blockquote>
<p>数据库好理解，带有易预测的可扩张功能。</p>
</blockquote>
<p>缺点：</p>
<blockquote>
<ol>
<li>最终会出现数据写入的瓶颈（尽管Flicker称在高扩展下没有问题）。</li>
<li>需要管理多的两台服务器（或者EC2实例）。</li>
<li>如果单独使用数据库，会出现单点失效。如果使用多个数据库，则不能保证ID可以按时间排序。</li>
</ol>
</blockquote>
<p>在所有这些方案中，Twitter的snowflake是最接近的，但是生成ID所需的添加复杂性又和我们的目标冲突。我们的替换方案是采用概念上相近的方法，但是带到PostgreSQL内部实现。</p>
<h2 id="Instagram-的方案"><a href="#Instagram-的方案" class="headerlink" title="Instagram 的方案"></a>Instagram 的方案</h2><p>我们的分片系统是由上千个“逻辑”分片组成的，由代码映射到少量的物理分片。</p>
<p>通过这个方法，我们一开始用少数数据库实现，慢慢扩展到更多个数据库，只需要把部分逻辑分片从一台数据库转移到另一台数据库里，不需要重新把数据重新聚合。我们用到的PostgreSQL的schema的特性可以轻松的实现计划和管理。</p>
<p>Schema（不要和SQL单个表的schema搞混了）是PostgreSQL里的一个逻辑分组功能。每一个PostgreSQL数据库都有好几个schema，每一个schema都有一到多个表。表名在没个schema中都是唯一的，而不是每个数据库，默认情况下，PostgreSQL会把所有数据都放在一个叫“public”的schema中。</p>
<p>在我们的系统中每个“逻辑”分片都是一个PostgreSQL schema， 每个分片的表（比如照片的“点赞”功能）都存在每个schema中。</p>
<p>我们通过使用PL/PGSQL, PostgreSQL内部的编程语言，和PostgreSQL现有的自增功能来生成ID。</p>
<p>每个ID都由下面几个部分组成：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">41位的毫秒级时间（用于产生41年的ID）</span><br><span class="line">13位用来表示逻辑分片的ID</span><br><span class="line">10位的自增序列，模上1024， 意味着每个分片每毫秒可以产生1024个ID</span><br></pre></td></tr></table></figure>

<p>下面通过一个例子说明：比如说现在是2011年的九月九日，我们的纪元是从2011年的一月一号开始。从新纪元开始到此有1387263000毫秒，那么我们把这个数字左移41位来填满ID的头。</p>
<blockquote>
<p>id = 1387263000 &lt;&lt;(64 – 41)</p>
</blockquote>
<p>接下来， 我们拿来我们准备把这个数据插入的分片ID；如果我们用户ID是31341， 这个分片的ID是 31341%2000 → 1341。 我们接下来把下面13为填满：</p>
<blockquote>
<p>id |= 1341 &lt;&lt; (64-41-13)</p>
</blockquote>
<p>最后， 我们用所剩的自增序列（每个schema中每个表中这个序列都是唯一的）来填满的后面的位数。 假设这张表中已经有了5000个ID； 我们下一个数据就是5001，我们把它模上1024得到：</p>
<blockquote>
<p>id |= （5001%1024）</p>
</blockquote>
<p>我们就得到了我们的ID， 我们把这个id作为insert中的RETURNING返回给应用层。</p>
<p>下面是是实现以上过程的PL/PGSQL代码（这里用的schema是insta5）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> insta5.next_id(<span class="keyword">OUT</span> <span class="keyword">result</span> <span class="built_in">bigint</span>) <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    our_epoch <span class="built_in">bigint</span> := <span class="number">1314220021721</span>;</span><br><span class="line">    seq_id bigint;</span><br><span class="line">    now_millis bigint;</span><br><span class="line">    shard_id int := 5;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">nextval</span>(<span class="string">&#x27;insta5.table_id_seq&#x27;</span>) %% <span class="number">1024</span> <span class="keyword">INTO</span> seq_id;</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">FLOOR</span>(<span class="keyword">EXTRACT</span>(EPOCH <span class="keyword">FROM</span> clock_timestamp()) * <span class="number">1000</span>) <span class="keyword">INTO</span> now_millis;</span><br><span class="line">    result := (now_millis - our_epoch) &lt;&lt; 23;</span><br><span class="line">    result := result | (shard_id &lt;&lt; 10);</span><br><span class="line">    result := result | (seq_id);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ LANGUAGE PLPGSQL;</span><br></pre></td></tr></table></figure>

<p>要生成表示执行下面的部分：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> insta5.our_table(</span><br><span class="line">    <span class="string">&quot;id&quot;</span> <span class="built_in">bigint</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> insta5.next_id(),</span><br><span class="line">    ... rest <span class="keyword">of</span> <span class="keyword">table</span> <span class="keyword">schema</span> ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>成了！我们得到了应用中唯一的主键（还有一个好处是，ID中包含了分片ID可以用来轻松映射）。我们已经把这个方法用在产品中，并且对结果感到非常满意。</p>
<p>本文来自：<a href="https://juejin.im/post/58de0676da2f60005fbec568">Instagram 的分片与 ID 设计</a></p>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>Sqlalchemy 基本用法</title>
    <url>/2019/05/12/sqlalchemy-usage/</url>
    <content><![CDATA[<p>Sqlalchemy 基本用法</p>
<a id="more"></a>

<!-- toc -->

<h2 id="通用导入"><a href="#通用导入" class="headerlink" title="通用导入"></a>通用导入</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> scoped_session, sessionmaker</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, ForeignKey, Boolean</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&#x27;sqlite:///test.db&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line">db_session = scoped_session(sessionmaker(bind=engine))</span><br><span class="line">Base.query = db_session.query_property()</span><br></pre></td></tr></table></figure>

<h2 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    child_id = Column(Integer, ForeignKey(<span class="string">&#x27;child.id&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;child&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    parent = relationship(<span class="string">&#x27;Parent&#x27;</span>, backref=<span class="string">&#x27;child&#x27;</span>, uselist=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h2 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># the one side</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    <span class="comment"># children = relationship(&quot;Child&quot;, back_populates=&quot;parent&quot;)</span></span><br><span class="line">    children = relationship(<span class="string">&quot;Child&quot;</span>, backref=<span class="string">&quot;parent&quot;</span>, lazy=<span class="string">&quot;dynamic&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># the many side</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;child&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    parent_id = Column(Integer, ForeignKey(<span class="string">&#x27;parent.id&#x27;</span>))</span><br><span class="line">    <span class="comment"># parent = relationship(&quot;Parent&quot;, back_populates=&quot;children&quot;)</span></span><br><span class="line">    <span class="comment"># parent = relationship(&quot;Parent&quot;, backref=&quot;children&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="多对一"><a href="#多对一" class="headerlink" title="多对一"></a>多对一</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># the many side</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    child_id = Column(Integer, ForeignKey(<span class="string">&#x27;child.id&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># the one side</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;child&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    parents = relationship(<span class="string">&#x27;Parent&#x27;</span>, backref=<span class="string">&#x27;child&#x27;</span>, lazy=<span class="string">&#x27;dynamic&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Department</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;department&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    employees = relationship(</span><br><span class="line">        <span class="string">&#x27;Employee&#x27;</span>,</span><br><span class="line">        secondary=<span class="string">&#x27;department_employee_link&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;employee&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    hired_on = Column(</span><br><span class="line">        DateTime,</span><br><span class="line">        default=func.now())</span><br><span class="line">    departments = relationship(</span><br><span class="line">        <span class="string">&#x27;Department&#x27;</span>,</span><br><span class="line">        secondary=<span class="string">&#x27;department_employee_link&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DepartmentEmployeeLink</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;department_employee_link&#x27;</span></span><br><span class="line">    department_id = Column(Integer, ForeignKey(<span class="string">&#x27;department.id&#x27;</span>),</span><br><span class="line">                           primary_key=<span class="literal">True</span>)</span><br><span class="line">    department = relationship(<span class="string">&#x27;Department&#x27;</span>)</span><br><span class="line">    employee_id = Column(Integer, ForeignKey(<span class="string">&#x27;employee.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">    employee = relationship(<span class="string">&#x27;Employee&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="自身多对多"><a href="#自身多对多" class="headerlink" title="自身多对多"></a>自身多对多</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Follow</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;me_follow_you&#x27;</span></span><br><span class="line"></span><br><span class="line">    me_id = Column(Integer, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">    me = relationship(<span class="string">&#x27;User&#x27;</span>, foreign_keys=[me_id])</span><br><span class="line">    you_id = Column(Integer, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">    you = relationship(<span class="string">&#x27;User&#x27;</span>, foreign_keys=[you_id])</span><br><span class="line">    created = Column(DateTime(timezone=<span class="literal">True</span>), default=datetime.utcnow)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># stars=我关注的人 fans=我的粉丝</span></span><br><span class="line">    stars = relationship(<span class="string">&#x27;User&#x27;</span>,</span><br><span class="line">                         secondary=<span class="string">&#x27;me_follow_you&#x27;</span>,</span><br><span class="line">                         primaryjoin=<span class="string">&#x27;User.id==Follow.me_id&#x27;</span>,</span><br><span class="line">                         secondaryjoin=<span class="string">&#x27;User.id==Follow.you_id&#x27;</span>,</span><br><span class="line">                         backref=backref(<span class="string">&#x27;fans&#x27;</span>, lazy=<span class="string">&#x27;dynamic&#x27;</span>),</span><br><span class="line">                         lazy=<span class="string">&#x27;dynamic&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="自身一对一"><a href="#自身一对一" class="headerlink" title="自身一对一"></a>自身一对一</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    parent_id = Column(Integer, ForeignKey(<span class="string">&#x27;node.id&#x27;</span>))</span><br><span class="line">    data = Column(String(<span class="number">50</span>))</span><br><span class="line">    parent = relationship(<span class="string">&quot;Node&quot;</span>, remote_side=[<span class="built_in">id</span>])</span><br></pre></td></tr></table></figure>

<h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span>():</span></span><br><span class="line">    <span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line">    engine = create_engine(<span class="string">&#x27;sqlite:///test.db&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">    Base.metadata.create_all(engine)</span><br></pre></td></tr></table></figure>

<h2 id="backref-和-back-populates"><a href="#backref-和-back-populates" class="headerlink" title="backref 和 back_populates"></a>backref 和 back_populates</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Parent 下添加 `children = relationship(<span class="string">&quot;Child&quot;</span>, back_populates=<span class="string">&quot;parent&quot;</span>)`</span><br><span class="line"></span><br><span class="line">创建p1 = Parent()和c1 = Child()失败，原因是One <span class="keyword">or</span> more mappers failed to initialize，即back_populates必须在关系两端同时指定</span><br><span class="line"></span><br><span class="line">Parent下添加 `children = relationship(<span class="string">&quot;Child&quot;</span>, back_populates=<span class="string">&quot;parent&quot;</span>)`</span><br><span class="line">Child下添加 `parent = relationship(<span class="string">&quot;Parent&quot;</span>, back_populates=<span class="string">&quot;children&quot;</span>)`</span><br><span class="line"></span><br><span class="line">Parent Attribute:</span><br><span class="line">Parent.children Parent.<span class="built_in">id</span> Parent.metadata Parent.name Parent.query</span><br><span class="line"></span><br><span class="line">Child Attribute:</span><br><span class="line">Child.<span class="built_in">id</span> Child.metadata Child.name Child.parent Child.parent_id Child.query</span><br><span class="line"></span><br><span class="line">p1 = Parent()</span><br><span class="line">c1 = Child()</span><br><span class="line">c1.parent = p1 <span class="keyword">or</span> p1.children.append(c1)</span><br><span class="line"></span><br><span class="line">Parent下添加 `children = relationship(<span class="string">&quot;Child&quot;</span>, backref=<span class="string">&quot;parent&quot;</span>)`</span><br><span class="line"></span><br><span class="line">Parent Attribute:</span><br><span class="line">Parent.children Parent.<span class="built_in">id</span> Parent.metadata Parent.name Parent.query</span><br><span class="line"></span><br><span class="line">Child Attribute:</span><br><span class="line">Child.<span class="built_in">id</span> Child.metadata Child.name Child.parent_id Child.query</span><br><span class="line"></span><br><span class="line">p1 = Parent()</span><br><span class="line">c1 = Child()</span><br><span class="line">c1.parent = p1 <span class="keyword">or</span> p1.children.append(c1)</span><br><span class="line"></span><br><span class="line">可以看出使用backref时，实例化c1时会自动在c1对象上添加parent属性</span><br><span class="line"></span><br><span class="line">此后再检查:</span><br><span class="line"><span class="built_in">hasattr</span>(Child, <span class="string">&#x27;parent&#x27;</span>) // <span class="literal">True</span></span><br><span class="line"><span class="built_in">hasattr</span>(c1, <span class="string">&#x27;parent&#x27;</span>) // <span class="literal">True</span></span><br><span class="line"><span class="built_in">hasattr</span>(Parent, <span class="string">&#x27;children&#x27;</span>) // <span class="literal">True</span></span><br><span class="line"><span class="built_in">hasattr</span>(p1, <span class="string">&#x27;children&#x27;</span>) // <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">Child 下添加 `parent = relationship(<span class="string">&quot;Parent&quot;</span>, backref=<span class="string">&quot;children&quot;</span>)` 情况和 <span class="number">3</span> 相同</span><br><span class="line">Parent下添加 `children = relationship(<span class="string">&quot;Child&quot;</span>, backref=<span class="string">&quot;parent&quot;</span>)`</span><br><span class="line">Child下添加 `parent = relationship(<span class="string">&quot;Parent&quot;</span>, backref=<span class="string">&quot;children&quot;</span>)`</span><br><span class="line"></span><br><span class="line">创建p1 = Parent()和c1 = Child()失败，原因是One <span class="keyword">or</span> more mappers failed to initialize</span><br><span class="line">因此两者只能使用其中之一</span><br><span class="line"></span><br><span class="line">lazy 指定如何加载相关记录，默认值是<span class="string">&quot;select&quot;</span></span><br><span class="line">    select 首次访问时按需加载</span><br><span class="line">    immediate 源对象加载后就加载</span><br><span class="line">    joined 加载记录,但使用联结</span><br><span class="line">    subquery 立即加载,但使用子查询</span><br><span class="line">    noload 永不加载</span><br><span class="line">    dynamic 不加载记录,但提供加载记录的查询</span><br><span class="line"></span><br><span class="line">lazy = <span class="string">&quot;dynamic&quot;</span>只能用于collections，不立即查询出结果集，而是提供一系列结果集的方法，可以基于结果集再次进行更精确的查找</span><br></pre></td></tr></table></figure>

<h2 id="default-和-server-default"><a href="#default-和-server-default" class="headerlink" title="default 和 server_default"></a>default 和 server_default</h2><ol>
<li>default 是在 ORM 层设置默认值，server_default 是在表结构上设置默认值</li>
<li>onupdate 在 ORM 层生效，server_onupdate 在数据库生效，在 MySQL 上 ON UPDATE 是MySQL在背后创建了 trigger，而在 PostgreSQL 上你必须手动创建 trigger</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func, sql, text</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Record</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;records</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    id = Column(Integer, primary_key=True)</span></span><br><span class="line"><span class="string">    name = Column(String(64), server_default=text(&#x27;</span>name<span class="string">&#x27;))</span></span><br><span class="line"><span class="string">    created = Column(DateTime(timezone=True), default=datetime.utcnow)</span></span><br><span class="line"><span class="string">    # created = Column(DateTime(timezone=True), server_default=func.now())</span></span><br><span class="line"><span class="string">    # created = Column(DateTime(timezone=True), server_default=func.current_timestamp())</span></span><br><span class="line"><span class="string">    updated = Column(DateTime(timezone=True), server_default=func.current_timestamp(), onupdate=func.current_timestamp())</span></span><br><span class="line"><span class="string">    deleted = Column(Boolean, default=False)</span></span><br><span class="line"><span class="string">    # deleted = Column(Boolean, server_default=sql.expression.false())</span></span><br></pre></td></tr></table></figure>

<h2 id="为flask-sqlalchemy扩展BaseQuery方法"><a href="#为flask-sqlalchemy扩展BaseQuery方法" class="headerlink" title="为flask_sqlalchemy扩展BaseQuery方法"></a>为flask_sqlalchemy扩展BaseQuery方法</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy, BaseQuery</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomQuery</span>(<span class="params">BaseQuery</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">count_all</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.with_entities(func.count()).scalar()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(query_class=CustomQuery)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Sqlalchemy</tag>
      </tags>
  </entry>
  <entry>
    <title>Tmux 使用教程</title>
    <url>/2020/05/29/tmux-tutorial/</url>
    <content><![CDATA[<p>Tmux 是一个终端复用工具，和 screen 一样，screen 相对简单好使，tmux 更高级。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CentOS</span></span><br><span class="line">yum install -y tmux</span><br><span class="line"></span><br><span class="line"><span class="comment"># MacOS</span></span><br><span class="line">brew install tmux</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<!-- toc -->

<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 新建无名称会话</span></span><br><span class="line">tmux</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建会话</span></span><br><span class="line">tmux new -s demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂起会话</span></span><br><span class="line">tmux detach</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认进入第一个会话</span></span><br><span class="line">tmux a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入名为demo的会话</span></span><br><span class="line">tmux a -t demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭demo会话</span></span><br><span class="line">tmux kill-session -t demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭服务器</span></span><br><span class="line">tmux kill-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看会话</span></span><br><span class="line">tmux list-session</span><br><span class="line">tmux ls</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换会话</span></span><br><span class="line">tmux switch -t 0  <span class="comment"># 使用会话编号</span></span><br><span class="line">tmux switch -t demo  <span class="comment"># 使用会话名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名会话</span></span><br><span class="line">tmux rename-session -t demo new-demo</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="系统指令"><a href="#系统指令" class="headerlink" title="系统指令"></a>系统指令</h2><table>
<thead>
<tr>
<th><strong>前缀</strong></th>
<th><strong>指令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>prefix</td>
<td>?</td>
<td>显示快捷键帮助文档</td>
</tr>
<tr>
<td>prefix</td>
<td>d</td>
<td>断开当前会话</td>
</tr>
<tr>
<td>prefix</td>
<td>D</td>
<td>选择要断开的会话</td>
</tr>
<tr>
<td>prefix</td>
<td>Ctrl+z</td>
<td>挂起当前会话</td>
</tr>
<tr>
<td>prefix</td>
<td>r</td>
<td>强制重载当前会话</td>
</tr>
<tr>
<td>prefix</td>
<td>s</td>
<td>显示会话列表用于选择并切换</td>
</tr>
<tr>
<td>prefix</td>
<td>:</td>
<td>进入命令行模式</td>
</tr>
<tr>
<td>prefix</td>
<td>[</td>
<td>进入复制模式，按q退出</td>
</tr>
<tr>
<td>prefix</td>
<td>]</td>
<td>粘贴复制模式中复制的文本</td>
</tr>
<tr>
<td>prefix</td>
<td>~</td>
<td>列出提示信息缓存</td>
</tr>
</tbody></table>
<h2 id="窗口指令"><a href="#窗口指令" class="headerlink" title="窗口指令"></a>窗口指令</h2><table>
<thead>
<tr>
<th><strong>前缀</strong></th>
<th><strong>指令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>prefix</td>
<td>c</td>
<td>新建窗口</td>
</tr>
<tr>
<td>prefix</td>
<td>&amp;</td>
<td>关闭当前窗口（关闭前需输入y or n确认）</td>
</tr>
<tr>
<td>prefix</td>
<td>0-9</td>
<td>切换到指定窗口</td>
</tr>
<tr>
<td>prefix</td>
<td>p</td>
<td>切换到上一窗口</td>
</tr>
<tr>
<td>prefix</td>
<td>n</td>
<td>切换到下一窗口</td>
</tr>
<tr>
<td>prefix</td>
<td>w</td>
<td>打开窗口列表，用于且切换窗口</td>
</tr>
<tr>
<td>prefix</td>
<td>,</td>
<td>重命名当前窗口</td>
</tr>
<tr>
<td>prefix</td>
<td>.</td>
<td>修改当前窗口编号（适用于窗口重新排序）</td>
</tr>
<tr>
<td>prefix</td>
<td>f</td>
<td>快速定位到窗口（输入关键字匹配窗口名称）</td>
</tr>
</tbody></table>
<h2 id="面板指令"><a href="#面板指令" class="headerlink" title="面板指令"></a>面板指令</h2><table>
<thead>
<tr>
<th><strong>前缀</strong></th>
<th><strong>指令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>prefix</td>
<td>“</td>
<td>当前面板上下一分为二，下侧新建面板</td>
</tr>
<tr>
<td>prefix</td>
<td>%</td>
<td>当前面板左右一分为二，右侧新建面板</td>
</tr>
<tr>
<td>prefix</td>
<td>x</td>
<td>关闭当前面板（关闭前需输入y or n确认）</td>
</tr>
<tr>
<td>prefix</td>
<td>z</td>
<td>最大化当前面板，再重复一次按键后恢复正常（v1.8版本新增）</td>
</tr>
<tr>
<td>prefix</td>
<td>!</td>
<td>将当前面板移动到新的窗口打开（原窗口中存在两个及以上面板有效）</td>
</tr>
<tr>
<td>prefix</td>
<td>;</td>
<td>切换到最后一次使用的面板</td>
</tr>
<tr>
<td>prefix</td>
<td>q</td>
<td>显示面板编号，在编号消失前输入对应的数字可切换到相应的面板</td>
</tr>
<tr>
<td>prefix</td>
<td>{</td>
<td>向前置换当前面板</td>
</tr>
<tr>
<td>prefix</td>
<td>}</td>
<td>向后置换当前面板</td>
</tr>
<tr>
<td>prefix</td>
<td>Ctrl+o</td>
<td>顺时针旋转当前窗口中的所有面板</td>
</tr>
<tr>
<td>prefix</td>
<td>方向键</td>
<td>移动光标切换面板</td>
</tr>
<tr>
<td>prefix</td>
<td>o</td>
<td>选择下一面板</td>
</tr>
<tr>
<td>prefix</td>
<td>空格键</td>
<td>在自带的面板布局中循环切换</td>
</tr>
<tr>
<td>prefix</td>
<td>Alt+方向键</td>
<td>以5个单元格为单位调整当前面板边缘</td>
</tr>
<tr>
<td>prefix</td>
<td>Ctrl+方向键</td>
<td>以1个单元格为单位调整当前面板边缘（Mac下被系统快捷键覆盖）</td>
</tr>
<tr>
<td>prefix</td>
<td>t</td>
<td>显示时钟</td>
</tr>
</tbody></table>
<h2 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h2><p>编辑 ~/.tmux.conf 添加如下内容</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># prefix configuration</span><br><span class="line">set -g prefix C-a</span><br><span class="line">unbind C-b</span><br><span class="line">bind C-a send-prefix</span><br><span class="line"></span><br><span class="line"># split window</span><br><span class="line">unbind &#x27;&quot;&#x27;</span><br><span class="line">bind - split-window -v -c &#x27;#&#123;pane_current_path&#125;&#x27;</span><br><span class="line">unbind %</span><br><span class="line">bind = split-window -h -c &#x27;#&#123;pane_current_path&#125;&#x27;</span><br><span class="line"></span><br><span class="line"># mouse on</span><br><span class="line">set-option -g mouse on</span><br><span class="line"></span><br><span class="line"># pane navigation</span><br><span class="line">bind -r k select-pane -U</span><br><span class="line">bind -r j select-pane -D</span><br><span class="line">bind -r h select-pane -L</span><br><span class="line">bind -r l select-pane -R</span><br><span class="line"></span><br><span class="line"># pane resizing</span><br><span class="line">bind -r ^k resize-pane -U 2</span><br><span class="line">bind -r ^j resize-pane -D 2</span><br><span class="line">bind -r ^h resize-pane -L 2</span><br><span class="line">bind -r ^l resize-pane -R 2</span><br><span class="line"></span><br><span class="line"># reload configuration</span><br><span class="line">bind r source-file ~/.tmux.conf \; display &#x27;~/.tmux.conf sourced&#x27;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>CentOS</tag>
      </tags>
  </entry>
  <entry>
    <title>二叉树</title>
    <url>/2019/01/15/treenode/</url>
    <content><![CDATA[<p><code>LeetCode</code> 二叉树题解汇总</p>
<a id="more"></a>

<!-- toc -->

<h2 id="二叉树定义"><a href="#二叉树定义" class="headerlink" title="二叉树定义"></a>二叉树定义</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        self.val = x</span><br><span class="line">        self.left = <span class="literal">None</span></span><br><span class="line">        self.right = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h2 id="相同的树"><a href="#相同的树" class="headerlink" title="相同的树"></a>相同的树</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_same_tree</span>(<span class="params">p, q</span>):</span></span><br><span class="line">      <span class="keyword">if</span> p <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">not</span> q</span><br><span class="line">      <span class="keyword">if</span> q <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">not</span> p</span><br><span class="line">      <span class="keyword">return</span> p.val == q.val <span class="keyword">and</span> is_same_tree(p.left, q.left) <span class="keyword">and</span> is_same_tree(p.right, q.right)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="对称的树"><a href="#对称的树" class="headerlink" title="对称的树"></a>对称的树</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_symmetric</span>(<span class="params">root</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> symmetric(root.left, root.right)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">symmetric</span>(<span class="params">l1, l2</span>):</span></span><br><span class="line">    <span class="keyword">if</span> l1 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> l2</span><br><span class="line">    <span class="keyword">if</span> l2 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> l1</span><br><span class="line">    <span class="keyword">return</span> l1.val == l2.val <span class="keyword">and</span> symmetric(l1.left, l2.right) <span class="keyword">and</span> symmetric(l1.right, l2.left)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="层次遍历"><a href="#层次遍历" class="headerlink" title="层次遍历"></a>层次遍历</h2><p>给定一个二叉树，返回其按层次遍历的节点值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">node, level, res</span>):</span></span><br><span class="line">    <span class="keyword">if</span> node <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(res) &lt; level:</span><br><span class="line">        res.append([])</span><br><span class="line">    res[level - <span class="number">1</span>].append(node.val)</span><br><span class="line">    add(node.left, level + <span class="number">1</span>, res)</span><br><span class="line">    add(node.right, level + <span class="number">1</span>, res)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">level_order</span>(<span class="params">root</span>):</span></span><br><span class="line">    res = []</span><br><span class="line">    add(root, <span class="number">1</span>, res)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="最大深度"><a href="#最大深度" class="headerlink" title="最大深度"></a>最大深度</h2><p>给定一个二叉树，找出其最大深度。</p>
<p>二叉树的深度为根节点到最远叶子节点的最长路径上的节点数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">max_depth</span>(<span class="params">root</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + <span class="built_in">max</span>(<span class="built_in">map</span>(max_depth, (root.left, root.right))) <span class="keyword">if</span> root <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="最小深度"><a href="#最小深度" class="headerlink" title="最小深度"></a>最小深度</h2><p>给定一个二叉树，找出其最小深度。</p>
<p>最小深度是从根节点到最近叶子节点的最短路径上的节点数量。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">min_depth</span>(<span class="params">root</span>):</span></span><br><span class="line">    <span class="keyword">if</span> root <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> root.left <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> + min_depth(root.right)</span><br><span class="line">    <span class="keyword">if</span> root.right <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> + min_depth(root.left)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + <span class="built_in">min</span>(<span class="built_in">map</span>(min_depth, (root.left, root.right)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更简洁的写法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">min_depth</span>(<span class="params">root</span>):</span></span><br><span class="line">    <span class="keyword">if</span> root <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    depth_under_root = <span class="built_in">map</span>(min_depth, (root.left, root.right))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + (<span class="built_in">min</span>(depth_under_root) <span class="keyword">or</span> <span class="built_in">max</span>(depth_under_root))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="将有序数组转化为二叉树"><a href="#将有序数组转化为二叉树" class="headerlink" title="将有序数组转化为二叉树"></a>将有序数组转化为二叉树</h2><p>将一个按照升序排列的有序数组，转换为一棵高度平衡二叉搜索树。</p>
<p>高度平衡二叉树是指一个二叉树每个节点的左右两个子树的高度差的绝对值不超过1。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sorted_array_to_balanced_tree</span>(<span class="params">nums</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> nums:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    mid = <span class="built_in">len</span>(nums) // <span class="number">2</span></span><br><span class="line">    root = TreeNode(nums[mid])</span><br><span class="line">    root.left = sorted_array_to_balanced_tree(nums[:mid])</span><br><span class="line">    root.right = sorted_array_to_balanced_tree(nums[mid + <span class="number">1</span>:])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="平衡二叉树"><a href="#平衡二叉树" class="headerlink" title="平衡二叉树"></a>平衡二叉树</h2><p>一个二叉树每个节点的左右两个子树的高度差的绝对值不超过1。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hight</span>(<span class="params">node</span>):</span></span><br><span class="line">    <span class="keyword">if</span> node <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + <span class="built_in">max</span>(<span class="built_in">map</span>(hight, (node.left, node.right)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_balanced</span>(<span class="params">root</span>):</span></span><br><span class="line">    <span class="keyword">if</span> root <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(hight(root.left) - hight(root.right)) &lt;= <span class="number">1</span> <span class="keyword">and</span> is_balanced(root.left) <span class="keyword">and</span> is_balanced(root.right)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="路径总和"><a href="#路径总和" class="headerlink" title="路径总和"></a>路径总和</h2><p>给定一个二叉树和一个目标和，判断该树中是否存在根节点到叶子节点的路径，这条路径上所有节点值相加等于目标和。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">has_path_sum</span>(<span class="params">root, sums</span>):</span></span><br><span class="line">    <span class="keyword">if</span> root <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> root.left <span class="keyword">or</span> root.right:</span><br><span class="line">        <span class="keyword">return</span> has_path_sum(root.left, sums - root.val) <span class="keyword">or</span> has_path_sum(root.right, sums - root.val)</span><br><span class="line">    <span class="keyword">return</span> sums == root.val</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Python3</tag>
      </tags>
  </entry>
  <entry>
    <title>理解 Python 的关键字 Yield</title>
    <url>/2018/03/14/understand-yield/</url>
    <content><![CDATA[<p>为了理解什么是yield,你必须理解什么是生成器。</p>
<p>在理解生成器之前，让我们先走近迭代。</p>
<p>当你建立了一个列表，你可以逐项地读取这个列表，这叫做一个可迭代对象。</p>
<a id="more"></a>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mylist = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> mylist:</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>

<p>所有你可以使用for…in…语法的叫做一个迭代器，列表，字符串，文件等等，你经常使用它们是因为你可以如你所愿的读取其中的元素，但是你把所有的值都存储到了内存中，如果你有大量数据的话这个方式并不是你想要的。</p>
<p>生成器是可以迭代的，但是你只可以读取它一次，因为它并不把所有的值放在内存中，它是实时地生成数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mygenerator = (x * x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> mygenerator:</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>

<p>你不可以再次迭代生成器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">next</span>(mygenerator)</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    print(<span class="string">&quot;停止迭代&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>yield 是一个类似 return 的关键字，只是这个函数返回的是个生成器。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_generator</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">yield</span> i * i</span><br></pre></td></tr></table></figure>

<p>如果函数内部使用 return，则返回 0。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mygenerator = create_generator()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> mygenerator:</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>

<p>斐波拉契数列</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span>():</span></span><br><span class="line">    x, y = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x, y = y, x + y</span><br><span class="line">        <span class="keyword">yield</span> x</span><br></pre></td></tr></table></figure>

<p>获取斐波拉契数列前10个</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="built_in">list</span>(itertools.islice(fib(), <span class="number">10</span>))</span><br></pre></td></tr></table></figure>

<p>杨辉三角</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">triangle</span>():</span></span><br><span class="line">    a = [<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> a</span><br><span class="line">        a = [<span class="built_in">sum</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">zip</span>([<span class="number">0</span>] + a, a + [<span class="number">0</span>])]</span><br></pre></td></tr></table></figure>

<p>输出前10行杨辉三角</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line"><span class="built_in">list</span>(itertools.islice(triangle(), <span class="number">10</span>))</span><br></pre></td></tr></table></figure>

<p>控制迭代器的穷尽</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bank</span>():</span></span><br><span class="line">    crisis = <span class="literal">False</span>  <span class="comment"># crisis是危机的意思</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_atm</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.crisis:</span><br><span class="line">            <span class="keyword">yield</span> <span class="string">&quot;$100&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bank = Bank()  <span class="comment"># 创建一个银行</span></span><br><span class="line">corner_street_atm = bank.create_atm()  <span class="comment"># 创建一个ATM机</span></span><br><span class="line">print([<span class="built_in">next</span>(corner_street_atm) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)])</span><br><span class="line">bank.crisis = <span class="literal">True</span>  <span class="comment"># 危机来了</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    print(<span class="built_in">next</span>(corner_street_atm))</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    print(<span class="string">&quot;corner_street_atm: no more money!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    wall_street_atm = bank.create_atm()</span><br><span class="line">    print(<span class="built_in">next</span>(wall_street_atm))</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    print(<span class="string">&quot;wall_street_atm: no more money!&quot;</span>)</span><br><span class="line"></span><br><span class="line">bank.crisis = <span class="literal">False</span>  <span class="comment"># 问题是，即使改变crisis的值，ATM依然是空的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    print(<span class="built_in">next</span>(corner_street_atm))</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    print(<span class="string">&quot;crisis is %s, and still no more money!&quot;</span> % bank.crisis)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新创建一个ATM机，现在有钱了</span></span><br><span class="line">brand_new_atm = bank.create_atm()</span><br><span class="line">print([<span class="built_in">next</span>(brand_new_atm) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)])</span><br></pre></td></tr></table></figure>

<p><code>itertools</code> 模块包含了许多特殊的迭代方法</p>
<p>比赛中4匹马可能到达终点的先后顺序的可能情况</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line">horses = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">races = itertools.permutations(horses)</span><br><span class="line">print(races)</span><br><span class="line">pprint.pprint(<span class="built_in">list</span>(races))</span><br></pre></td></tr></table></figure>

<p>一个实现了 <code>__iter__</code> 方法的对象是可迭代的，一个实现了 <code>__next__</code> 方法的对象是迭代器。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fibs</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.a = <span class="number">0</span></span><br><span class="line">        self.b = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.a, self.b = self.b, self.a + self.b</span><br><span class="line">        <span class="keyword">return</span> self.a</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fibs = Fibs()</span><br><span class="line">print([<span class="built_in">next</span>(fibs) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)])</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Python3</tag>
      </tags>
  </entry>
  <entry>
    <title>基于 LSTM 深度学习模型的日志异常检测</title>
    <url>/2021/06/08/log-anomaly-detection/</url>
    <content><![CDATA[<!-- toc -->

<h2 id="日志模式识别"><a href="#日志模式识别" class="headerlink" title="日志模式识别"></a>日志模式识别</h2><h3 id="日志样例"><a href="#日志样例" class="headerlink" title="日志样例"></a>日志样例</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">2021-03-11 09:23:17,195 [OCKey:HlTOgWeM-LYFkTMn2wsXcEd] DEBUG com.dawninfotek.base.security.WebAppSafeGuard - BaseWebAppSafeGuard.class::key = beneAcctNo4 value = 1</span><br><span class="line">2021-03-11 09:23:17,849 [OCKey:zQXeCzqsWdY9_GliHIoAIpI] DEBUG com.dawninfotek.base.action.BaseDispatchAction - com.dawninfotek.easybanking.web.pr.olbfinance.polbfinancemyfinancenew.POLBFinanceMyFinanceAction::Base BaseDispatchAction - link6::37003747</span><br><span class="line">2021-03-11 09:23:18,635 [OCKey:cSrKSPklI9-juH5TB1VdT6N] DEBUG com.dawninfotek.base.dac.ConnectionFactory - java.lang.Class::Getting a connection from dataSource</span><br><span class="line">2021-03-11 09:23:18,635 [OCKey:cSrKSPklI9-juH5TB1VdT6N] DEBUG com.dawninfotek.base.dac.ConnectionFactory - java.lang.Class::got connection com.ibm.ws.rsadapter.jdbc.WSJdbcConnection@3bfa1e18 from dataSource: auto Commit = false</span><br><span class="line">2021-03-11 09:23:18,635 [OCKey:cSrKSPklI9-juH5TB1VdT6N] DEBUG java.sql.Connection - &#123;conn-12085845&#125; Connection</span><br><span class="line">2021-03-11 09:23:18,635 [OCKey:cSrKSPklI9-juH5TB1VdT6N] DEBUG java.sql.Connection - &#123;conn-12085845&#125; Preparing Statement:          select count(T.CUSTNO) from PERCRMPRODUCTDUEDATE t where t.CUSTNO=? and t.READFLAG = &#x27;0&#x27;</span><br><span class="line">2021-03-11 09:23:18,635 [OCKey:cSrKSPklI9-juH5TB1VdT6N] DEBUG java.sql.PreparedStatement - &#123;pstm-12085846&#125; Executing Statement:          select count(T.CUSTNO) from PERCRMPRODUCTDUEDATE t where t.CUSTNO=? and t.READFLAG = &#x27;0&#x27;</span><br><span class="line">2021-03-11 09:23:18,636 [OCKey:cSrKSPklI9-juH5TB1VdT6N] DEBUG java.sql.PreparedStatement - &#123;pstm-12085846&#125; Parameters: [42300205]</span><br><span class="line">2021-03-11 09:23:18,636 [OCKey:cSrKSPklI9-juH5TB1VdT6N] DEBUG java.sql.PreparedStatement - &#123;pstm-12085846&#125; Types: [java.lang.String]</span><br><span class="line">2021-03-11 09:23:18,636 [OCKey:cSrKSPklI9-juH5TB1VdT6N] DEBUG com.dawninfotek.easybanking.base.process.EasyBankingProcessManager - com.dawninfotek.easybanking.base.process.EasyBankingProcessManager::Start to commit transaction for DAC:EasyBankingSample</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h3 id="日志模式"><a href="#日志模式" class="headerlink" title="日志模式"></a>日志模式</h3><p>使用 Drain3 算法对日志进行模式提取，共提取得到 190 条日志模式，只展示部分结果。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;group_id&quot;</span>: <span class="number">1</span>, <span class="attr">&quot;cluster_id&quot;</span>: <span class="number">1</span>, <span class="attr">&quot;cluster_size&quot;</span>: <span class="number">62086</span>, <span class="attr">&quot;is_abnormal&quot;</span>: <span class="literal">false</span>, <span class="attr">&quot;template_mined&quot;</span>: <span class="string">&quot;&lt;MODULE&gt; key &lt;*&gt; value&quot;</span>, <span class="attr">&quot;template_tokenize&quot;</span>: <span class="string">&quot;modul key valu&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;group_id&quot;</span>: <span class="number">2</span>, <span class="attr">&quot;cluster_id&quot;</span>: <span class="number">2</span>, <span class="attr">&quot;cluster_size&quot;</span>: <span class="number">22856</span>, <span class="attr">&quot;is_abnormal&quot;</span>: <span class="literal">false</span>, <span class="attr">&quot;template_mined&quot;</span>: <span class="string">&quot;&lt;CLASS&gt; key &lt;KEY&gt; value &lt;VALUE&gt;&quot;</span>, <span class="attr">&quot;template_tokenize&quot;</span>: <span class="string">&quot;class key key valu valu&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;group_id&quot;</span>: <span class="number">3</span>, <span class="attr">&quot;cluster_id&quot;</span>: <span class="number">3</span>, <span class="attr">&quot;cluster_size&quot;</span>: <span class="number">2942</span>, <span class="attr">&quot;is_abnormal&quot;</span>: <span class="literal">false</span>, <span class="attr">&quot;template_mined&quot;</span>: <span class="string">&quot;&lt;MODULE&gt; Base BaseDispatchAction &lt;*&gt; &lt;*&gt;&quot;</span>, <span class="attr">&quot;template_tokenize&quot;</span>: <span class="string">&quot;modul base basedispatchact&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;group_id&quot;</span>: <span class="number">3</span>, <span class="attr">&quot;cluster_id&quot;</span>: <span class="number">53</span>, <span class="attr">&quot;cluster_size&quot;</span>: <span class="number">147</span>, <span class="attr">&quot;is_abnormal&quot;</span>: <span class="literal">false</span>, <span class="attr">&quot;template_mined&quot;</span>: <span class="string">&quot;&lt;MODULE&gt; Base BaseDispatchAction &lt;*&gt;&quot;</span>, <span class="attr">&quot;template_tokenize&quot;</span>: <span class="string">&quot;modul base basedispatchact&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;group_id&quot;</span>: <span class="number">4</span>, <span class="attr">&quot;cluster_id&quot;</span>: <span class="number">4</span>, <span class="attr">&quot;cluster_size&quot;</span>: <span class="number">16820</span>, <span class="attr">&quot;is_abnormal&quot;</span>: <span class="literal">false</span>, <span class="attr">&quot;template_mined&quot;</span>: <span class="string">&quot;&lt;MODULE&gt; Getting a connection from dataSource&quot;</span>, <span class="attr">&quot;template_tokenize&quot;</span>: <span class="string">&quot;modul connect datasourc&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;group_id&quot;</span>: <span class="number">5</span>, <span class="attr">&quot;cluster_id&quot;</span>: <span class="number">5</span>, <span class="attr">&quot;cluster_size&quot;</span>: <span class="number">16820</span>, <span class="attr">&quot;is_abnormal&quot;</span>: <span class="literal">false</span>, <span class="attr">&quot;template_mined&quot;</span>: <span class="string">&quot;&lt;MODULE&gt; got connection com.ibm.ws.rsadapter.jdbc.WSJdbcConnection &lt;*&gt; from dataSource auto Commit false&quot;</span>, <span class="attr">&quot;template_tokenize&quot;</span>: <span class="string">&quot;modul connect ibm rsadapt jdbc wsjdbcconnect datasourc auto commit fals&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;group_id&quot;</span>: <span class="number">6</span>, <span class="attr">&quot;cluster_id&quot;</span>: <span class="number">6</span>, <span class="attr">&quot;cluster_size&quot;</span>: <span class="number">23956</span>, <span class="attr">&quot;is_abnormal&quot;</span>: <span class="literal">false</span>, <span class="attr">&quot;template_mined&quot;</span>: <span class="string">&quot;&lt;CONN&gt; Connection&quot;</span>, <span class="attr">&quot;template_tokenize&quot;</span>: <span class="string">&quot;conn connect&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;group_id&quot;</span>: <span class="number">7</span>, <span class="attr">&quot;cluster_id&quot;</span>: <span class="number">7</span>, <span class="attr">&quot;cluster_size&quot;</span>: <span class="number">22323</span>, <span class="attr">&quot;is_abnormal&quot;</span>: <span class="literal">false</span>, <span class="attr">&quot;template_mined&quot;</span>: <span class="string">&quot;&lt;CONN&gt; Preparing Statement &lt;SQL&gt;&quot;</span>, <span class="attr">&quot;template_tokenize&quot;</span>: <span class="string">&quot;conn prepar statement sql&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;group_id&quot;</span>: <span class="number">8</span>, <span class="attr">&quot;cluster_id&quot;</span>: <span class="number">8</span>, <span class="attr">&quot;cluster_size&quot;</span>: <span class="number">22323</span>, <span class="attr">&quot;is_abnormal&quot;</span>: <span class="literal">false</span>, <span class="attr">&quot;template_mined&quot;</span>: <span class="string">&quot;&lt;PSTM&gt; Executing Statement &lt;SQL&gt;&quot;</span>, <span class="attr">&quot;template_tokenize&quot;</span>: <span class="string">&quot;pstm execut statement sql&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;group_id&quot;</span>: <span class="number">9</span>, <span class="attr">&quot;cluster_id&quot;</span>: <span class="number">9</span>, <span class="attr">&quot;cluster_size&quot;</span>: <span class="number">22322</span>, <span class="attr">&quot;is_abnormal&quot;</span>: <span class="literal">false</span>, <span class="attr">&quot;template_mined&quot;</span>: <span class="string">&quot;&lt;PSTM&gt; Parameters &lt;PARAMS&gt;&quot;</span>, <span class="attr">&quot;template_tokenize&quot;</span>: <span class="string">&quot;pstm paramet param&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>字段解释</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">group_id: 模式分组 ID，使用 Levenshtein 计算相似度，阈值为 0.8，大于等于阈值的模式会被分配到相同 group_id 之下。</span><br><span class="line">cluster_id：模式 ID。</span><br><span class="line">cluster_size: 模式匹配到的日志数量。</span><br><span class="line">is_abnormal: 根据通用的异常关键字，预判模式的异常。</span><br><span class="line">template_mined: 学习到的日志模式字符串。</span><br><span class="line">template_tokenize: 日志模式字符串经过一系列处理得到的字符串，后续日志模式向量计算基于该字符串。</span><br></pre></td></tr></table></figure>

<p>预置的通用异常关键字</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">abnormal_chars = [<span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;fail&#x27;</span>, <span class="string">&#x27;failed&#x27;</span>, <span class="string">&#x27;exception&#x27;</span>, <span class="string">&#x27;invalid&#x27;</span>, <span class="string">&#x27;missing&#x27;</span>, <span class="string">&#x27;duplicate&#x27;</span>, <span class="string">&#x27;unable&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>日志模式字符串处理过程</p>
<h4 id="提取中英文单词"><a href="#提取中英文单词" class="headerlink" title="提取中英文单词"></a>提取中英文单词</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_lower_alphabet</span>(<span class="params">char</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;小写字母&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\u0061&#x27;</span> &lt;= char &lt;= <span class="string">&#x27;\u007A&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_upper_alphabet</span>(<span class="params">char</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;大写字母&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\u0041&#x27;</span> &lt;= char &lt;= <span class="string">&#x27;\u005A&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_alphabet</span>(<span class="params">char</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;英文字母&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> is_lower_alphabet(char) <span class="keyword">or</span> is_upper_alphabet(char)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_chinese</span>(<span class="params">char</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;中文&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\u4e00&#x27;</span> &lt;= char &lt;= <span class="string">&#x27;\u9fff&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">segment</span>(<span class="params">text</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;中英文分词&quot;&quot;&quot;</span></span><br><span class="line">    chars = []</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> text:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_alphabet(char) <span class="keyword">and</span> <span class="keyword">not</span> is_chinese(char)::</span><br><span class="line">            <span class="keyword">if</span> chars:</span><br><span class="line">                word = <span class="string">&#x27;&#x27;</span>.join(chars)</span><br><span class="line">                <span class="keyword">yield</span> word</span><br><span class="line">                chars = []</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            chars.append(char)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> chars:</span><br><span class="line">        word = <span class="string">&#x27;&#x27;</span>.join(chars)</span><br><span class="line">        <span class="keyword">yield</span> word</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="中文分词"><a href="#中文分词" class="headerlink" title="中文分词"></a>中文分词</h4><p>如果提取得到的单词是中文，进一步将中文进行分词</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hanlp</span><br><span class="line">HanLP = hanlp.load(hanlp.pretrained.mtl.CLOSE_TOK_POS_NER_SRL_DEP_SDP_CON_ELECTRA_SMALL_ZH)</span><br><span class="line"></span><br><span class="line">tokens = HanLP(<span class="string">&#x27;读取限流控制参数值&#x27;</span>, tasks=<span class="string">&#x27;tok/fine&#x27;</span>)[<span class="string">&#x27;tok/fine&#x27;</span>]  <span class="comment"># [&#x27;读取&#x27;, &#x27;限流&#x27;, &#x27;控制&#x27;, &#x27;参数值&#x27;]</span></span><br></pre></td></tr></table></figure>

<h4 id="统一转化为小写"><a href="#统一转化为小写" class="headerlink" title="统一转化为小写"></a>统一转化为小写</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">word = <span class="built_in">str</span>.lower(word)</span><br></pre></td></tr></table></figure>

<h4 id="词干提取"><a href="#词干提取" class="headerlink" title="词干提取"></a>词干提取</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> nltk.stem.snowball <span class="keyword">import</span> SnowballStemmer</span><br><span class="line">stemmer= SnowballStemmer(<span class="string">&#x27;english&#x27;</span>)</span><br><span class="line"></span><br><span class="line">word = stemmer.stem(<span class="string">&#x27;Connection&#x27;</span>)  <span class="comment"># connect</span></span><br></pre></td></tr></table></figure>

<h4 id="词形还原"><a href="#词形还原" class="headerlink" title="词形还原"></a>词形还原</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> nltk.stem <span class="keyword">import</span> WordNetLemmatizer</span><br><span class="line">lemmatizer = WordNetLemmatizer()</span><br><span class="line"></span><br><span class="line">word = lemmatizer.lemmatize(<span class="string">&#x27;rooms&#x27;</span>)  <span class="comment"># room</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="去停用词"><a href="#去停用词" class="headerlink" title="去停用词"></a>去停用词</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 英文停用词: https://github.com/stopwords-iso/stopwords-en</span></span><br><span class="line"><span class="comment"># 中文停用词: https://github.com/goto456/stopwords</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_stopwords</span>():</span></span><br><span class="line">    english_path = Path(__file__).parent / <span class="string">&#x27;stopwords&#x27;</span> / <span class="string">&#x27;english&#x27;</span></span><br><span class="line">    chinese_path = Path(__file__).parent / <span class="string">&#x27;stopwords&#x27;</span> / <span class="string">&#x27;chinese&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> english_path.<span class="built_in">open</span>(<span class="string">&#x27;rt&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> en, chinese_path.<span class="built_in">open</span>(<span class="string">&#x27;rt&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> zh:</span><br><span class="line">        stopwords = &#123;line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> en&#125; | &#123;line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> zh&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> stopwords</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="模式向量计算"><a href="#模式向量计算" class="headerlink" title="模式向量计算"></a>模式向量计算</h2><h3 id="TF-IDF-计算"><a href="#TF-IDF-计算" class="headerlink" title="TF-IDF 计算"></a>TF-IDF 计算</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取日志模版</span></span><br><span class="line">template = pd.read_csv(<span class="string">&#x27;easybanking.csv&#x27;</span>)</span><br><span class="line">template.fillna(<span class="string">&#x27;&#x27;</span>, inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># TF-IDF 计算</span></span><br><span class="line">corpus = template[<span class="string">&#x27;template_tokenize&#x27;</span>].to_list()</span><br><span class="line">vectorizer = TfidfVectorizer()</span><br><span class="line">X = vectorizer.fit_transform(corpus)</span><br><span class="line"></span><br><span class="line">xarr = X.toarray()</span><br><span class="line">words = vectorizer.get_feature_names()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="词向量计算"><a href="#词向量计算" class="headerlink" title="词向量计算"></a>词向量计算</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> fasttext</span><br><span class="line">fasttext.FastText.eprint = <span class="keyword">lambda</span> x: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">ften = fasttext.load_model(<span class="string">&#x27;cc.en.300.bin&#x27;</span>)</span><br><span class="line">ftzh = fasttext.load_model(<span class="string">&#x27;cc.zh.300.bin&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WordVectorDict</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__missing__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(<span class="built_in">map</span>(is_chinese, key)):</span><br><span class="line">            <span class="keyword">return</span> ftzh.get_word_vector(key)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> ften.get_word_vector(key)</span><br><span class="line"></span><br><span class="line">word_vectors = WordVectorDict()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="模式向量"><a href="#模式向量" class="headerlink" title="模式向量"></a>模式向量</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模式向量计算</span></span><br><span class="line">template_vectors = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> row, arr <span class="keyword">in</span> <span class="built_in">zip</span>(template.to_dict(orient=<span class="string">&#x27;records&#x27;</span>), xarr):</span><br><span class="line">    lookup = defaultdict(<span class="built_in">int</span>, <span class="built_in">zip</span>(words, arr))</span><br><span class="line">    tokens = row[<span class="string">&#x27;template_tokenize&#x27;</span>].split()</span><br><span class="line">    tv = np.zeros(<span class="number">300</span>)</span><br><span class="line">    <span class="keyword">for</span> token <span class="keyword">in</span> tokens:</span><br><span class="line">        w = lookup[token]  <span class="comment"># TF-IDF</span></span><br><span class="line">        v = word_vectors[token]  <span class="comment"># 词向量</span></span><br><span class="line">        wv = w * v</span><br><span class="line">        tv += wv</span><br><span class="line">    tv = tv <span class="keyword">if</span> <span class="built_in">len</span>(tokens) == <span class="number">0</span> <span class="keyword">else</span> tv / <span class="built_in">len</span>(tokens)</span><br><span class="line">    template_vectors[row[<span class="string">&#x27;cluster_id&#x27;</span>]] = tv</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="模式相似度"><a href="#模式相似度" class="headerlink" title="模式相似度"></a>模式相似度</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line"></span><br><span class="line">cs = cosine_similarity(template_vector_1.reshape(<span class="number">1</span>,-<span class="number">1</span>), template_vector_2.reshape(<span class="number">1</span>,-<span class="number">1</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="评估指标"><a href="#评估指标" class="headerlink" title="评估指标"></a>评估指标</h2><ol>
<li>TP：True Positive，被判定为正样本，事实上也是证样本。</li>
<li>TN：True Negative，被判定为负样本，事实上也是负样本。</li>
<li>FP：False Positive，被判定为正样本，但事实上是负样本。</li>
<li>FN：False Negative，被判定为负样本，但事实上是正样本。</li>
<li>precesion：查准率，precesion = TP/(TP+FP)。</li>
<li>recall：查全率，recall = TP/(TP+FN)。</li>
</ol>
<h2 id="基于模式概率分布的异常检测"><a href="#基于模式概率分布的异常检测" class="headerlink" title="基于模式概率分布的异常检测"></a>基于模式概率分布的异常检测</h2><p>在没有得到日志模版向量表示之前，使用模版的索引对所有日志模版进行 One-Hot 编码，所以对于每一行日志都有一个其对应的模版编码，也可以叫模版概率分布。</p>
<p>对原始日志处理成模版的概率分布之后，我们可以训练一个多分类模型，预测下一个日志的模版概率分布，如果真实日志的模版不在预测的 topK 中，则认为日志是异常的。</p>
<h3 id="构造数据集"><a href="#构造数据集" class="headerlink" title="构造数据集"></a>构造数据集</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> label_binarize</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_window_dataset</span>(<span class="params">log_parsed_path, template_path, window_size, split_ratio=<span class="number">0.8</span></span>):</span></span><br><span class="line"></span><br><span class="line">    log_parsed = pd.read_csv(log_parsed_path)</span><br><span class="line">    templates = pd.read_csv(template_path)[<span class="string">&#x27;cluster_id&#x27;</span>].to_list()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fn</span>(<span class="params">dataset, look_back, look_interval=<span class="number">0</span>, look_forward=<span class="number">1</span></span>):</span></span><br><span class="line">        x, y = [], []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(dataset)-look_back-look_interval-look_forward):</span><br><span class="line">            back = dataset[i:i+look_back,]</span><br><span class="line">            forward = dataset[i+look_back+look_interval:i+look_back+look_interval+look_forward,]</span><br><span class="line">            back_x = label_binarize(back, classes=templates)</span><br><span class="line">            forward_y = label_binarize(forward, classes=templates)[<span class="number">0</span>]</span><br><span class="line">            x.append(back_x)</span><br><span class="line">            y.append(forward_y)</span><br><span class="line">        <span class="keyword">return</span> np.array(x), np.array(y)</span><br><span class="line"></span><br><span class="line">    dataset = log_parsed[[<span class="string">&#x27;cluster_id&#x27;</span>]].values</span><br><span class="line">    x, y = fn(dataset, window_size)</span><br><span class="line"></span><br><span class="line">    x_train, x_test, y_train, y_test = train_test_split(x, y, train_size=split_ratio, shuffle=<span class="literal">False</span>, stratify=<span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> (x_train, y_train), (x_test, y_test)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="模型定义"><a href="#模型定义" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tensorflow.keras <span class="keyword">import</span> layers, models, optimizers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_model</span>(<span class="params">input_shape, num_classes</span>):</span></span><br><span class="line">    inputs = layers.Input(shape=input_shape)</span><br><span class="line"></span><br><span class="line">    x = layers.Bidirectional(layers.LSTM(<span class="number">64</span>, return_sequences=<span class="literal">True</span>))(inputs)</span><br><span class="line">    x = layers.Bidirectional(layers.LSTM(<span class="number">64</span>))(x)</span><br><span class="line"></span><br><span class="line">    outputs = layers.Dense(num_classes, activation=<span class="string">&#x27;softmax&#x27;</span>)(x)</span><br><span class="line"></span><br><span class="line">    model = models.Model(inputs=inputs, outputs=outputs)</span><br><span class="line">    model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;categorical_crossentropy&#x27;</span>, optimizer=optimizers.Adam(), metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构造数据集</span></span><br><span class="line">n_candidates = <span class="number">10</span></span><br><span class="line">window_size = <span class="number">10</span></span><br><span class="line">log_parsed_path = <span class="string">&#x27;easybanking_parsed_1w.csv&#x27;</span></span><br><span class="line">template_path = <span class="string">&#x27;easybanking_template.csv&#x27;</span></span><br><span class="line">(x_train, y_train), (x_test, y_test) = create_window_dataset(log_parsed_path, template_path, window_size)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义模型</span></span><br><span class="line">num_classes = y_train.shape[<span class="number">1</span>]</span><br><span class="line">input_shape = (x_train.shape[<span class="number">1</span>], x_train.shape[<span class="number">2</span>])</span><br><span class="line">model = build_model(input_shape, num_classes)</span><br><span class="line">model.summary()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型训练</span></span><br><span class="line">call_backs = [</span><br><span class="line">    callbacks.ModelCheckpoint(<span class="string">&quot;best_model.h5&quot;</span>, save_best_only=<span class="literal">True</span>, monitor=<span class="string">&quot;val_loss&quot;</span>),</span><br><span class="line">    callbacks.ReduceLROnPlateau(monitor=<span class="string">&quot;val_loss&quot;</span>, factor=<span class="number">0.5</span>, patience=<span class="number">20</span>, min_lr=<span class="number">0.0001</span>),</span><br><span class="line">    callbacks.EarlyStopping(monitor=<span class="string">&quot;val_loss&quot;</span>, patience=<span class="number">50</span>, verbose=<span class="number">1</span>),</span><br><span class="line">]</span><br><span class="line">history = model.fit(x_train, y_train, batch_size=<span class="number">32</span>, epochs=<span class="number">20</span>, callbacks=call_backs, validation_split=<span class="number">0.2</span>, shuffle=<span class="literal">True</span>, verbose=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 评估模型</span></span><br><span class="line">best_model = models.load_model(<span class="string">&quot;best_model.h5&quot;</span>)</span><br><span class="line">y_pred = best_model.predict(x_test)</span><br><span class="line">y_true = np.argmax(y_test, axis=<span class="number">1</span>)</span><br><span class="line">y_pred = np.argmax(y_pred, axis=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 我们只知道日志模式预测的正确与否，但是不知道真实这条日志是否为异常，所以无法计算 TP、TN、FP 和 FN。</span></span><br><span class="line"><span class="comment"># 简单起见计算全局准确率和召回率，这里只取 topK K = 1。真正需要提高准确率等需要在模型参数和日志数据及其处理等方面调节。</span></span><br><span class="line">precision, recall, f1, _ = precision_recall_fscore_support(y_true, y_pred, average=<span class="string">&#x27;micro&#x27;</span>)</span><br><span class="line"><span class="comment"># (0.7737737737737738, 0.7737737737737738, 0.7737737737737739, None)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ol>
<li>该方案对日志模板进行编码时只使用模板索引，这可能导致丢失有价值的信息，因为模板索引不能揭示日志的语义关系。</li>
<li>真实系统不断升级和更新，日志的模式可能会相应地漂移，该方案难以应付不断变化的、有噪声的日志数据。</li>
</ol>
<h2 id="基于有监督二分类的异常检测"><a href="#基于有监督二分类的异常检测" class="headerlink" title="基于有监督二分类的异常检测"></a>基于有监督二分类的异常检测</h2><p>我们得到了日志模版的向量表示，如果我们的数据集被人工标注了异常，我们很容易训练一个二分类模型，直接输出异常与否，由于应用日志没有异常标注，所以此方案做不了，为了实验可以使用公开的 HDFS 日志，这份日志有异常标注。</p>
<h3 id="构造数据集-1"><a href="#构造数据集-1" class="headerlink" title="构造数据集"></a>构造数据集</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_label_dataset</span>(<span class="params">log_parsed_path, template_path, split_ratio=<span class="number">0.8</span></span>):</span></span><br><span class="line">    <span class="keyword">import</span> fasttext</span><br><span class="line">    fasttext.FastText.eprint = <span class="keyword">lambda</span> x: <span class="literal">None</span></span><br><span class="line">    <span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"></span><br><span class="line">    ften = fasttext.load_model(<span class="string">&#x27;/Users/fuyun/nltk_data/cc.en.300.bin&#x27;</span>)</span><br><span class="line">    ftzh = fasttext.load_model(<span class="string">&#x27;/Users/fuyun/nltk_data/cc.zh.300.bin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WordVectorDict</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__missing__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(<span class="built_in">map</span>(is_chinese, key)):</span><br><span class="line">                <span class="keyword">return</span> ftzh.get_word_vector(key)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> ften.get_word_vector(key)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读取日志模版</span></span><br><span class="line">    template = pd.read_csv(template_path)</span><br><span class="line">    template.fillna(<span class="string">&#x27;&#x27;</span>, inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># TF-IDF 计算</span></span><br><span class="line">    corpus = template[<span class="string">&#x27;template_tokenize&#x27;</span>].to_list()</span><br><span class="line">    vectorizer = TfidfVectorizer()</span><br><span class="line">    X = vectorizer.fit_transform(corpus)</span><br><span class="line">    xarr = X.toarray()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 词向量计算</span></span><br><span class="line">    words = vectorizer.get_feature_names()</span><br><span class="line">    word_vectors = WordVectorDict()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模版向量计算</span></span><br><span class="line">    template_vectors = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> row, arr <span class="keyword">in</span> <span class="built_in">zip</span>(template.to_dict(orient=<span class="string">&#x27;records&#x27;</span>), xarr):</span><br><span class="line">        lookup = defaultdict(<span class="built_in">int</span>, <span class="built_in">zip</span>(words, arr))</span><br><span class="line">        tokens = row[<span class="string">&#x27;template_tokenize&#x27;</span>].split()</span><br><span class="line">        tv = np.zeros(<span class="number">300</span>)</span><br><span class="line">        <span class="keyword">for</span> token <span class="keyword">in</span> tokens:</span><br><span class="line">            w = lookup[token]  <span class="comment"># TF-IDF</span></span><br><span class="line">            v = word_vectors[token]  <span class="comment"># 词向量</span></span><br><span class="line">            wv = w * v</span><br><span class="line">            tv += wv</span><br><span class="line">        tv = tv <span class="keyword">if</span> <span class="built_in">len</span>(tokens) == <span class="number">0</span> <span class="keyword">else</span> tv / <span class="built_in">len</span>(tokens)</span><br><span class="line">        template_vectors[row[<span class="string">&#x27;cluster_id&#x27;</span>]] = tv</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读取日志解析结果</span></span><br><span class="line">    log_vectors = []</span><br><span class="line">    log_parsed = pd.read_csv(log_parsed_path)</span><br><span class="line">    <span class="keyword">for</span> cluster_id <span class="keyword">in</span> log_parsed[<span class="string">&#x27;cluster_id&#x27;</span>].to_list():</span><br><span class="line">        tv = template_vectors[cluster_id]</span><br><span class="line">        log_vectors.append(tv)</span><br><span class="line"></span><br><span class="line">    log_labels = log_parsed[<span class="string">&#x27;label&#x27;</span>].to_list()</span><br><span class="line"></span><br><span class="line">    x = np.array(log_vectors)</span><br><span class="line">    x = np.reshape(x, (x.shape[<span class="number">0</span>], <span class="number">1</span>, x.shape[<span class="number">1</span>]))</span><br><span class="line">    y = np.array(log_labels)</span><br><span class="line">    x_train, x_test, y_train, y_test = train_test_split(x, y, train_size=split_ratio, shuffle=<span class="literal">False</span>, stratify=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># np.savez(&#x27;HDFS_10w.npz&#x27;, x_train=x_train, x_test=x_test, y_train=y_train, y_test=y_test)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (x_train, y_train), (x_test, y_test)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="模型定义-1"><a href="#模型定义-1" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tensorflow.keras <span class="keyword">import</span> layers, models, optimizers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_model</span>(<span class="params">input_shape, num_classes</span>):</span></span><br><span class="line">    inputs = layers.Input(shape=input_shape)</span><br><span class="line"></span><br><span class="line">    x = layers.Bidirectional(layers.LSTM(<span class="number">64</span>, return_sequences=<span class="literal">True</span>))(inputs)</span><br><span class="line">    x = layers.Bidirectional(layers.LSTM(<span class="number">64</span>))(x)</span><br><span class="line"></span><br><span class="line">    outputs = layers.Dense(num_classes, activation=<span class="string">&#x27;sigmoid&#x27;</span>)(x)</span><br><span class="line"></span><br><span class="line">    model = models.Model(inputs=inputs, outputs=outputs)</span><br><span class="line">    model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;binary_crossentropy&#x27;</span>, optimizer=optimizers.Adam(), metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="模型训练-1"><a href="#模型训练-1" class="headerlink" title="模型训练"></a>模型训练</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构造数据集</span></span><br><span class="line">log_parsed_path = <span class="string">&#x27;HDFS_parsed_10w.csv&#x27;</span></span><br><span class="line">template_path = <span class="string">&#x27;HDFS_template.csv&#x27;</span></span><br><span class="line">(x_train, y_train), (x_test, y_test) =  create_label_dataset(log_parsed_path, template_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义模型</span></span><br><span class="line">num_classes = <span class="number">1</span></span><br><span class="line">input_shape = (x_train.shape[<span class="number">1</span>], x_train.shape[<span class="number">2</span>])</span><br><span class="line">model = build_model(input_shape, num_classes)</span><br><span class="line">model.summary()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型训练</span></span><br><span class="line">call_backs = [</span><br><span class="line">    callbacks.ModelCheckpoint(<span class="string">&quot;best_model.h5&quot;</span>, save_best_only=<span class="literal">True</span>, monitor=<span class="string">&quot;val_loss&quot;</span>),</span><br><span class="line">    callbacks.ReduceLROnPlateau(monitor=<span class="string">&quot;val_loss&quot;</span>, factor=<span class="number">0.5</span>, patience=<span class="number">20</span>, min_lr=<span class="number">0.0001</span>),</span><br><span class="line">    callbacks.EarlyStopping(monitor=<span class="string">&quot;val_loss&quot;</span>, patience=<span class="number">50</span>, verbose=<span class="number">1</span>),</span><br><span class="line">]</span><br><span class="line">history = model.fit(x_train, y_train, batch_size=<span class="number">32</span>, epochs=<span class="number">20</span>, callbacks=call_backs, validation_split=<span class="number">0.2</span>, shuffle=<span class="literal">True</span>, verbose=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 评估模型</span></span><br><span class="line">best_model = models.load_model(<span class="string">&quot;best_model.h5&quot;</span>)</span><br><span class="line">y_pred = best_model.predict(x_test)</span><br><span class="line">y_pred = y_pred[:,<span class="number">0</span>].astype(<span class="built_in">int</span>)</span><br><span class="line">precision, recall, f1, _ = precision_recall_fscore_support(y_true, y_pred, average=<span class="string">&#x27;binary&#x27;</span>)</span><br><span class="line"><span class="comment"># (0.9553976053045843, 1.0, 0.9771901149032715, None)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 画图</span></span><br><span class="line">metric = <span class="string">&quot;accuracy&quot;</span></span><br><span class="line">plt.figure()</span><br><span class="line">plt.plot(history.history[metric])</span><br><span class="line">plt.plot(history.history[<span class="string">&quot;val_&quot;</span> + metric])</span><br><span class="line">plt.title(<span class="string">&quot;model &quot;</span> + metric)</span><br><span class="line">plt.ylabel(metric, fontsize=<span class="string">&quot;large&quot;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&quot;epoch&quot;</span>, fontsize=<span class="string">&quot;large&quot;</span>)</span><br><span class="line">plt.legend([<span class="string">&quot;train&quot;</span>, <span class="string">&quot;val&quot;</span>], loc=<span class="string">&quot;best&quot;</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/HDFS.png" class="lazyload" data-srcset="/images/HDFS.png" srcset="data:image/png;base64,666" alt="HDFS model accuracy"></p>
<h2 id="基于预测模式向量的异常检测"><a href="#基于预测模式向量的异常检测" class="headerlink" title="基于预测模式向量的异常检测"></a>基于预测模式向量的异常检测</h2><p>由于没有异常标注数据，所以需要换一种思路进行异常检测，借鉴对时间序列的预测，我们可以认为日志是一种时间序列，此方案中我们训练的模型不是分类模型，而是回归模型，预测下一个日志的模版向量表示，与真实日志的模版向量进行相似度计算，计算出的相似度低于某个阈值则认为该日志是异常的，相似度采用余弦相似度。</p>
<h3 id="构造数据集-2"><a href="#构造数据集-2" class="headerlink" title="构造数据集"></a>构造数据集</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_vector_dataset</span>(<span class="params">log_parsed_path, template_path, window_size, split_ratio=<span class="number">0.8</span></span>):</span></span><br><span class="line">    <span class="keyword">import</span> fasttext</span><br><span class="line">    fasttext.FastText.eprint = <span class="keyword">lambda</span> x: <span class="literal">None</span></span><br><span class="line">    <span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"></span><br><span class="line">    ften = fasttext.load_model(<span class="string">&#x27;cc.en.300.bin&#x27;</span>)</span><br><span class="line">    ftzh = fasttext.load_model(<span class="string">&#x27;cc.zh.300.bin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WordVectorDict</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__missing__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(<span class="built_in">map</span>(is_chinese, key)):</span><br><span class="line">                <span class="keyword">return</span> ftzh.get_word_vector(key)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> ften.get_word_vector(key)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读取日志模版</span></span><br><span class="line">    template = pd.read_csv(template_path)</span><br><span class="line">    template.fillna(<span class="string">&#x27;&#x27;</span>, inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># TF-IDF 计算</span></span><br><span class="line">    corpus = template[<span class="string">&#x27;template_tokenize&#x27;</span>].to_list()</span><br><span class="line">    vectorizer = TfidfVectorizer()</span><br><span class="line">    X = vectorizer.fit_transform(corpus)</span><br><span class="line">    xarr = X.toarray()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 词向量计算</span></span><br><span class="line">    words = vectorizer.get_feature_names()</span><br><span class="line">    word_vectors = WordVectorDict()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模版向量计算</span></span><br><span class="line">    template_vectors = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> row, arr <span class="keyword">in</span> <span class="built_in">zip</span>(template.to_dict(orient=<span class="string">&#x27;records&#x27;</span>), xarr):</span><br><span class="line">        lookup = defaultdict(<span class="built_in">int</span>, <span class="built_in">zip</span>(words, arr))</span><br><span class="line">        tokens = row[<span class="string">&#x27;template_tokenize&#x27;</span>].split()</span><br><span class="line">        tv = np.zeros(<span class="number">300</span>)</span><br><span class="line">        <span class="keyword">for</span> token <span class="keyword">in</span> tokens:</span><br><span class="line">            w = lookup[token]  <span class="comment"># TF-IDF</span></span><br><span class="line">            v = word_vectors[token]  <span class="comment"># 词向量</span></span><br><span class="line">            wv = w * v</span><br><span class="line">            tv += wv</span><br><span class="line">        tv = tv <span class="keyword">if</span> <span class="built_in">len</span>(tokens) == <span class="number">0</span> <span class="keyword">else</span> tv / <span class="built_in">len</span>(tokens)</span><br><span class="line">        template_vectors[row[<span class="string">&#x27;cluster_id&#x27;</span>]] = tv</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读取日志解析结果</span></span><br><span class="line">    log_vectors = []</span><br><span class="line">    log_parsed = pd.read_csv(log_parsed_path)</span><br><span class="line">    <span class="keyword">for</span> cluster_id <span class="keyword">in</span> log_parsed[<span class="string">&#x27;cluster_id&#x27;</span>].to_list():</span><br><span class="line">        tv = template_vectors[cluster_id]</span><br><span class="line">        log_vectors.append(tv)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fn</span>(<span class="params">dataset, look_back, look_interval=<span class="number">0</span>, look_forward=<span class="number">1</span></span>):</span></span><br><span class="line">        x, y = [], []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(dataset)-look_back-look_interval-look_forward):</span><br><span class="line">            back = dataset[i:i+look_back,]</span><br><span class="line">            forward = dataset[i+look_back+look_interval:i+look_back+look_interval+look_forward,]</span><br><span class="line">            x.append(back)</span><br><span class="line">            y.append(forward)</span><br><span class="line">        <span class="keyword">return</span> np.array(x), np.array(y)</span><br><span class="line"></span><br><span class="line">    x, y = fn(np.array(log_vectors), window_size)</span><br><span class="line">    y = y[:,<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    x_train, x_test, y_train, y_test = train_test_split(x, y, train_size=split_ratio, shuffle=<span class="literal">False</span>, stratify=<span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># np.savez(&#x27;easybanking_1w.npz&#x27;, x_train=x_train, x_test=x_test, y_train=y_train, y_test=y_test)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (x_train, y_train), (x_test, y_test)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="模型定义-2"><a href="#模型定义-2" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tensorflow.keras <span class="keyword">import</span> layers, models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_model</span>(<span class="params">n_steps_in, n_features, n_steps_out</span>):</span></span><br><span class="line">    model = models.Sequential()</span><br><span class="line">    model.add(layers.Bidirectional(layers.LSTM(units=<span class="number">64</span>, activation=<span class="string">&#x27;tanh&#x27;</span>), input_shape=(n_steps_in, n_features)))</span><br><span class="line">    model.add(layers.Dense(n_steps_out))</span><br><span class="line">    model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>, metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="模型训练-2"><a href="#模型训练-2" class="headerlink" title="模型训练"></a>模型训练</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造数据集</span></span><br><span class="line">window_size = <span class="number">10</span></span><br><span class="line">log_parsed_path = <span class="string">&#x27;easybanking_parsed_1w.csv&#x27;</span></span><br><span class="line">template_path = <span class="string">&#x27;easybanking_template.csv&#x27;</span></span><br><span class="line">(x_train, y_train), (x_test, y_test) = create_vector_dataset(log_parsed_path, template_path, window_size)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义模型</span></span><br><span class="line">n_steps_in, n_features, n_steps_out = (x_train.shape[<span class="number">1</span>], x_train.shape[<span class="number">2</span>], y_train.shape[<span class="number">1</span>])</span><br><span class="line">model = build_model(n_steps_in, n_features, n_features)</span><br><span class="line">model.summary()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型训练</span></span><br><span class="line">call_backs = [</span><br><span class="line">    callbacks.ModelCheckpoint(<span class="string">&quot;best_model.h5&quot;</span>, save_best_only=<span class="literal">True</span>, monitor=<span class="string">&quot;val_loss&quot;</span>),</span><br><span class="line">    callbacks.ReduceLROnPlateau(monitor=<span class="string">&quot;val_loss&quot;</span>, factor=<span class="number">0.5</span>, patience=<span class="number">20</span>, min_lr=<span class="number">0.0001</span>),</span><br><span class="line">    callbacks.EarlyStopping(monitor=<span class="string">&quot;val_loss&quot;</span>, patience=<span class="number">50</span>, verbose=<span class="number">1</span>),</span><br><span class="line">]</span><br><span class="line">history = model.fit(x_train, y_train, batch_size=<span class="number">32</span>, epochs=<span class="number">20</span>, callbacks=call_backs, validation_split=<span class="number">0.2</span>, shuffle=<span class="literal">True</span>, verbose=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 画图</span></span><br><span class="line">metric = <span class="string">&quot;accuracy&quot;</span></span><br><span class="line">plt.figure()</span><br><span class="line">plt.plot(history.history[metric])</span><br><span class="line">plt.plot(history.history[<span class="string">&quot;val_&quot;</span> + metric])</span><br><span class="line">plt.title(<span class="string">&quot;model &quot;</span> + metric)</span><br><span class="line">plt.ylabel(metric, fontsize=<span class="string">&quot;large&quot;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&quot;epoch&quot;</span>, fontsize=<span class="string">&quot;large&quot;</span>)</span><br><span class="line">plt.legend([<span class="string">&quot;train&quot;</span>, <span class="string">&quot;val&quot;</span>], loc=<span class="string">&quot;best&quot;</span>)</span><br><span class="line">plt.show()</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure>

<p><img src="/images/easybanking.png" class="lazyload" data-srcset="/images/easybanking.png" srcset="data:image/png;base64,666" alt="easybanking model accuracy"></p>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>LSTM</tag>
        <tag>Drain3</tag>
        <tag>FastText</tag>
        <tag>HanLP</tag>
      </tags>
  </entry>
  <entry>
    <title>LSTM 时间序列预测</title>
    <url>/2020/12/03/lstm-models-for-time-series-forecasting/</url>
    <content><![CDATA[<!-- toc -->

<h2 id="调节内容"><a href="#调节内容" class="headerlink" title="调节内容"></a>调节内容</h2><p>1.输出维度 units<br>2.时间步长 timesteps<br>3.激活函数 activation<br>4.增加特征：增长率<br>5.增加特征：日期属性<br>6.预测增长率<br>7.单层 stateful LSTM<br>8.双层 stateful LSTM<br>9.批数据大小 batch_size<br>10.训练循环次数 epochs<br>11.原序列对数<br>12.原序列差分<br>13.归一化值域 feature_range<br>14.Bidirectional LSTM<br>15.CNN LSTM<br>16.ConvLSTM</p>
<a id="more"></a>

<h2 id="原始数据集"><a href="#原始数据集" class="headerlink" title="原始数据集"></a>原始数据集</h2><p><img src="/images/trans.png" class="lazyload" data-srcset="/images/trans.png" srcset="data:image/png;base64,666" alt="trans"></p>
<h2 id="原始序列"><a href="#原始序列" class="headerlink" title="原始序列"></a>原始序列</h2><h3 id="超参数"><a href="#超参数" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 1              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义"><a href="#模型定义" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps,features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, epochs=epochs, batch_size=batch_size, validation_data=(x_valid, y_valid), callbacks=callbacks, verbose=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h3 id="验证损失"><a href="#验证损失" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.00031516602518997155</span><br><span class="line">elapsed time: 2.2270960807800293 (s)</span><br><span class="line">Train Score: 2350.04 RMSE</span><br><span class="line">Valid Score: 1975.81 RMSE</span><br><span class="line">Test Score: 1143.96 RMSE</span><br></pre></td></tr></table></figure>

<p><img src="/images/loss1.png" class="lazyload" data-srcset="/images/loss1.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred1.png" class="lazyload" data-srcset="/images/pred1.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="Stateful-LSTM"><a href="#Stateful-LSTM" class="headerlink" title="Stateful LSTM"></a>Stateful LSTM</h2><p><strong>使 RNN 具有状态意味着每批样品的状态将被重新用作下一批样品的初始状态。</strong></p>
<blockquote>
<p>stateful LSTM：能让模型学习到你输入的samples之间的时序特征，适合一些长序列的预测，哪个sample在前，那个sample在后对模型是有影响的。<br>stateless LSTM：输入samples后，默认就会shuffle，可以说是每个sample独立，之间无前后关系，适合输入一些没有关系的样本。</p>
</blockquote>
<h3 id="超参数-1"><a href="#超参数-1" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 1              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-1"><a href="#模型定义-1" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, stateful=<span class="literal">True</span>, batch_input_shape=(batch_size, timesteps, features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">    history = model.fit(x_train, y_train, batch_size=batch_size, epochs=<span class="number">1</span>, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line">    model.reset_states()</span><br></pre></td></tr></table></figure>

<h3 id="验证损失-1"><a href="#验证损失-1" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.0003053233659405426</span><br><span class="line">elapsed time: 8.588087797164917 (s)</span><br><span class="line">Train Score: 2098.81 RMSE</span><br><span class="line">Valid Score: 1768.38 RMSE</span><br><span class="line">Test Score: 880.83 RMSE</span><br><span class="line"></span><br><span class="line"># stateful带来了一些改观，从理论上讲stateful会有些好处，因为我们的数据是具有自相关性的时序数据。</span><br><span class="line"># 但是stateful限制训练、验证和预测必须接受以batch为单位的数据，给后面预测带来很大变动和限制，故不使用stateful。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/loss2.png" class="lazyload" data-srcset="/images/loss2.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred2.png" class="lazyload" data-srcset="/images/pred2.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="序列对数"><a href="#序列对数" class="headerlink" title="序列对数"></a>序列对数</h2><h3 id="超参数-2"><a href="#超参数-2" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 1              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-2"><a href="#模型定义-2" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="验证损失-2"><a href="#验证损失-2" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.0003706229881521907</span><br><span class="line">elapsed time: 2.328054904937744 (s)</span><br><span class="line">Train Score: 2451.66 RMSE</span><br><span class="line">Valid Score: 1843.60 RMSE</span><br><span class="line">Test Score: 901.27 RMSE</span><br><span class="line"></span><br><span class="line"># 取对数在验证集和测试集上有所改观，在训练集上误差稍微增大</span><br></pre></td></tr></table></figure>

<p><img src="/images/loss3.png" class="lazyload" data-srcset="/images/loss3.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred3.png" class="lazyload" data-srcset="/images/pred3.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="序列差分"><a href="#序列差分" class="headerlink" title="序列差分"></a>序列差分</h2><h3 id="超参数-3"><a href="#超参数-3" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 1              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-3"><a href="#模型定义-3" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br></pre></td></tr></table></figure>

<h3 id="一阶差分"><a href="#一阶差分" class="headerlink" title="一阶差分"></a>一阶差分</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 9.300382513113658e-05</span><br><span class="line">elapsed time: 1.9793977737426758 (s)</span><br><span class="line">Train Score: 1868.55 RMSE</span><br><span class="line">Valid Score: 1608.05 RMSE</span><br><span class="line">Test Score: 884.86 RMSE</span><br><span class="line"></span><br><span class="line"># 一阶差分误差改善效果明显，相较于取对数更优。</span><br><span class="line"># 经过验证发现将归一化值域调整为 feature_range = (-1, 1) 之后</span><br><span class="line"># 验证集损失 val_loss 会增大，但是 Train, Valid, Test 的 RMSE 却减少 100-200左右</span><br><span class="line"># 经过差分之后的数据有正有负，似乎 (-1, 1) 是合理的，但是本文将保持 (0, 1) 不变</span><br><span class="line"># 研究其他变化带来的变化，最后选出最优的特征和超参数，归一化值域可随时更改</span><br></pre></td></tr></table></figure>

<p><img src="/images/loss4.png" class="lazyload" data-srcset="/images/loss4.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred4.png" class="lazyload" data-srcset="/images/pred4.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h3 id="二阶差分"><a href="#二阶差分" class="headerlink" title="二阶差分"></a>二阶差分</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.00017968161298761821</span><br><span class="line">elapsed time: 2.5699269771575928 (s)</span><br><span class="line">Train Score: 2607.74 RMSE</span><br><span class="line">Valid Score: 2270.10 RMSE</span><br><span class="line">Test Score: 1025.25 RMSE</span><br><span class="line"></span><br><span class="line"># 二阶差分反而更差了，故只取一阶差分</span><br></pre></td></tr></table></figure>

<p><img src="/images/loss5.png" class="lazyload" data-srcset="/images/loss5.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred5.png" class="lazyload" data-srcset="/images/pred5.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="序列对数差分"><a href="#序列对数差分" class="headerlink" title="序列对数差分"></a>序列对数差分</h2><h3 id="超参数-4"><a href="#超参数-4" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 1              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-4"><a href="#模型定义-4" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="验证损失-3"><a href="#验证损失-3" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 8.005627370742416e-05</span><br><span class="line">elapsed time: 2.5233328342437744 (s)</span><br><span class="line">Train Score: 1883.97 RMSE</span><br><span class="line">Valid Score: 1621.68 RMSE</span><br><span class="line">Test Score: 879.93 RMSE</span><br><span class="line"></span><br><span class="line"># 可以发现对数差分的效果几乎和一阶差分的效果是一样的，取对数的效果微乎其微。</span><br><span class="line"># 差分之后的序列更接近平稳序列，可能更有利于LSTM建模预测。</span><br><span class="line"># 取对数只是缩小值域，再说还有归一化操作，似乎不是必要的。</span><br><span class="line"># 比如像LightGBM算法并没有归一化操作，所以取对数有比较好的调参效果。</span><br></pre></td></tr></table></figure>

<p><img src="/images/loss6.png" class="lazyload" data-srcset="/images/loss6.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred6.png" class="lazyload" data-srcset="/images/pred6.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="增加日期属性"><a href="#增加日期属性" class="headerlink" title="增加日期属性"></a>增加日期属性</h2><p><img src="/images/gzdate.png" class="lazyload" data-srcset="/images/gzdate.png" srcset="data:image/png;base64,666" alt="gzdate"></p>
<h3 id="超参数-5"><a href="#超参数-5" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 4              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-5"><a href="#模型定义-5" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="验证损失-4"><a href="#验证损失-4" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.002384760812697476</span><br><span class="line">elapsed time: 1.893902063369751 (s)</span><br><span class="line">Train Score: 2104.13 RMSE</span><br><span class="line">Valid Score: 5434.98 RMSE</span><br><span class="line">Test Score: 5839.40 RMSE</span><br><span class="line"></span><br><span class="line"># 模型在训练集、验证集和测试集表现越来越差</span><br></pre></td></tr></table></figure>

<p><img src="/images/loss7.png" class="lazyload" data-srcset="/images/loss7.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred7.png" class="lazyload" data-srcset="/images/pred7.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="增加增长率"><a href="#增加增长率" class="headerlink" title="增加增长率"></a>增加增长率</h2><p><img src="/images/gzrate.png" class="lazyload" data-srcset="/images/gzrate.png" srcset="data:image/png;base64,666" alt="gzrate"></p>
<h3 id="超参数-6"><a href="#超参数-6" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 2              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-6"><a href="#模型定义-6" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=<span class="number">1</span>, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="验证损失-5"><a href="#验证损失-5" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.00023447876570476951</span><br><span class="line">elapsed time: 2.060291051864624 (s)</span><br><span class="line">Train Score: 2084.47 RMSE</span><br><span class="line">Valid Score: 1704.23 RMSE</span><br><span class="line">Test Score: 1039.05 RMSE</span><br><span class="line"></span><br><span class="line"># 增长率也可以改善预测结果，原理和一阶差分相似，差分是做减法，增长率是做除法。</span><br><span class="line"># 误差减小了，但是增长率产生了负数的情况。</span><br><span class="line"># 之前的实验是增长率结合stateful LSTM，得到的结果是：增长率可以和一阶差分类似改善拟合结果，并无发现有负数的情况。</span><br><span class="line"># 做完实验考虑预测部分的时候发现stateful必须接受batch为单位的数据，使得预测变得麻烦，改动工作较大。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/loss8.png" class="lazyload" data-srcset="/images/loss8.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred8.png" class="lazyload" data-srcset="/images/pred8.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h3 id="预测增长率"><a href="#预测增长率" class="headerlink" title="预测增长率"></a>预测增长率</h3><p>变换目标值为增长率，预测增长率，和前一天的交易量进行计算，得到当前的交易预测值。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.007923171162502511</span><br><span class="line">elapsed time: 1.5544190406799316 (s)</span><br><span class="line">Train Score: 1575.60 RMSE</span><br><span class="line">Valid Score: 1307.57 RMSE</span><br><span class="line">Test Score: 761.17 RMSE</span><br><span class="line"></span><br><span class="line"># 结合图可以看出，相比增加增长率这个特征，直接预测增长率收到了比较好的效果。</span><br><span class="line"># 而且没有出现负数的情况，拟合误差减少很多，可以采用。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/loss9.png" class="lazyload" data-srcset="/images/loss9.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred9.png" class="lazyload" data-srcset="/images/pred9.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="双层LSTM"><a href="#双层LSTM" class="headerlink" title="双层LSTM"></a>双层LSTM</h2><h3 id="超参数-7"><a href="#超参数-7" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 1              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="单层LSTM有Dropout"><a href="#单层LSTM有Dropout" class="headerlink" title="单层LSTM有Dropout"></a>单层LSTM有Dropout</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dropout(<span class="number">0.2</span>))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=<span class="number">1</span>, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.00024637159007593934</span><br><span class="line">elapsed time: 2.1154732704162598 (s)</span><br><span class="line">Train Score: 2107.65 RMSE</span><br><span class="line">Valid Score: 1746.91 RMSE</span><br><span class="line">Test Score: 906.77 RMSE</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/loss10.png" class="lazyload" data-srcset="/images/loss10.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred10.png" class="lazyload" data-srcset="/images/pred10.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h3 id="双层LSTM有Dropout"><a href="#双层LSTM有Dropout" class="headerlink" title="双层LSTM有Dropout"></a>双层LSTM有Dropout</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features), return_sequences=<span class="literal">True</span>))</span><br><span class="line">model.add(Dropout(<span class="number">0.2</span>))</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dropout(<span class="number">0.2</span>))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.00030157841621581707</span><br><span class="line">elapsed time: 3.7397210597991943 (s)</span><br><span class="line">Train Score: 2266.96 RMSE</span><br><span class="line">Valid Score: 1932.75 RMSE</span><br><span class="line">Test Score: 1101.70 RMSE</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/loss11.png" class="lazyload" data-srcset="/images/loss11.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred11.png" class="lazyload" data-srcset="/images/pred11.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h3 id="双层LSTM无Dropout"><a href="#双层LSTM无Dropout" class="headerlink" title="双层LSTM无Dropout"></a>双层LSTM无Dropout</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features), return_sequences=<span class="literal">True</span>))</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.00028111153606354833</span><br><span class="line">elapsed time: 3.16672682762146 (s)</span><br><span class="line">Train Score: 2269.73 RMSE</span><br><span class="line">Valid Score: 1866.01 RMSE</span><br><span class="line">Test Score: 1003.38 RMSE</span><br><span class="line"></span><br><span class="line"># 单层LSTM加上Dropout正则化层，相较于单层LSTM似乎有所改善，但对于Dropout的作用还不太明白。</span><br><span class="line"># 双层LSTM加上Dropout正则化层，相较于双层LSTM又是略差些，但是相差不大。</span><br><span class="line"># 对于这些结果，可能需要多次实验取均值来确定哪些因素对拟合更优。</span><br></pre></td></tr></table></figure>

<p><img src="/images/loss12.png" class="lazyload" data-srcset="/images/loss12.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred12.png" class="lazyload" data-srcset="/images/pred12.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="差分结合增长率"><a href="#差分结合增长率" class="headerlink" title="差分结合增长率"></a>差分结合增长率</h2><p>在一阶差分的基础上增加增长率这个特征</p>
<p><img src="/images/gzdiff.png" class="lazyload" data-srcset="/images/gzdiff.png" srcset="data:image/png;base64,666" alt="gzdiff"></p>
<h3 id="超参数-8"><a href="#超参数-8" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 2              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-7"><a href="#模型定义-7" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br></pre></td></tr></table></figure>

<h3 id="验证损失-6"><a href="#验证损失-6" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 8.446127437506554e-05</span><br><span class="line">elapsed time: 2.3685760498046875 (s)</span><br><span class="line">Train Score: 1787.02 RMSE</span><br><span class="line">Valid Score: 1532.42 RMSE</span><br><span class="line">Test Score: 901.20 RMSE</span><br><span class="line"></span><br><span class="line"># 从误差结果可以看出，这个和一阶差分的结果相差无几</span><br><span class="line"># 但是从拟合图上看，拟合值出现了负数的情况，这是增长率带来的结果</span><br><span class="line"># 所以可以通过预测增长率，再结合一阶差分看看</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/loss13.png" class="lazyload" data-srcset="/images/loss13.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred13.png" class="lazyload" data-srcset="/images/pred13.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h3 id="预测增长率-1"><a href="#预测增长率-1" class="headerlink" title="预测增长率"></a>预测增长率</h3><p>预测增长率，再结合一阶差分，这个和上面的不同之处在于使用增长率作为目标值。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.007926768652017368</span><br><span class="line">elapsed time: 1.7802140712738037 (s)</span><br><span class="line">Train Score: 1600.33 RMSE</span><br><span class="line">Valid Score: 1325.91 RMSE</span><br><span class="line">Test Score: 769.42 RMSE</span><br><span class="line"></span><br><span class="line"># 这个结果和单纯预测增长率的结果又是相差无几，差不差分都无所谓了。</span><br><span class="line"># 总结：一阶差分和预测增长率是二选一的结果，二者都能达到较好的优化，预测增长率更优一些。</span><br></pre></td></tr></table></figure>

<p><img src="/images/loss14.png" class="lazyload" data-srcset="/images/loss14.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred14.png" class="lazyload" data-srcset="/images/pred14.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="Bidirectional-LSTM"><a href="#Bidirectional-LSTM" class="headerlink" title="Bidirectional LSTM"></a>Bidirectional LSTM</h2><blockquote>
<p>On some sequence prediction problems, it can be beneficial to allow the LSTM model to learn the input sequence both forward and backwards and concatenate both interpretations.<br>This is called a <a href="https://machinelearningmastery.com/develop-bidirectional-lstm-sequence-classification-python-keras/"><strong>Bidirectional LSTM</strong></a>.<br>We can implement a Bidirectional LSTM for univariate time series forecasting by wrapping the first hidden layer in a wrapper layer called Bidirectional.</p>
</blockquote>
<h3 id="超参数-9"><a href="#超参数-9" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 1              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-8"><a href="#模型定义-8" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(Bidirectional(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>), input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="验证损失-7"><a href="#验证损失-7" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.0002106719806980023</span><br><span class="line">elapsed time: 2.6818039417266846 (s)</span><br><span class="line">Train Score: 1946.72 RMSE</span><br><span class="line">Valid Score: 1615.40 RMSE</span><br><span class="line">Test Score: 823.85 RMSE</span><br><span class="line"></span><br><span class="line"># Bidirectional LSTM 具有明显改善效果，这个可以结合一阶差分或者预测增长率使用。</span><br></pre></td></tr></table></figure>

<p><img src="/images/loss15.png" class="lazyload" data-srcset="/images/loss15.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred15.png" class="lazyload" data-srcset="/images/pred15.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="CNN-LSTM"><a href="#CNN-LSTM" class="headerlink" title="CNN LSTM"></a>CNN LSTM</h2><blockquote>
<p>A convolutional neural network, or CNN for short, is a type of neural network developed for working with two-dimensional image data.<br>The CNN can be very effective at automatically extracting and learning features from one-dimensional sequence data such as univariate time series data.<br>A CNN model can be used in a hybrid model with an LSTM backend where the CNN is used to interpret subsequences of input that together are provided as a sequence to an LSTM model to interpret. <a href="https://machinelearningmastery.com/cnn-long-short-term-memory-networks/">This hybrid model is called a CNN-LSTM</a>.</p>
</blockquote>
<h3 id="超参数-10"><a href="#超参数-10" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 1              # 最终输出维度</span><br><span class="line">timesteps = 4             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-9"><a href="#模型定义-9" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(TimeDistributed(Conv1D(filters=units, kernel_size=<span class="number">1</span>, activation=<span class="string">&#x27;tanh&#x27;</span>), input_shape=(<span class="literal">None</span>, timesteps//<span class="number">2</span>, features)))</span><br><span class="line">model.add(TimeDistributed(MaxPooling1D(pool_size=<span class="number">2</span>)))</span><br><span class="line">model.add(TimeDistributed(Flatten()))</span><br><span class="line">model.add(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="验证损失-8"><a href="#验证损失-8" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.00021777707989074557</span><br><span class="line">elapsed time: 2.1609442234039307 (s)</span><br><span class="line">Train Score: 2035.46 RMSE</span><br><span class="line">Valid Score: 1642.41 RMSE</span><br><span class="line">Test Score: 851.72 RMSE</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/loss16.png" class="lazyload" data-srcset="/images/loss16.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred16.png" class="lazyload" data-srcset="/images/pred16.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="ConvLSTM"><a href="#ConvLSTM" class="headerlink" title="ConvLSTM"></a>ConvLSTM</h2><blockquote>
<p>A type of LSTM related to the CNN-LSTM is the ConvLSTM, where the convolutional reading of input is built directly into each LSTM unit.<br>The ConvLSTM was developed for reading two-dimensional spatial-temporal data, but can be adapted for use with univariate time series forecasting.</p>
</blockquote>
<h3 id="超参数-11"><a href="#超参数-11" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 1              # 最终输出维度</span><br><span class="line">timesteps = 4             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-10"><a href="#模型定义-10" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(ConvLSTM2D(filters=units, kernel_size=(<span class="number">1</span>,<span class="number">2</span>), activation=<span class="string">&#x27;tanh&#x27;</span>, input_shape=(timesteps//<span class="number">2</span>, <span class="number">1</span>, timesteps//<span class="number">2</span>, features)))</span><br><span class="line">model.add(Flatten())</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="验证损失-9"><a href="#验证损失-9" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.00022352560738618104</span><br><span class="line">elapsed time: 3.2140681743621826 (s)</span><br><span class="line">Train Score: 2092.71 RMSE</span><br><span class="line">Valid Score: 1663.95 RMSE</span><br><span class="line">Test Score: 844.92 RMSE</span><br><span class="line"></span><br><span class="line"># 三种模型相较于原始的单层 stateless LSTM 模型都具有改善效果</span><br><span class="line"># Bidirectional LSTM 略好一点</span><br></pre></td></tr></table></figure>

<p><img src="/images/loss17.png" class="lazyload" data-srcset="/images/loss17.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred17.png" class="lazyload" data-srcset="/images/pred17.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="优化方案"><a href="#优化方案" class="headerlink" title="优化方案"></a>优化方案</h2><p>Stateless LSTM or Bidirectional LSTM or CNN LSTM or ConvLSTM</p>
<p>一阶差分 or 预测增长率</p>
<p>本次实验使用颜色标记的方案</p>
<h3 id="超参数-12"><a href="#超参数-12" class="headerlink" title="超参数"></a>超参数</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># 定义超参数</span><br><span class="line">batch_size = 128          # 批数据大小</span><br><span class="line">epochs = 50               # 实验训练次数</span><br><span class="line">units = 64                # 状态的输出维度</span><br><span class="line">features = 1              # 最终输出维度</span><br><span class="line">timesteps = 3             # 时间步长</span><br><span class="line">feature_range = (0, 1)    # 归一化值域</span><br><span class="line">ratio = 0.8               # 数据集分割比例</span><br></pre></td></tr></table></figure>

<h3 id="模型定义-11"><a href="#模型定义-11" class="headerlink" title="模型定义"></a>模型定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模型</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(Bidirectional(LSTM(units=units, activation=<span class="string">&#x27;tanh&#x27;</span>), input_shape=(timesteps, features)))</span><br><span class="line">model.add(Dense(<span class="number">1</span>))</span><br><span class="line">model.summary()</span><br><span class="line">callbacks = [</span><br><span class="line">    keras.callbacks.EarlyStopping(monitor=<span class="string">&#x27;val_loss&#x27;</span>, patience=<span class="number">2</span>),</span><br><span class="line">    keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;model.h5&#x27;</span>, monitor=<span class="string">&#x27;val_loss&#x27;</span>, save_best_only=<span class="literal">True</span>),</span><br><span class="line">    keras.callbacks.ReduceLROnPlateau(monitor=<span class="string">&#x27;val_loss&#x27;</span>, factor=<span class="number">0.01</span>, patience=<span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">model.<span class="built_in">compile</span>(loss=<span class="string">&#x27;mse&#x27;</span>, optimizer=<span class="string">&#x27;adam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练</span></span><br><span class="line">history = model.fit(x_train, y_train, batch_size=batch_size, epochs=epochs, verbose=<span class="number">1</span>, validation_data=(x_valid, y_valid), shuffle=<span class="literal">False</span>, callbacks=callbacks)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="验证损失-10"><a href="#验证损失-10" class="headerlink" title="验证损失"></a>验证损失</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.00794555525360681</span><br><span class="line">elapsed time: 2.404299020767212 (s)</span><br><span class="line">Train Score: 1576.97 RMSE</span><br><span class="line">Valid Score: 1307.11 RMSE</span><br><span class="line">Test Score: 758.50 RMSE</span><br><span class="line"></span><br><span class="line"># 可以看出这个方案和预测增长率的方案的结果是一样的，改变为Bidirectional LSTM 结构有略微的好处</span><br><span class="line"># 这种双向循环神经网络的隐藏层保存了两个值，A 参与正向计算， A&#x27; 参与反向计算，最终的输出值 y 取决于 A 和 A&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="看看细节"><a href="#看看细节" class="headerlink" title="看看细节"></a>看看细节</h3><p><img src="/images/detail1.png" class="lazyload" data-srcset="/images/detail1.png" srcset="data:image/png;base64,666" alt="detail1"></p>
<p><img src="/images/detail2.png" class="lazyload" data-srcset="/images/detail2.png" srcset="data:image/png;base64,666" alt="detail2"></p>
<p><img src="/images/detail3.png" class="lazyload" data-srcset="/images/detail3.png" srcset="data:image/png;base64,666" alt="detail3"></p>
<h3 id="成功率"><a href="#成功率" class="headerlink" title="成功率"></a>成功率</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 6.0617386995090114e-09</span><br><span class="line">elapsed time: 3.4173359870910645 (s)</span><br><span class="line">Train Score: 0.05 RMSE</span><br><span class="line">Valid Score: 0.01 RMSE</span><br><span class="line">Test Score: 0.13 RMSE</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/loss18.png" class="lazyload" data-srcset="/images/loss18.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred18_1.png" class="lazyload" data-srcset="/images/pred18_1.png" srcset="data:image/png;base64,666" alt="pred"></p>
<p><img src="/images/pred18_2.png" class="lazyload" data-srcset="/images/pred18_2.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h3 id="响应时间"><a href="#响应时间" class="headerlink" title="响应时间"></a>响应时间</h3><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">validate cost: 0.009244604190229511</span><br><span class="line">elapsed time: 3.7244749069213867 (s)</span><br><span class="line">Train Score: 56.79 RMSE</span><br><span class="line">Valid Score: 14.35 RMSE</span><br><span class="line">Test Score: 77.87 RMSE</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/loss19.png" class="lazyload" data-srcset="/images/loss19.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred19_1.png" class="lazyload" data-srcset="/images/pred19_1.png" srcset="data:image/png;base64,666" alt="pred"></p>
<p><img src="/images/pred19_2.png" class="lazyload" data-srcset="/images/pred19_2.png" srcset="data:image/png;base64,666" alt="pred"></p>
<h2 id="新的问题"><a href="#新的问题" class="headerlink" title="新的问题"></a>新的问题</h2><h3 id="Why-is-my-forecasted-time-series-one-step-behind-the-actual-time-series"><a href="#Why-is-my-forecasted-time-series-one-step-behind-the-actual-time-series" class="headerlink" title="Why is my forecasted time series one step behind the actual time series?"></a><a href="https://machinelearningmastery.com/faq/single-faq/why-is-my-forecasted-time-series-right-behind-the-actual-time-series/"><strong>Why is my forecasted time series one step behind the actual time series?</strong></a></h3><p>Github上有人给出的一种解释是：<a href="https://github.com/currylym/time-series-prediction-learning-record"><strong>这是由于序列存在自相关性</strong></a></p>
<blockquote>
<p>做过时间序列的朋友可能常常会有这样的感受，用了某种算法做出来的测试集的平均绝对误差率或者r2系数都很好，但是把测试集的真实值及预测值画出来对比一下，就会发现t时刻的预测值往往是t-1时刻的真实值，也就是模型倾向于把上一时刻的真实值作为下一时刻的预测值，导致两条曲线存在滞后性，也就是真实值曲线滞后于预测值曲线，就像下图右边所显示的那样。之所以会这样，是因为序列存在自相关性，如一阶自相关指的是当前时刻的值与其自身前一时刻值之间的相关性。因此，如果一个序列存在一阶自相关，模型学到的就是一阶相关性。而消除自相关性的办法就是进行差分运算，也就是我们可以将当前时刻与前一时刻的差值作为我们的回归目标</p>
</blockquote>
<p>简单的说就是特征值X包含了目标值Y，试试改为一阶差分结果作为Y，上面已经试过增长率作为Y了，结果就是误差还好，但是有负数的情况出现。</p>
<h2 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决"></a>如何解决</h2><p>存在预测滞后的现象是因为时间序列本身存在自相关性，因为损失函数是mse，模型倾向于把上一个时刻的值当作下一个时刻的预测值，导致图形画出来看似很好，mse也很小。解决办法是消除时间序列的自相关性，可以进行差分或者分解，分解方法有EMD分解和小波分解法，上面试过差分似乎还是存在预测值滞后的问题，试过使用EMD分解一周的响应时间，性能不好，效率不高，耗时很久，效果还挺好，分解出了27个IMF分量。另外我需要证明LSTM在预测非平稳时间序列，也就是不存在自相关性的时间序列上，不存在预测值滞后的问题，我想最简单的就是构造一个一正一负的时间序列，如果LSTM模型总是拿上一个时刻的值当作下一个时刻的预测值，那么这个模型预测可以说总是错的，如果结果还好，不存在滞后问题，那么就可以使用EMD分解法来逐个预测，最后综合各个的预测结果，还有一个问题是EMD分解性能的问题，可能需要再找一个效率更高的包，可能存在也可能不存在。如果顺利的话，最后预测也是个问题，既然分解了，那么预测的时候怎么预测？</p>
<p><a href="https://www.jianshu.com/p/5e82c162f3f4">基于EMD分解与LSTM的空气质量预测</a></p>
<p>我构造了一正一负的时间序列</p>
<p>正：100～150</p>
<p>负：-150～-100</p>
<p><img src="/images/gzyanz.png" class="lazyload" data-srcset="/images/gzyanz.png" srcset="data:image/png;base64,666" alt="gzyanz"></p>
<p>拟合结果</p>
<p><img src="/images/loss20.png" class="lazyload" data-srcset="/images/loss20.png" srcset="data:image/png;base64,666" alt="loss"></p>
<p><img src="/images/pred20_1.png" class="lazyload" data-srcset="/images/pred20_1.png" srcset="data:image/png;base64,666" alt="pred"></p>
<p>再拉清楚点看看</p>
<p><img src="/images/pred20_2.png" class="lazyload" data-srcset="/images/pred20_2.png" srcset="data:image/png;base64,666" alt="pred"></p>
<p><img src="/images/pred20_3.png" class="lazyload" data-srcset="/images/pred20_3.png" srcset="data:image/png;base64,666" alt="pred"></p>
<p><img src="/images/pred20_4.png" class="lazyload" data-srcset="/images/pred20_4.png" srcset="data:image/png;base64,666" alt="pred"></p>
<p>完全重合，没有错位，没有滞后。是不是说明在平稳的非自相关性的时间序列上就不会有预测值滞后的问题，而并非特征构造的问题，因为LSTM本身就是利用过去的值来预测未来的值，要不然有个timesteps参数作何说明。</p>
]]></content>
      <tags>
        <tag>LSTM</tag>
      </tags>
  </entry>
  <entry>
    <title>Flask v0.1 源码阅读</title>
    <url>/2018/09/27/understand-flask-v01/</url>
    <content><![CDATA[<p><a href="https://github.com/pallets/flask/tree/0.1">flask v0.1</a> 是第一个发布的版本，单文件版，v0.4 是 flask 的最后一个单文件版本，文章中 flask 的源码有修改，因为依赖包有更新。</p>
<a id="more"></a>

<!-- toc -->

<h2 id="导包部分"><a href="#导包部分" class="headerlink" title="导包部分"></a>导包部分</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># python2.5 版本加入 with 语句，低于 2.5 需要引入，高于则忽略。</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> with_statement</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 没有用到</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> local</span><br><span class="line"></span><br><span class="line"><span class="comment"># jinja2 模板引擎</span></span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Environment, PackageLoader, FileSystemLoader</span><br><span class="line"></span><br><span class="line"><span class="comment"># Flask 的 Request 和 Response 继承自 werkzeug 的 Request 和 Response</span></span><br><span class="line"><span class="keyword">from</span> werkzeug.wrappers <span class="keyword">import</span> Request <span class="keyword">as</span> RequestBase, Response <span class="keyword">as</span> ResponseBase</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最后几行 _request_ctx_stack, current_app, request, session, g 用到。</span></span><br><span class="line"><span class="keyword">from</span> werkzeug.local <span class="keyword">import</span> LocalStack, LocalProxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于测试请求上下文，在 Flask 类的方法 test_request_context 中调用，已失效。</span></span><br><span class="line"><span class="comment"># 最新版 test_request_context 方法调用 flask.testing 的 make_test_environ_builder，最终调用 werkzeug.test 的 EnvironBuilder。</span></span><br><span class="line"><span class="keyword">from</span> werkzeug <span class="keyword">import</span> create_environ</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> cached_property</span><br><span class="line"><span class="keyword">from</span> werkzeug.wsgi <span class="keyword">import</span> SharedDataMiddleware</span><br><span class="line"></span><br><span class="line"><span class="comment"># 路由</span></span><br><span class="line"><span class="keyword">from</span> werkzeug.routing <span class="keyword">import</span> Map, Rule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 错误处理</span></span><br><span class="line"><span class="keyword">from</span> werkzeug.exceptions <span class="keyword">import</span> HTTPException, InternalServerError</span><br><span class="line"></span><br><span class="line"><span class="comment"># flask 自带的 session 用到</span></span><br><span class="line"><span class="keyword">from</span> werkzeug.contrib.securecookie <span class="keyword">import</span> SecureCookie</span><br><span class="line"></span><br><span class="line"><span class="comment"># 没有用到，作为对外接口</span></span><br><span class="line"><span class="keyword">from</span> werkzeug <span class="keyword">import</span> abort, redirect</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Markup, escape</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于获取应用程序根目录</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> pkg_resources</span><br><span class="line">    pkg_resources.resource_stream</span><br><span class="line"><span class="keyword">except</span> (ImportError, AttributeError):</span><br><span class="line">    pkg_resources = <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Request-和-Response"><a href="#Request-和-Response" class="headerlink" title="Request 和 Response"></a><code>Request</code> 和 <code>Response</code></h2><p><code>flask</code> 的 <code>Request</code> 和 <code>Response</code> 继承自 <code>werkzeug</code> 的 <code>Request</code> 和 <code>Response</code>。</p>
<p>如果你想要自定义 <code>Request</code> 和 <code>Response</code>，你可以继承这两个类，然后指定 <code>Flask</code> 的 <code>request_class</code> 和 <code>response_class</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>(<span class="params">RequestBase</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;请求类&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, environ</span>):</span></span><br><span class="line">        RequestBase.__init__(self, environ)  <span class="comment"># WSGI 环境</span></span><br><span class="line">        self.endpoint = <span class="literal">None</span>  <span class="comment"># 视图函数的键名</span></span><br><span class="line">        self.view_args = <span class="literal">None</span>  <span class="comment"># 视图函数的参数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span>(<span class="params">ResponseBase</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;响应类&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    default_mimetype = <span class="string">&#x27;text/html&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_RequestGlobals</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_RequestContext</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;请求上下文&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, app, environ</span>):</span></span><br><span class="line">        self.app = app</span><br><span class="line">        self.url_adapter = app.url_map.bind_to_environ(environ)</span><br><span class="line">        self.request = app.request_class(environ)</span><br><span class="line">        self.session = app.open_session(self.request)  <span class="comment"># 带上下文的 session</span></span><br><span class="line">        self.g = _RequestGlobals()  <span class="comment"># 带上下文的 g</span></span><br><span class="line">        self.flashes = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        _request_ctx_stack.push(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_value, tb</span>):</span></span><br><span class="line">        <span class="keyword">if</span> tb <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> self.app.debug:</span><br><span class="line">            _request_ctx_stack.pop()</span><br></pre></td></tr></table></figure>

<h2 id="几个有用的函数"><a href="#几个有用的函数" class="headerlink" title="几个有用的函数"></a>几个有用的函数</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">url_for</span>(<span class="params">endpoint, **values</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;函数跳转</span></span><br><span class="line"><span class="string">    endpoint: Flask 类有个 view_functions 字典，存储的就是 endpoint 和 视图函数的映射关系，默认 endpoint 是视图函数的名字</span></span><br><span class="line"><span class="string">    values: 路由传过来的参数</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> _request_ctx_stack.top.url_adapter.build(endpoint, values)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flash</span>(<span class="params">message</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    消息闪现，存储在 session 中，是个列表</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    session[<span class="string">&#x27;_flashes&#x27;</span>] = (session.get(<span class="string">&#x27;_flashes&#x27;</span>, [])) + [message]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flashed_messages</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    把 session 中存储的消息全部 pop 出来并返回</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    flashes = _request_ctx_stack.top.flashes</span><br><span class="line">    <span class="keyword">if</span> flashes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        _request_ctx_stack.top.flashes = flashes = \</span><br><span class="line">            session.pop(<span class="string">&#x27;_flashes&#x27;</span>, [])</span><br><span class="line">    <span class="keyword">return</span> flashes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_template</span>(<span class="params">template_name, **context</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从文件渲染模板</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    current_app.update_template_context(context)</span><br><span class="line">    <span class="keyword">return</span> current_app.jinja_env.get_template(template_name).render(context)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_template_string</span>(<span class="params">source, **context</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从字符串渲染模板</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    current_app.update_template_context(context)</span><br><span class="line">    <span class="keyword">return</span> current_app.jinja_env.from_string(source).render(context)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_default_template_ctx_processor</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    模板处理，使得在所有模板中可以使用 request, session 和 g 三个全局变量</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    reqctx = _request_ctx_stack.top</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(</span><br><span class="line">        request=reqctx.request,</span><br><span class="line">        session=reqctx.session,</span><br><span class="line">        g=reqctx.g</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_package_path</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;根据名字获取模块的路径&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> os.path.abspath(os.path.dirname(sys.modules[name].__file__))</span><br><span class="line">    <span class="keyword">except</span> (KeyError, AttributeError):</span><br><span class="line">        <span class="keyword">return</span> os.getcwd()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Flask-类"><a href="#Flask-类" class="headerlink" title="Flask 类"></a><code>Flask</code> 类</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Flask 类实现了一个 WSGI 应用，只要将包或者模块的名字传递给它</span></span><br><span class="line"><span class="string">    一旦创建的时候，它将首先注册视图函数、路由映射、模板配置等等几个重要的对象</span></span><br><span class="line"><span class="string">    传入包的名字是用于解决应用内部资源的引用，具体请查看 open_resource 函数</span></span><br><span class="line"><span class="string">    一般情况下，你只需要这样创建：</span></span><br><span class="line"><span class="string">        from flask import Flask</span></span><br><span class="line"><span class="string">        app = Flask(__name__)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 请求类</span></span><br><span class="line">    request_class = Request</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 响应类</span></span><br><span class="line">    response_class = Response</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 静态文件路径，设置为 None 可以禁用</span></span><br><span class="line">    static_path = <span class="string">&#x27;/static&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 密钥，用于 cookies 签名验证</span></span><br><span class="line">    secret_key = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 基于 cookie 的 session 的名字</span></span><br><span class="line">    session_cookie_name = <span class="string">&#x27;session&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 默认会直接传给 jinja2 的 options 参数值</span></span><br><span class="line">    jinja_options = <span class="built_in">dict</span>(</span><br><span class="line">        autoescape=<span class="literal">True</span>,</span><br><span class="line">        extensions=[<span class="string">&#x27;jinja2.ext.autoescape&#x27;</span>, <span class="string">&#x27;jinja2.ext.with_&#x27;</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, package_name</span>):</span></span><br><span class="line">        <span class="comment"># 调试模式开关，设置 True 以打开调试模式</span></span><br><span class="line">        <span class="comment"># 在调试模式下，应用程序出错会有特殊的错误页面以供调试</span></span><br><span class="line">        <span class="comment"># 并且服务会监控文件的变化，文件发生变化会重载服务</span></span><br><span class="line">        self.debug = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 包或者模块的名字，一旦设置好了就不要改动</span></span><br><span class="line">        self.package_name = package_name</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 应用程序顶级目录</span></span><br><span class="line">        self.root_path = _get_package_path(self.package_name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 包含所有注册好的视图函数字典，键是函数的名字，也用于生成 URL</span></span><br><span class="line">        <span class="comment"># 值就是函数本身，可以用 route 装饰器注册一个函数</span></span><br><span class="line">        self.view_functions = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 所有注册好的错误处理函数，键是错误代码，值是处理函数</span></span><br><span class="line">        <span class="comment"># 可以用 errorhandler 注册一个错误处理函数</span></span><br><span class="line">        self.error_handlers = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 预处理函数，每次请求之前会执行，用 before_request 装饰器注册</span></span><br><span class="line">        self.before_request_funcs = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 后处理函数，每次请求完成以后执行，函数会截获响应并且改变它</span></span><br><span class="line">        <span class="comment"># 用 after_request 装饰器注册</span></span><br><span class="line">        self.after_request_funcs = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 模板上下文处理器，默认有一个处理函数 _default_template_ctx_processor</span></span><br><span class="line">        <span class="comment"># 默认的函数功能是向模板上下文添加三个对象 request, session, g</span></span><br><span class="line">        <span class="comment"># 每个函数执行不需要参数，返回值为字典，用于填充模板上下文</span></span><br><span class="line">        self.template_context_processors = [_default_template_ctx_processor]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 路由映射，在 werkzeug.routing.Map</span></span><br><span class="line">        self.url_map = Map()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 架起一个静态资源服务，一般用于开发环境，生产环境用 nginx</span></span><br><span class="line">        <span class="keyword">if</span> self.static_path <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.url_map.add(Rule(self.static_path + <span class="string">&#x27;/&lt;filename&gt;&#x27;</span>,</span><br><span class="line">                                  build_only=<span class="literal">True</span>, endpoint=<span class="string">&#x27;static&#x27;</span>))</span><br><span class="line">            <span class="keyword">if</span> pkg_resources <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                target = (self.package_name, <span class="string">&#x27;static&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                target = os.path.join(self.root_path, <span class="string">&#x27;static&#x27;</span>)</span><br><span class="line">            self.wsgi_app = SharedDataMiddleware(self.wsgi_app, &#123;</span><br><span class="line">                self.static_path: target</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># jinja2 模板配置，包括模板目录和默认开启的功能</span></span><br><span class="line">        self.jinja_env = Environment(loader=self.create_jinja_loader(),</span><br><span class="line">                                     **self.jinja_options)</span><br><span class="line">        <span class="comment"># 这是两个模板能用到的函数</span></span><br><span class="line">        <span class="comment"># url_for 用于根据 endpoint 获取 URL</span></span><br><span class="line">        <span class="comment"># get_flashed_messages 用于获取消息闪现</span></span><br><span class="line">        self.jinja_env.<span class="built_in">globals</span>.update(</span><br><span class="line">            url_for=url_for,</span><br><span class="line">            get_flashed_messages=get_flashed_messages</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_jinja_loader</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        加载模板目录，默认目录为 templates</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> pkg_resources <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> FileSystemLoader(os.path.join(self.root_path, <span class="string">&#x27;templates&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> PackageLoader(self.package_name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_template_context</span>(<span class="params">self, context</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        为模板上下文注入几个常用的变量，比如 request, session, g</span></span><br><span class="line"><span class="string">        context 为填充模板上下文的字典</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        reqctx = _request_ctx_stack.top</span><br><span class="line">        <span class="keyword">for</span> func <span class="keyword">in</span> self.template_context_processors:</span><br><span class="line">            context.update(func())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">5000</span>, **options</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        运行开发服务器</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">from</span> werkzeug <span class="keyword">import</span> run_simple</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;debug&#x27;</span> <span class="keyword">in</span> options:</span><br><span class="line">            self.debug = options.pop(<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">        options.setdefault(<span class="string">&#x27;use_reloader&#x27;</span>, self.debug)</span><br><span class="line">        options.setdefault(<span class="string">&#x27;use_debugger&#x27;</span>, self.debug)</span><br><span class="line">        <span class="keyword">return</span> run_simple(host, port, self, **options)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_client</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        为应用程序创建一个测试客户端</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">from</span> werkzeug <span class="keyword">import</span> Client</span><br><span class="line">        <span class="keyword">return</span> Client(self, self.response_class, use_cookies=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_resource</span>(<span class="params">self, resource</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        动态加载模块</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> pkg_resources <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">open</span>(os.path.join(self.root_path, resource), <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> pkg_resources.resource_stream(self.package_name, resource)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_session</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        创建一个 session，secret_key 必须设置</span></span><br><span class="line"><span class="string">        基于 werkzeug.contrib.securecookie.SecureCookie</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        key = self.secret_key</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> SecureCookie.load_cookie(request, self.session_cookie_name,</span><br><span class="line">                                            secret_key=key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_session</span>(<span class="params">self, session, response</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        保存 session</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> session <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            session.save_cookie(response, self.session_cookie_name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_url_rule</span>(<span class="params">self, rule, endpoint, **options</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        创建 URL 和视图函数的映射规则，等同于 route 装饰器</span></span><br><span class="line"><span class="string">        只是 add_url_rule 并没有为视图函数注册一个 endpoint</span></span><br><span class="line"><span class="string">        这一步也就是向 view_functions 字典添加 endpoint: view_func 键值对</span></span><br><span class="line"><span class="string">        以下：</span></span><br><span class="line"><span class="string">            @app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="string">            def index():</span></span><br><span class="line"><span class="string">                pass</span></span><br><span class="line"><span class="string">        等同于：</span></span><br><span class="line"><span class="string">            def index():</span></span><br><span class="line"><span class="string">                pass</span></span><br><span class="line"><span class="string">            app.add_url_rule(&#x27;index&#x27;, &#x27;/&#x27;)</span></span><br><span class="line"><span class="string">            app.view_functions[&#x27;index&#x27;] = index</span></span><br><span class="line"><span class="string">        options: 参数选项详见 werkzeug.routing.Rule</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        options[<span class="string">&#x27;endpoint&#x27;</span>] = endpoint</span><br><span class="line">        options.setdefault(<span class="string">&#x27;methods&#x27;</span>, (<span class="string">&#x27;GET&#x27;</span>,))</span><br><span class="line">        self.url_map.add(Rule(rule, **options))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span>(<span class="params">self, rule, **options</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        为给定的 URL 注册一个视图函数</span></span><br><span class="line"><span class="string">        用法：</span></span><br><span class="line"><span class="string">            @app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="string">            def index():</span></span><br><span class="line"><span class="string">                return &#x27;Hello World&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        变量部分可以用尖括号(``/user/&lt;username&gt;``)指定，默认接受任何不带斜杆的字符串</span></span><br><span class="line"><span class="string">        变量也可以指定一个转换器，以指定类型的参数：</span></span><br><span class="line"><span class="string">        =========== ===========================================</span></span><br><span class="line"><span class="string">        int         整数</span></span><br><span class="line"><span class="string">        float       浮点数</span></span><br><span class="line"><span class="string">        path        路径</span></span><br><span class="line"><span class="string">        =========== ===========================================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        值得注意的是 Flask 如何处理结尾的斜杆，核心思路是保证每个 URL 唯一：</span></span><br><span class="line"><span class="string">            1、如果配置了一个带结尾斜杆的 URL，用户请求不带结尾斜杆的这个 URL，则跳转到带结尾斜杆的页面。</span></span><br><span class="line"><span class="string">            2、如果配置了一个不带结尾斜杆的 URL，用户请求带结尾斜杆的这个 URL，则触发404错误。</span></span><br><span class="line"><span class="string">        这和 web 服务器处理静态资源 static 的逻辑是一样的</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        参数：</span></span><br><span class="line"><span class="string">        rule: URL 字符串</span></span><br><span class="line"><span class="string">        methods: 允许的请求方法，是个列表，默认只接受 GET 请求和隐式的 HEAD</span></span><br><span class="line"><span class="string">        subdomain: 指定子域名</span></span><br><span class="line"><span class="string">        strict_slashes: 上述对结尾斜杆处理的开关</span></span><br><span class="line"><span class="string">        options: 参数选项详见 `werkzeug.routing.Rule`</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">f</span>):</span></span><br><span class="line">            self.add_url_rule(rule, f.__name__, **options)</span><br><span class="line">            self.view_functions[f.__name__] = f</span><br><span class="line">            <span class="keyword">return</span> f</span><br><span class="line">        <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">errorhandler</span>(<span class="params">self, code</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        注册一个错误码处理函数</span></span><br><span class="line"><span class="string">        用法：</span></span><br><span class="line"><span class="string">            @app.errorhandler(404)</span></span><br><span class="line"><span class="string">            def page_not_found():</span></span><br><span class="line"><span class="string">                return &#x27;This page does not exist&#x27;, 404</span></span><br><span class="line"><span class="string">        等同于：</span></span><br><span class="line"><span class="string">            def page_not_found():</span></span><br><span class="line"><span class="string">                return &#x27;This page does not exist&#x27;, 404</span></span><br><span class="line"><span class="string">            app.error_handlers[404] = page_not_found</span></span><br><span class="line"><span class="string">        参数：</span></span><br><span class="line"><span class="string">            code: 错误码</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">f</span>):</span></span><br><span class="line">            self.error_handlers[code] = f</span><br><span class="line">            <span class="keyword">return</span> f</span><br><span class="line">        <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">before_request</span>(<span class="params">self, f</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册一个预处理函数&quot;&quot;&quot;</span></span><br><span class="line">        self.before_request_funcs.append(f)</span><br><span class="line">        <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">after_request</span>(<span class="params">self, f</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册一个后处理函数&quot;&quot;&quot;</span></span><br><span class="line">        self.after_request_funcs.append(f)</span><br><span class="line">        <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">context_processor</span>(<span class="params">self, f</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册一个模板上下文处理函数&quot;&quot;&quot;</span></span><br><span class="line">        self.template_context_processors.append(f)</span><br><span class="line">        <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match_request</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        根据当前请求的路由去和url_map匹配，拿到 enpoint 和 view_args</span></span><br><span class="line"><span class="string">        endpoint: 端点，是 view_functions 中对应视图函数的key</span></span><br><span class="line"><span class="string">        view_args: 视图函数的参数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        rv = _request_ctx_stack.top.url_adapter.match()</span><br><span class="line">        request.endpoint, request.view_args = rv</span><br><span class="line">        <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        首先调用上面的 match_request 方法拿到 endpoint 和 view_args</span></span><br><span class="line"><span class="string">        根据 endpoint 可以从 view_functions 找到对应的视图函数</span></span><br><span class="line"><span class="string">        再传入视图函数的参数 view_args，并返回结果，这个结果只是函数的返回值</span></span><br><span class="line"><span class="string">        并没有包装成响应类 response_class，可以调用 make_response 方法生成响应</span></span><br><span class="line"><span class="string">        如果函数执行失败，则根据错误码调用对应的错误处理函数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            endpoint, values = self.match_request()</span><br><span class="line">            <span class="keyword">return</span> self.view_functions[endpoint](**values)</span><br><span class="line">        <span class="keyword">except</span> HTTPException, e:</span><br><span class="line">            handler = self.error_handlers.get(e.code)</span><br><span class="line">            <span class="keyword">if</span> handler <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> e</span><br><span class="line">            <span class="keyword">return</span> handler(e)</span><br><span class="line">        <span class="keyword">except</span> Exception, e:</span><br><span class="line">            handler = self.error_handlers.get(<span class="number">500</span>)</span><br><span class="line">            <span class="keyword">if</span> self.debug <span class="keyword">or</span> handler <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">            <span class="keyword">return</span> handler(e)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_response</span>(<span class="params">self, rv</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将视图函数的返回值包装成一个真实的响应类 response_class</span></span><br><span class="line"><span class="string">        函数的返回值支持以下几种类型：</span></span><br><span class="line"><span class="string">        ======================= ===========================================</span></span><br><span class="line"><span class="string">        response_class:         响应类本身，原样返回</span></span><br><span class="line"><span class="string">        str:                    字符串，创建相应类并返回</span></span><br><span class="line"><span class="string">        unicode:                unicode 编码，utf-8编码后创建相应类并返回</span></span><br><span class="line"><span class="string">        tuple:                  元组，解包元组传入参数创建响应类并返回</span></span><br><span class="line"><span class="string">        a WSGI function:        WSGI 函数</span></span><br><span class="line"><span class="string">        ======================= ===========================================</span></span><br><span class="line"><span class="string">        参数：</span></span><br><span class="line"><span class="string">        rv: 视图函数的返回值</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(rv, self.response_class):</span><br><span class="line">            <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">        <span class="comment"># basestring 是 str 和 unicode 的超类，只支持 python2</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(rv, basestring):</span><br><span class="line">            <span class="keyword">return</span> self.response_class(rv)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(rv, <span class="built_in">tuple</span>):</span><br><span class="line">            <span class="keyword">return</span> self.response_class(*rv)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.response_class.force_type(rv, request.environ)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">preprocess_request</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        在分发请求之前执行所有的预处理函数，如果预处理函数有返回值不为 None</span></span><br><span class="line"><span class="string">        则返回结果并中断其余的预处理</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> func <span class="keyword">in</span> self.before_request_funcs:</span><br><span class="line">            rv = func()</span><br><span class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        依次传入响应并执行所有的后处理函数，返回新的响应</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        session = _request_ctx_stack.top.session</span><br><span class="line">        <span class="keyword">if</span> session <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 保存 `session`</span></span><br><span class="line">            self.save_session(session, response)</span><br><span class="line">        <span class="keyword">for</span> handler <span class="keyword">in</span> self.after_request_funcs:</span><br><span class="line">            response = handler(response)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        WSGI 应用，可以用中间件包装：</span></span><br><span class="line"><span class="string">            app.wsgi_app = MyMiddleware(app.wsgi_app)</span></span><br><span class="line"><span class="string">        参数：</span></span><br><span class="line"><span class="string">        environ: WSGI 环境，是一个字典，包含了所有请求的信息</span></span><br><span class="line"><span class="string">        start_response: 回调函数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.request_context(environ):</span><br><span class="line">            rv = self.preprocess_request()</span><br><span class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                rv = self.dispatch_request()</span><br><span class="line">            response = self.make_response(rv)</span><br><span class="line">            response = self.process_response(response)</span><br><span class="line">            <span class="keyword">return</span> response(environ, start_response)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request_context</span>(<span class="params">self, environ</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        通过给定的 WSGI 环境创建一个请求上下文，并把它绑定到当前上下文中</span></span><br><span class="line"><span class="string">        必须通过 with 语句使用，因为 request 对象只在请求上下文</span></span><br><span class="line"><span class="string">        也就是 with 语句块中起作用</span></span><br><span class="line"><span class="string">        用法如下：</span></span><br><span class="line"><span class="string">            with app.request_context(environ):</span></span><br><span class="line"><span class="string">                do_something_with(request)</span></span><br><span class="line"><span class="string">        参数：</span></span><br><span class="line"><span class="string">        environ: WSGI 环境</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> _RequestContext(self, environ)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_request_context</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        测试请求上下文，参数详见 werkzeug.create_environ</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.request_context(create_environ(*args, **kwargs))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;调用 wsgi_app 方法&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.wsgi_app(environ, start_response)</span><br></pre></td></tr></table></figure>

<h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">_request_ctx_stack = LocalStack()</span><br><span class="line">current_app = LocalProxy(<span class="keyword">lambda</span>: _request_ctx_stack.top.app)</span><br><span class="line">request = LocalProxy(<span class="keyword">lambda</span>: _request_ctx_stack.top.request)</span><br><span class="line">session = LocalProxy(<span class="keyword">lambda</span>: _request_ctx_stack.top.session)</span><br><span class="line">g = LocalProxy(<span class="keyword">lambda</span>: _request_ctx_stack.top.g)</span><br></pre></td></tr></table></figure>

<h2 id="werkzeug-的-Local，LocalStack-和-LocalProxy"><a href="#werkzeug-的-Local，LocalStack-和-LocalProxy" class="headerlink" title="werkzeug 的 Local，LocalStack 和 LocalProxy"></a><code>werkzeug</code> 的 <code>Local</code>，<code>LocalStack</code> 和 <code>LocalProxy</code></h2><p><code>Flask</code> 中有两个上下文（<code>Context</code>）：</p>
<ol>
<li>应用上下文（<code>App Context</code>）</li>
<li>请求上下文（<code>Request Context</code>）</li>
</ol>
<p>上下文就是函数运行时所需要的外部变量，当我们运行一个简单的求和函数 <code>sum</code> 是不需要外部变量的，而像 <code>Flask</code> 中的视图函数运行需要知道当前的请求的路由、表单和请求方法等等一些信息。</p>
<p><code>Django</code> 和 <code>Tornado</code> 把视图函数所需要的外部信息封装成一个对象 <code>Request</code>，并把这个对象当作参数传给视图函数，无论视图函数有没有用到，所以编写 <code>Django</code> 的视图函数会到处都见到一个 <code>request</code> 参数。</p>
<p>而 <code>Flask</code> 则使用了类似 <code>Thread Local</code> 的对象，它可以隔离多线程/协程之间的状态，使得多线程/协程像操作一个全局变量一样操作各自的状态而互不影响，原理就是使用当前的线程ID作为命名空间，保存多份字典，每个线程只获取各自线程ID对应的字典。</p>
<p><code>Flask</code> 并没有使用 <code>Python</code> 标准库的 <code>Thread Local</code>，而是用了 <code>werkzeug</code> 实现的 <code>Local</code>。</p>
<p><code>Local</code> 和 <code>threading.local</code> 相似，但是 <code>Local</code> 在 <code>Greenlet</code> 可用的情况下优先使用 <code>getcurrent</code> 获取当前线程ID，用以支持 <code>Gevent</code> 调度。</p>
<p><code>Local</code> 还有一个 <code>__release_local__</code> 方法，用以释放当前线程存储的状态信息。</p>
<p><code>LocalStack</code> 是基于 <code>Local</code> 实现的栈结构，可以入栈（<code>push</code>）、出栈（<code>pop</code>）和获取栈顶对象（<code>top</code>）。</p>
<p><code>LocalProxy</code> 是作为 <code>Local</code> 的一个代理模式，它接受一个 <code>callable</code> 对象，注意参数不是 <code>Local</code> 实例，这个 <code>callable</code> 对象返回的结果才是 <code>Local</code> 实例，所有对于 <code>LocalProxy</code> 对象的操作都会转发到对应的 <code>Local</code>。 上</p>
<p>当 <code>app = Flask(__name__)</code> 实例化一个 <strong>Flask App</strong> 时，<code>App Context</code> 并没有立即被入栈，<code>LocalStack</code> 栈顶元素是空的，返回 <code>None</code> 值，<code>current_app</code>，<code>request</code>，<code>session</code> 和 <code>g</code> 也是 <code>unbound</code> 状态，此时使用这些对象会引发 <code>RuntimeError</code>，解决方法是手动将 <code>app.app_context()</code> 入栈。</p>
<p>当 <code>Flask</code> 应用被 <code>werkzeug</code> 自带的开发服务器或者 <code>gunicorn</code> 用于生产的这类 WSGI 服务器架起的时候，每一个请求进来之前会自动将请求上下文（<code>Request Context</code>）入栈。</p>
<p>应用上下文（<code>App Context</code>）在 flask v0.1 版本的源码中没有，后面版本引入，应用上下文也会自动入栈，后面待看。</p>
<p><code>threading.local</code> 使用：<br><img src="/images/threading-local.png" class="lazyload" data-srcset="/images/threading-local.png" srcset="data:image/png;base64,666" alt="threading.local"></p>
<p><code>Flask</code> 的 <code>App Context</code> 使用：<br><img src="/images/flask-app-context.png" class="lazyload" data-srcset="/images/flask-app-context.png" srcset="data:image/png;base64,666" alt="App Context"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 优先使用 Greenlet 的线程ID</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> greenlet <span class="keyword">import</span> getcurrent <span class="keyword">as</span> get_ident</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">from</span> thread <span class="keyword">import</span> get_ident</span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        <span class="keyword">from</span> _thread <span class="keyword">import</span> get_ident</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Local</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="comment"># 固定属性</span></span><br><span class="line">    __slots__ = (<span class="string">&#x27;__storage__&#x27;</span>, <span class="string">&#x27;__ident_func__&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 数据存储，是一个字典</span></span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__storage__&#x27;</span>, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取当前线程ID的方法</span></span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__ident_func__&#x27;</span>, get_ident)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;以生成器的方式返回字典的所有元素&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(self.__storage__.items())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, proxy</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建一个 LocalProxy&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> LocalProxy(self, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__release_local__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;清空当前线程/协程所保存的数据&quot;&quot;&quot;</span></span><br><span class="line">        self.__storage__.pop(self.__ident_func__(), <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;属性访问&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.__storage__[self.__ident_func__()][name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span>(<span class="params">self, name, value</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;属性设置&quot;&quot;&quot;</span></span><br><span class="line">        ident = self.__ident_func__()</span><br><span class="line">        storage = self.__storage__</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            storage[ident][name] = value</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            storage[ident] = &#123;name: value&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;属性删除&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">del</span> self.__storage__[self.__ident_func__()][name]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalStack</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Local 的栈结构实现</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># Local 实例</span></span><br><span class="line">        self._local = Local()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__release_local__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 释放当前线程的数据</span></span><br><span class="line">        self._local.__release_local__()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get__ident_func__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 返回获取当前线程ID的函数</span></span><br><span class="line">        <span class="keyword">return</span> self._local.__ident_func__</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_set__ident_func__</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="comment"># 设置获取当前线程ID的函数</span></span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self._local, <span class="string">&#x27;__ident_func__&#x27;</span>, value)</span><br><span class="line">    __ident_func__ = <span class="built_in">property</span>(_get__ident_func__, _set__ident_func__)</span><br><span class="line">    <span class="keyword">del</span> _get__ident_func__, _set__ident_func__</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;返回一个 LocalProxy 对象，该对象始终指向 LocalStack 实例的栈顶元素&quot;&quot;&quot;</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_lookup</span>():</span></span><br><span class="line">            rv = self.top</span><br><span class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;object unbound&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> rv</span><br><span class="line">        <span class="keyword">return</span> LocalProxy(_lookup)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;入栈&quot;&quot;&quot;</span></span><br><span class="line">        rv = <span class="built_in">getattr</span>(self._local, <span class="string">&#x27;stack&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self._local.stack = rv = []</span><br><span class="line">        rv.append(obj)</span><br><span class="line">        <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;出栈&quot;&quot;&quot;</span></span><br><span class="line">        stack = <span class="built_in">getattr</span>(self._local, <span class="string">&#x27;stack&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> stack <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(stack) == <span class="number">1</span>:</span><br><span class="line">            release_local(self._local)</span><br><span class="line">            <span class="keyword">return</span> stack[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> stack.pop()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">top</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取栈顶元素&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._local.stack[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">except</span> (AttributeError, IndexError):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@implements_bool</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalProxy</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Local 的代理模式实现，所有对 LocalProxy 对象的操作，包括属性访问、方法调用和二元操作</span></span><br><span class="line"><span class="string">    都会转发到那个 callable 参数返回的 Local 对象上</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    __slots__ = (<span class="string">&#x27;__local&#x27;</span>, <span class="string">&#x27;__dict__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__wrapped__&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, local, name=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="comment"># 把 callable 参数绑定到 __local 属性上</span></span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;_LocalProxy__local&#x27;</span>, local)</span><br><span class="line">        <span class="comment"># 代理名字</span></span><br><span class="line">        <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__name__&#x27;</span>, name)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">callable</span>(local) <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(local, <span class="string">&#x27;__release_local__&#x27;</span>):</span><br><span class="line">            <span class="comment"># 注意这里的参数 local 仅仅是一个 callable 对象</span></span><br><span class="line">            <span class="comment"># 该对象执行返回的结果才是 Local 实例</span></span><br><span class="line">            <span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__wrapped__&#x27;</span>, local)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_current_object</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取当前 Local 实例&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self.__local, <span class="string">&#x27;__release_local__&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> self.__local()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(self.__local, self.__name__)</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;no object bound to %s&#x27;</span> % self.__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__dict__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._get_current_object().__dict__</span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">&#x27;__dict__&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            obj = self._get_current_object()</span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&lt;%s unbound&gt;&#x27;</span> % self.__class__.__name__</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">repr</span>(obj)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bool__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">bool</span>(self._get_current_object())</span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__unicode__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> unicode(self._get_current_object())  <span class="comment"># noqa</span></span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">repr</span>(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__dir__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">dir</span>(self._get_current_object())</span><br><span class="line">        <span class="keyword">except</span> RuntimeError:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&#x27;__members__&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">dir</span>(self._get_current_object())</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(self._get_current_object(), name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span>(<span class="params">self, key, value</span>):</span></span><br><span class="line">        self._get_current_object()[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        <span class="keyword">del</span> self._get_current_object()[key]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 下面的源码省略，LocalProxy 重写了所有的魔法方法</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>外国小说鉴赏辞典</title>
    <url>/2018/11/03/foreign-novel-appreciation-dictionary/</url>
    <content><![CDATA[<p>外国小说鉴赏辞典，从图书馆拍来的目录，纯手码，很累！</p>
<a id="more"></a>

<!-- toc -->

<h2 id="古代至19世纪中期卷"><a href="#古代至19世纪中期卷" class="headerlink" title="古代至19世纪中期卷"></a>古代至19世纪中期卷</h2><table>
<thead>
<tr>
<th>书名</th>
<th>国籍</th>
<th>作者</th>
</tr>
</thead>
<tbody><tr>
<td>阿玛莉亚</td>
<td>阿根廷</td>
<td>马莫尔</td>
</tr>
<tr>
<td>魂归故里</td>
<td>波兰</td>
<td>克拉舍夫斯基</td>
</tr>
<tr>
<td>春香传</td>
<td>朝鲜</td>
<td>佚名</td>
</tr>
<tr>
<td>痴儿西木传</td>
<td>德国</td>
<td>格里美尔斯豪森</td>
</tr>
<tr>
<td><strong>少年维特的烦恼</strong></td>
<td>德国</td>
<td>歌德</td>
</tr>
<tr>
<td><strong>威廉·麦斯特的学习时代</strong></td>
<td>德国</td>
<td>歌德</td>
</tr>
<tr>
<td><strong>亲和力</strong></td>
<td>德国</td>
<td>歌德</td>
</tr>
<tr>
<td><strong>金罐</strong></td>
<td>德国</td>
<td>霍夫曼</td>
</tr>
<tr>
<td><strong>侏儒查赫斯</strong></td>
<td>德国</td>
<td>霍夫曼</td>
</tr>
<tr>
<td><strong>雄猫穆尔的生活观</strong></td>
<td>德国</td>
<td>霍夫曼</td>
</tr>
<tr>
<td>温亭娜</td>
<td>德国</td>
<td>富凯</td>
</tr>
<tr>
<td>彼得·史勒密尔的奇怪故事</td>
<td>德国</td>
<td>沙米索</td>
</tr>
<tr>
<td>茵梦湖</td>
<td>德国</td>
<td>施托姆</td>
</tr>
<tr>
<td><strong>驿站长</strong></td>
<td>俄国</td>
<td>普希金</td>
</tr>
<tr>
<td><strong>黑桃皇后</strong></td>
<td>俄国</td>
<td>普希金</td>
</tr>
<tr>
<td><strong>上尉的女儿</strong></td>
<td>俄国</td>
<td>普希金</td>
</tr>
<tr>
<td>狂人日记</td>
<td>俄国</td>
<td>果戈里</td>
</tr>
<tr>
<td>塔拉斯·布利巴</td>
<td>俄国</td>
<td>果戈里</td>
</tr>
<tr>
<td><strong>外套</strong></td>
<td>俄国</td>
<td>果戈里</td>
</tr>
<tr>
<td><strong>死魂灵</strong></td>
<td>俄国</td>
<td>果戈里</td>
</tr>
<tr>
<td>谁之罪</td>
<td>俄国</td>
<td>赫尔岑</td>
</tr>
<tr>
<td>偷东西的喜鹊</td>
<td>俄国</td>
<td>赫尔岑</td>
</tr>
<tr>
<td>平凡的故事</td>
<td>俄国</td>
<td>冈察洛夫</td>
</tr>
<tr>
<td>当代英雄</td>
<td>俄国</td>
<td>莱蒙托夫</td>
</tr>
<tr>
<td>木木</td>
<td>俄国</td>
<td>屠格涅夫</td>
</tr>
<tr>
<td><strong>白夜</strong></td>
<td>俄国</td>
<td>陀思妥耶夫斯基</td>
</tr>
<tr>
<td><strong>巨人传</strong></td>
<td>法国</td>
<td>拉伯雷</td>
</tr>
<tr>
<td>吉尔·布拉斯</td>
<td>法国</td>
<td>勒萨日</td>
</tr>
<tr>
<td>波斯人信札</td>
<td>法国</td>
<td>孟德斯鸠</td>
</tr>
<tr>
<td>查第格</td>
<td>法国</td>
<td>伏尔泰</td>
</tr>
<tr>
<td>老实人</td>
<td>法国</td>
<td>伏尔泰</td>
</tr>
<tr>
<td>玛农·列斯戈</td>
<td>法国</td>
<td>普莱服神甫</td>
</tr>
<tr>
<td><strong>新爱洛伊丝</strong></td>
<td>法国</td>
<td>卢梭</td>
</tr>
<tr>
<td>爱弥儿</td>
<td>法国</td>
<td>卢梭</td>
</tr>
<tr>
<td>拉摩的侄子</td>
<td>法国</td>
<td>狄德罗</td>
</tr>
<tr>
<td>定命论者雅克和他的主人</td>
<td>法国</td>
<td>狄德罗</td>
</tr>
<tr>
<td>阿达拉</td>
<td>法国</td>
<td>夏多布里昂</td>
</tr>
<tr>
<td><strong>阿尔芒丝</strong></td>
<td>法国</td>
<td>司汤达</td>
</tr>
<tr>
<td><strong>红与黑</strong></td>
<td>法国</td>
<td>司汤达</td>
</tr>
<tr>
<td><strong>巴马修道院</strong></td>
<td>法国</td>
<td>司汤达</td>
</tr>
<tr>
<td><strong>驴皮记</strong></td>
<td>法国</td>
<td>巴尔扎克</td>
</tr>
<tr>
<td><strong>欧也妮·葛朗台</strong></td>
<td>法国</td>
<td>巴尔扎克</td>
</tr>
<tr>
<td><strong>高老头</strong></td>
<td>法国</td>
<td>巴尔扎克</td>
</tr>
<tr>
<td><strong>幻灭</strong></td>
<td>法国</td>
<td>巴尔扎克</td>
</tr>
<tr>
<td><strong>邦斯舅舅</strong></td>
<td>法国</td>
<td>巴尔扎克</td>
</tr>
<tr>
<td><strong>三个火枪手</strong></td>
<td>法国</td>
<td>大仲马</td>
</tr>
<tr>
<td><strong>基督山恩仇记</strong></td>
<td>法国</td>
<td>大仲马</td>
</tr>
<tr>
<td><strong>巴黎圣母院</strong></td>
<td>法国</td>
<td>雨果</td>
</tr>
<tr>
<td>高龙巴</td>
<td>法国</td>
<td>梅里美</td>
</tr>
<tr>
<td>嘉尔曼</td>
<td>法国</td>
<td>梅里美</td>
</tr>
<tr>
<td>巴黎的秘密</td>
<td>法国</td>
<td>欧仁·苏</td>
</tr>
<tr>
<td><strong>安吉堡的磨工</strong></td>
<td>法国</td>
<td>乔治·桑</td>
</tr>
<tr>
<td>一个世纪的忏悔</td>
<td>法国</td>
<td>缪塞</td>
</tr>
<tr>
<td>外祖母</td>
<td>捷克</td>
<td>涅姆佐娃</td>
</tr>
<tr>
<td>癞皮鹦鹉</td>
<td>墨西哥</td>
<td>利萨尔迪</td>
</tr>
<tr>
<td>瑞普·凡·温克尔</td>
<td>美国</td>
<td>欧文</td>
</tr>
<tr>
<td>睡谷的传说</td>
<td>美国</td>
<td>欧文</td>
</tr>
<tr>
<td>最后的莫西干人</td>
<td>美国</td>
<td>库柏</td>
</tr>
<tr>
<td>杀鹿人</td>
<td>美国</td>
<td>库柏</td>
</tr>
<tr>
<td>拉帕其尼医生的女儿</td>
<td>美国</td>
<td>霍桑</td>
</tr>
<tr>
<td>红字</td>
<td>美国</td>
<td>霍桑</td>
</tr>
<tr>
<td>七个尖角顶的宅第</td>
<td>美国</td>
<td>霍桑</td>
</tr>
<tr>
<td><strong>黑猫</strong></td>
<td>美国</td>
<td>爱伦·坡</td>
</tr>
<tr>
<td><strong>厄舍府的倒塌</strong></td>
<td>美国</td>
<td>爱伦·坡</td>
</tr>
<tr>
<td><strong>毛格街血案</strong></td>
<td>美国</td>
<td>爱伦·坡</td>
</tr>
<tr>
<td><strong>汤姆叔叔的小屋</strong></td>
<td>美国</td>
<td>斯托夫人</td>
</tr>
<tr>
<td><strong>白鲸</strong></td>
<td>美国</td>
<td>麦尔维尔</td>
</tr>
<tr>
<td>竹取物语</td>
<td>日本</td>
<td>佚名</td>
</tr>
<tr>
<td>源氏物语</td>
<td>日本</td>
<td>紫式部</td>
</tr>
<tr>
<td>平家物语</td>
<td>日本</td>
<td>佚名</td>
</tr>
<tr>
<td>浮世澡堂</td>
<td>日本</td>
<td>式亭三马</td>
</tr>
<tr>
<td>绿衣亨利</td>
<td>瑞士</td>
<td>凯勒</td>
</tr>
<tr>
<td>小癞子</td>
<td>西班牙</td>
<td>佚名</td>
</tr>
<tr>
<td><strong>堂吉诃德</strong></td>
<td>西班牙</td>
<td>塞万提斯</td>
</tr>
<tr>
<td>金驴记</td>
<td>古罗马</td>
<td>阿普列乌斯</td>
</tr>
<tr>
<td><strong>十日谈</strong></td>
<td>意大利</td>
<td>卜伽丘</td>
</tr>
<tr>
<td>太阳城</td>
<td>意大利</td>
<td>康帕内拉</td>
</tr>
<tr>
<td>约婚夫妇</td>
<td>意大利</td>
<td>孟佐尼</td>
</tr>
<tr>
<td><strong>坎特伯雷故事集</strong></td>
<td>英国</td>
<td>乔叟</td>
</tr>
<tr>
<td>天路历程</td>
<td>英国</td>
<td>班扬</td>
</tr>
<tr>
<td><strong>鲁宾逊漂流记</strong></td>
<td>英国</td>
<td>笛福</td>
</tr>
<tr>
<td><strong>格列佛游记</strong></td>
<td>英国</td>
<td>斯威夫特</td>
</tr>
<tr>
<td>帕梅拉</td>
<td>英国</td>
<td>理查森</td>
</tr>
<tr>
<td>大伟人江奈生·魏尔德传</td>
<td>英国</td>
<td>菲尔丁</td>
</tr>
<tr>
<td>汤姆·琼斯</td>
<td>英国</td>
<td>菲尔丁</td>
</tr>
<tr>
<td>感伤的旅程</td>
<td>英国</td>
<td>斯特恩</td>
</tr>
<tr>
<td>蓝登传</td>
<td>英国</td>
<td>斯摩莱特</td>
</tr>
<tr>
<td>威克菲牧师传</td>
<td>英国</td>
<td>哥尔斯密</td>
</tr>
<tr>
<td>爱丁堡监狱</td>
<td>英国</td>
<td>司各特</td>
</tr>
<tr>
<td>艾凡赫</td>
<td>英国</td>
<td>司各特</td>
</tr>
<tr>
<td><strong>理智与情感</strong></td>
<td>英国</td>
<td>奥斯丁</td>
</tr>
<tr>
<td><strong>傲慢与偏见</strong></td>
<td>英国</td>
<td>奥斯丁</td>
</tr>
<tr>
<td><strong>爱玛</strong></td>
<td>英国</td>
<td>奥斯丁</td>
</tr>
<tr>
<td>玛丽·巴顿</td>
<td>英国</td>
<td>盖斯凯尔夫人</td>
</tr>
<tr>
<td><strong>名利场</strong></td>
<td>英国</td>
<td>萨克雷</td>
</tr>
<tr>
<td>钮可谟一家</td>
<td>英国</td>
<td>李敦</td>
</tr>
<tr>
<td><strong>庞贝城的末日</strong></td>
<td>英国</td>
<td>狄更斯</td>
</tr>
<tr>
<td><strong>匹克维克外传</strong></td>
<td>英国</td>
<td>狄更斯</td>
</tr>
<tr>
<td><strong>雾都孤儿</strong></td>
<td>英国</td>
<td>狄更斯</td>
</tr>
<tr>
<td><strong>老古玩店</strong></td>
<td>英国</td>
<td>狄更斯</td>
</tr>
<tr>
<td><strong>大卫·考坡菲</strong></td>
<td>英国</td>
<td>狄更斯</td>
</tr>
<tr>
<td><strong>简·爱</strong></td>
<td>英国</td>
<td>夏洛蒂·勃朗特</td>
</tr>
<tr>
<td><strong>呼啸山庄</strong></td>
<td>英国</td>
<td>艾米莉·勃朗特</td>
</tr>
</tbody></table>
<hr>
<h2 id="19世纪下半期卷"><a href="#19世纪下半期卷" class="headerlink" title="19世纪下半期卷"></a>19世纪下半期卷</h2><table>
<thead>
<tr>
<th>书名</th>
<th>国籍</th>
<th>作者</th>
</tr>
</thead>
<tbody><tr>
<td>为了面包</td>
<td>波兰</td>
<td>显克微支</td>
</tr>
<tr>
<td>火与剑</td>
<td>波兰</td>
<td>显克微支</td>
</tr>
<tr>
<td>洪流</td>
<td>波兰</td>
<td>显克微支</td>
</tr>
<tr>
<td>十字军骑士</td>
<td>波兰</td>
<td>显克微支</td>
</tr>
<tr>
<td>傀儡</td>
<td>波兰</td>
<td>普鲁斯</td>
</tr>
<tr>
<td>福地</td>
<td>波兰</td>
<td>莱蒙特</td>
</tr>
<tr>
<td>三色紫罗兰</td>
<td>德国</td>
<td>史托姆</td>
</tr>
<tr>
<td>白马骑士</td>
<td>德国</td>
<td>史托姆</td>
</tr>
<tr>
<td>艾菲·布里斯特</td>
<td>德国</td>
<td>冯塔纳</td>
</tr>
<tr>
<td>奥勃洛摩夫</td>
<td>俄国</td>
<td>冈察洛夫</td>
</tr>
<tr>
<td>悬崖</td>
<td>俄国</td>
<td>冈察洛夫</td>
</tr>
<tr>
<td>罗亭</td>
<td>俄国</td>
<td>屠格涅夫</td>
</tr>
<tr>
<td>贵族之家</td>
<td>俄国</td>
<td>屠格涅夫</td>
</tr>
<tr>
<td>前夜</td>
<td>俄国</td>
<td>屠格涅夫</td>
</tr>
<tr>
<td>初恋</td>
<td>俄国</td>
<td>屠格涅夫</td>
</tr>
<tr>
<td>父与子</td>
<td>俄国</td>
<td>屠格涅夫</td>
</tr>
<tr>
<td><strong>罪与罚</strong></td>
<td>俄国</td>
<td>陀思妥耶夫斯基</td>
</tr>
<tr>
<td><strong>白痴</strong></td>
<td>俄国</td>
<td>陀思妥耶夫斯基</td>
</tr>
<tr>
<td><strong>群魔</strong></td>
<td>俄国</td>
<td>陀思妥耶夫斯基</td>
</tr>
<tr>
<td><strong>卡拉马佐夫兄弟</strong></td>
<td>俄国</td>
<td>陀思妥耶夫斯基</td>
</tr>
<tr>
<td>怎么办？</td>
<td>俄国</td>
<td>车尔尼雪夫斯基</td>
</tr>
<tr>
<td>琉森</td>
<td>俄国</td>
<td>列夫·托尔斯泰</td>
</tr>
<tr>
<td>哥萨克</td>
<td>俄国</td>
<td>列夫·托尔斯泰</td>
</tr>
<tr>
<td><strong>战争与和平</strong></td>
<td>俄国</td>
<td>列夫·托尔斯泰</td>
</tr>
<tr>
<td><strong>安娜·卡列尼娜</strong></td>
<td>俄国</td>
<td>列夫·托尔斯泰</td>
</tr>
<tr>
<td>伊万·伊利奇之死</td>
<td>俄国</td>
<td>列夫·托尔斯泰</td>
</tr>
<tr>
<td><strong>复活</strong></td>
<td>俄国</td>
<td>列夫·托尔斯泰</td>
</tr>
<tr>
<td>大堂神父</td>
<td>俄国</td>
<td>列斯科夫</td>
</tr>
<tr>
<td>左撇子</td>
<td>俄国</td>
<td>列斯科夫</td>
</tr>
<tr>
<td>盲音乐家</td>
<td>俄国</td>
<td>柯罗连科</td>
</tr>
<tr>
<td>棕榈</td>
<td>俄国</td>
<td>迦尔洵</td>
</tr>
<tr>
<td><strong>变色龙</strong></td>
<td>俄国</td>
<td>契诃夫</td>
</tr>
<tr>
<td><strong>苦恼</strong></td>
<td>俄国</td>
<td>契诃夫</td>
</tr>
<tr>
<td><strong>草原</strong></td>
<td>俄国</td>
<td>契诃夫</td>
</tr>
<tr>
<td><strong>第六病室</strong></td>
<td>俄国</td>
<td>契诃夫</td>
</tr>
<tr>
<td><strong>装在套子里的人</strong></td>
<td>俄国</td>
<td>契诃夫</td>
</tr>
<tr>
<td><strong>悲惨世界</strong></td>
<td>法国</td>
<td>雨果</td>
</tr>
<tr>
<td><strong>海上劳工</strong></td>
<td>法国</td>
<td>雨果</td>
</tr>
<tr>
<td><strong>笑面人</strong></td>
<td>法国</td>
<td>雨果</td>
</tr>
<tr>
<td><strong>九三年</strong></td>
<td>法国</td>
<td>雨果</td>
</tr>
<tr>
<td><strong>包法利夫人</strong></td>
<td>法国</td>
<td>福楼拜</td>
</tr>
<tr>
<td>萨朗波</td>
<td>法国</td>
<td>福楼拜</td>
</tr>
<tr>
<td>情感教育</td>
<td>法国</td>
<td>福楼拜</td>
</tr>
<tr>
<td><strong>格兰特船长的儿女</strong></td>
<td>法国</td>
<td>凡尔纳</td>
</tr>
<tr>
<td>起义者</td>
<td>法国</td>
<td>瓦莱斯</td>
</tr>
<tr>
<td>小酒店</td>
<td>法国</td>
<td>左拉</td>
</tr>
<tr>
<td>萌芽</td>
<td>法国</td>
<td>左拉</td>
</tr>
<tr>
<td>金钱</td>
<td>法国</td>
<td>左拉</td>
</tr>
<tr>
<td>小东西</td>
<td>法国</td>
<td>都德</td>
</tr>
<tr>
<td>最后一课</td>
<td>法国</td>
<td>都德</td>
</tr>
<tr>
<td>苔依丝</td>
<td>法国</td>
<td>法郎士</td>
</tr>
<tr>
<td><strong>羊脂球</strong></td>
<td>法国</td>
<td>莫泊桑</td>
</tr>
<tr>
<td><strong>一生</strong></td>
<td>法国</td>
<td>莫泊桑</td>
</tr>
<tr>
<td><strong>我的叔叔于勒</strong></td>
<td>法国</td>
<td>莫泊桑</td>
</tr>
<tr>
<td><strong>项链</strong></td>
<td>法国</td>
<td>莫泊桑</td>
</tr>
<tr>
<td><strong>漂亮朋友</strong></td>
<td>法国</td>
<td>莫泊桑</td>
</tr>
<tr>
<td>起义者</td>
<td>菲律宾</td>
<td>黎萨尔</td>
</tr>
<tr>
<td>玛丽亚</td>
<td>哥伦比亚</td>
<td>伊萨克斯</td>
</tr>
<tr>
<td>马格斯·哈弗拉尔</td>
<td>荷兰</td>
<td>穆尔塔图里</td>
</tr>
<tr>
<td>野姑娘芭拉</td>
<td>捷克</td>
<td>聂姆佐娃</td>
</tr>
<tr>
<td>庄园内外</td>
<td>捷克</td>
<td>聂姆佐娃</td>
</tr>
<tr>
<td>竞选州长</td>
<td>美国</td>
<td>马克·吐温</td>
</tr>
<tr>
<td><strong>汤姆·索亚历险记</strong></td>
<td>美国</td>
<td>马克·吐温</td>
</tr>
<tr>
<td><strong>王子与贫儿</strong></td>
<td>美国</td>
<td>马克·吐温</td>
</tr>
<tr>
<td>哈克贝里·芬历险记</td>
<td>美国</td>
<td>马克·吐温</td>
</tr>
<tr>
<td>塞拉斯·拉帕姆的发迹</td>
<td>美国</td>
<td>豪威尔斯</td>
</tr>
<tr>
<td>黛西·米勒</td>
<td>美国</td>
<td>詹姆斯</td>
</tr>
<tr>
<td>一位女士的画像</td>
<td>美国</td>
<td>詹姆斯</td>
</tr>
<tr>
<td>嘉莉妹妹</td>
<td>美国</td>
<td>德莱塞</td>
</tr>
<tr>
<td>饥饿</td>
<td>挪威</td>
<td>汉姆生</td>
</tr>
<tr>
<td>阿马罗神父的罪恶</td>
<td>葡萄牙</td>
<td>克罗兹</td>
</tr>
<tr>
<td>舞姬</td>
<td>日本</td>
<td>森鸥外</td>
</tr>
<tr>
<td>浮云</td>
<td>日本</td>
<td>二叶亭四迷</td>
</tr>
<tr>
<td>慈悲心肠</td>
<td>西班牙</td>
<td>佩雷斯·加尔多斯</td>
</tr>
<tr>
<td>庭长夫人</td>
<td>西班牙</td>
<td>克拉林</td>
</tr>
<tr>
<td>金人</td>
<td>匈牙利</td>
<td>约卡伊·莫尔</td>
</tr>
<tr>
<td>圣彼得的伞</td>
<td>匈牙利</td>
<td>米克沙特·卡尔曼</td>
</tr>
<tr>
<td>奇婚记</td>
<td>匈牙利</td>
<td>米克沙特·卡尔曼</td>
</tr>
<tr>
<td><strong>斯巴达克思</strong></td>
<td>意大利</td>
<td>乔万尼奥里</td>
</tr>
<tr>
<td>女乞丐</td>
<td>印度</td>
<td>泰戈尔</td>
</tr>
<tr>
<td>饥饿的石头</td>
<td>印度</td>
<td>泰戈尔</td>
</tr>
<tr>
<td>妻子和女儿</td>
<td>英国</td>
<td>盖斯凯尔夫人</td>
</tr>
<tr>
<td><strong>艰难时世</strong></td>
<td>英国</td>
<td>狄更斯</td>
</tr>
<tr>
<td><strong>双城记</strong></td>
<td>英国</td>
<td>狄更斯</td>
</tr>
<tr>
<td><strong>远大前程</strong></td>
<td>英国</td>
<td>狄更斯</td>
</tr>
<tr>
<td><strong>教师</strong></td>
<td>英国</td>
<td>夏洛蒂·勃朗特</td>
</tr>
<tr>
<td>亚当·贝德</td>
<td>英国</td>
<td>乔治·艾略特</td>
</tr>
<tr>
<td>佛洛斯河磨坊</td>
<td>英国</td>
<td>乔治·艾略特</td>
</tr>
<tr>
<td>织工马南转</td>
<td>英国</td>
<td>乔治·艾略特</td>
</tr>
<tr>
<td>米德尔马契</td>
<td>英国</td>
<td>乔治·艾略特</td>
</tr>
<tr>
<td><strong>远离尘嚣</strong></td>
<td>英国</td>
<td>哈代</td>
</tr>
<tr>
<td><strong>还乡</strong></td>
<td>英国</td>
<td>哈代</td>
</tr>
<tr>
<td><strong>卡斯特桥市长</strong></td>
<td>英国</td>
<td>哈代</td>
</tr>
<tr>
<td><strong>德伯家的苔丝</strong></td>
<td>英国</td>
<td>哈代</td>
</tr>
<tr>
<td><strong>无名的裘德</strong></td>
<td>英国</td>
<td>哈代</td>
</tr>
<tr>
<td>化身博士</td>
<td>英国</td>
<td>斯蒂文森</td>
</tr>
<tr>
<td>诱拐</td>
<td>英国</td>
<td>斯蒂文森</td>
</tr>
<tr>
<td>金银岛</td>
<td>英国</td>
<td>斯蒂文森</td>
</tr>
<tr>
<td><strong>道林·格雷的画像</strong></td>
<td>英国</td>
<td>王尔德</td>
</tr>
<tr>
<td>黑暗的心</td>
<td>英国</td>
<td>康拉德</td>
</tr>
<tr>
<td>吉姆爷</td>
<td>英国</td>
<td>康拉德</td>
</tr>
<tr>
<td>牛虻</td>
<td>英国</td>
<td>伏尼契</td>
</tr>
<tr>
<td>丛林故事</td>
<td>英国</td>
<td>吉卜林</td>
</tr>
<tr>
<td>时间机器</td>
<td>英国</td>
<td>威尔斯</td>
</tr>
<tr>
<td>马丁·里瓦斯</td>
<td>智利</td>
<td>布莱斯特·加纳</td>
</tr>
</tbody></table>
<hr>
<h2 id="20世纪前期卷"><a href="#20世纪前期卷" class="headerlink" title="20世纪前期卷"></a>20世纪前期卷</h2><table>
<thead>
<tr>
<th>书名</th>
<th>国籍</th>
<th>作者</th>
</tr>
</thead>
<tbody><tr>
<td>都柏林人</td>
<td>爱尔兰</td>
<td>乔伊斯</td>
</tr>
<tr>
<td>一个青年艺术家的画像</td>
<td>爱尔兰</td>
<td>乔伊斯</td>
</tr>
<tr>
<td>尤利西斯</td>
<td>爱尔兰</td>
<td>乔伊斯</td>
</tr>
<tr>
<td><strong>一个陌生女人的来信</strong></td>
<td>奥地利</td>
<td>茨威格</td>
</tr>
<tr>
<td><strong>变形记</strong></td>
<td>奥地利</td>
<td>卡夫卡</td>
</tr>
<tr>
<td><strong>饥饿艺术家</strong></td>
<td>奥地利</td>
<td>卡夫卡</td>
</tr>
<tr>
<td><strong>城堡</strong></td>
<td>奥地利</td>
<td>卡夫卡</td>
</tr>
<tr>
<td><strong>地洞</strong></td>
<td>奥地利</td>
<td>卡夫卡</td>
</tr>
<tr>
<td>农民</td>
<td>波兰</td>
<td>莱蒙特</td>
</tr>
<tr>
<td>征服者贝莱</td>
<td>丹麦</td>
<td>尼克索</td>
</tr>
<tr>
<td>垃圾教授</td>
<td>德国</td>
<td>亨利希·曼</td>
</tr>
<tr>
<td>臣仆</td>
<td>德国</td>
<td>亨利希·曼</td>
</tr>
<tr>
<td>布登勃洛克一家</td>
<td>德国</td>
<td>托马斯·曼</td>
</tr>
<tr>
<td>死于威尼斯</td>
<td>德国</td>
<td>托马斯·曼</td>
</tr>
<tr>
<td>魔山</td>
<td>德国</td>
<td>托马斯·曼</td>
</tr>
<tr>
<td>荒原狼</td>
<td>德国</td>
<td>黑塞</td>
</tr>
<tr>
<td>纳尔齐斯与歌尔德蒙</td>
<td>德国</td>
<td>黑塞</td>
</tr>
<tr>
<td>柏林，亚历山大广场</td>
<td>德国</td>
<td>德布林</td>
</tr>
<tr>
<td><strong>西线无战事</strong></td>
<td>德国</td>
<td>雷马克</td>
</tr>
<tr>
<td>《基督与反基督》三部曲</td>
<td>俄国</td>
<td>梅列日科夫斯基</td>
</tr>
<tr>
<td>决斗</td>
<td>俄国</td>
<td>库普林</td>
</tr>
<tr>
<td>石榴石手镯</td>
<td>俄国</td>
<td>库普林</td>
</tr>
<tr>
<td>乡村</td>
<td>俄国</td>
<td>布宁</td>
</tr>
<tr>
<td>阿尔谢尼耶夫的一生</td>
<td>俄国</td>
<td>布宁</td>
</tr>
<tr>
<td>红笑</td>
<td>俄国</td>
<td>安德烈耶夫</td>
</tr>
<tr>
<td>七个被绞死者的故事</td>
<td>俄国</td>
<td>安德烈耶夫</td>
</tr>
<tr>
<td>企鹅岛</td>
<td>法国</td>
<td>法郎士</td>
</tr>
<tr>
<td>诸神渴了</td>
<td>法国</td>
<td>法郎士</td>
</tr>
<tr>
<td><strong>约翰·克里斯朵夫</strong></td>
<td>法国</td>
<td>罗曼·罗兰</td>
</tr>
<tr>
<td>母与子</td>
<td>法国</td>
<td>罗曼·罗兰</td>
</tr>
<tr>
<td>伪币制造者</td>
<td>法国</td>
<td>纪德</td>
</tr>
<tr>
<td><strong>追寻逝去的时光</strong></td>
<td>法国</td>
<td>普鲁斯特</td>
</tr>
<tr>
<td>火线-一个步兵班的日记</td>
<td>法国</td>
<td>巴比塞</td>
</tr>
<tr>
<td>苔蕾丝·德斯盖鲁</td>
<td>法国</td>
<td>莫里亚克</td>
</tr>
<tr>
<td>旋涡</td>
<td>哥伦比亚</td>
<td>里维拉</td>
</tr>
<tr>
<td><strong>好兵帅克</strong></td>
<td>捷克</td>
<td>哈谢克</td>
</tr>
<tr>
<td>折断的翅膀</td>
<td>黎巴嫩</td>
<td>纪伯伦</td>
</tr>
<tr>
<td><strong>麦琪的礼物</strong></td>
<td>美国</td>
<td>欧·亨利</td>
</tr>
<tr>
<td><strong>最后一片叶子</strong></td>
<td>美国</td>
<td>欧·亨利</td>
</tr>
<tr>
<td>章鱼</td>
<td>美国</td>
<td>诺里斯</td>
</tr>
<tr>
<td>珍尼姑娘</td>
<td>美国</td>
<td>德莱塞</td>
</tr>
<tr>
<td>美国悲剧</td>
<td>美国</td>
<td>德莱塞</td>
</tr>
<tr>
<td>啊，拓荒者！</td>
<td>美国</td>
<td>凯瑟</td>
</tr>
<tr>
<td>荒野的呼唤</td>
<td>美国</td>
<td>杰克·伦敦</td>
</tr>
<tr>
<td>小城畸人</td>
<td>美国</td>
<td>杰克·伦敦</td>
</tr>
<tr>
<td><strong>了不起的盖茨比</strong></td>
<td>美国</td>
<td>菲茨杰拉德</td>
</tr>
<tr>
<td>喧哗与骚动</td>
<td>美国</td>
<td>福克纳</td>
</tr>
<tr>
<td>我弥留之际</td>
<td>美国</td>
<td>福克纳</td>
</tr>
<tr>
<td>太阳照常升起</td>
<td>美国</td>
<td>海明威</td>
</tr>
<tr>
<td>永别了，武器</td>
<td>美国</td>
<td>海明威</td>
</tr>
<tr>
<td>情侣</td>
<td>缅甸</td>
<td>詹姆斯拉觉</td>
</tr>
<tr>
<td>劳伦斯之女克里斯丁</td>
<td>挪威</td>
<td>温塞特</td>
</tr>
<tr>
<td><strong>我是猫</strong></td>
<td>日本</td>
<td>夏目漱石</td>
</tr>
<tr>
<td>棉被</td>
<td>日本</td>
<td>田山花袋</td>
</tr>
<tr>
<td>破戒</td>
<td>日本</td>
<td>岛崎藤村</td>
</tr>
<tr>
<td>新珠</td>
<td>日本</td>
<td>菊池宽</td>
</tr>
<tr>
<td>罗生门</td>
<td>日本</td>
<td>芥川龙之介</td>
</tr>
<tr>
<td>橘子</td>
<td>日本</td>
<td>芥川龙之介</td>
</tr>
<tr>
<td>竹林中</td>
<td>日本</td>
<td>芥川龙之介</td>
</tr>
<tr>
<td>太阳</td>
<td>日本</td>
<td>横光利一</td>
</tr>
<tr>
<td>没有太阳的街</td>
<td>日本</td>
<td>德永直</td>
</tr>
<tr>
<td>蟹工船</td>
<td>日本</td>
<td>小林多喜二</td>
</tr>
<tr>
<td>雅考伯·冯·贡腾</td>
<td>瑞士</td>
<td>罗伯特·瓦尔泽</td>
</tr>
<tr>
<td>母亲</td>
<td>苏联</td>
<td>高尔基</td>
</tr>
<tr>
<td>奥库罗夫镇</td>
<td>苏联</td>
<td>高尔基</td>
</tr>
<tr>
<td>阿尔塔莫诺夫家的事业</td>
<td>苏联</td>
<td>高尔基</td>
</tr>
<tr>
<td>彼得堡</td>
<td>苏联</td>
<td>别雷</td>
</tr>
<tr>
<td><strong>我们</strong></td>
<td>苏联</td>
<td>扎米亚京</td>
</tr>
<tr>
<td>孽卵</td>
<td>苏联</td>
<td>布尔加科夫</td>
</tr>
<tr>
<td>狗心</td>
<td>苏联</td>
<td>布尔加科夫</td>
</tr>
<tr>
<td>第四十一</td>
<td>苏联</td>
<td>拉夫列尼约夫</td>
</tr>
<tr>
<td>基坑</td>
<td>苏联</td>
<td>普拉东诺夫</td>
</tr>
<tr>
<td>伊斯坦布尔的姑娘</td>
<td>土耳其</td>
<td>君泰金</td>
</tr>
<tr>
<td>堂娜芭芭拉</td>
<td>委内瑞拉</td>
<td>加列戈斯</td>
</tr>
<tr>
<td>迷雾</td>
<td>西班牙</td>
<td>乌纳穆诺</td>
</tr>
<tr>
<td>碧血黄沙</td>
<td>西班牙</td>
<td>布拉斯科·伊巴涅斯</td>
</tr>
<tr>
<td>孤独者</td>
<td>意大利</td>
<td>皮兰德娄</td>
</tr>
<tr>
<td>坛子</td>
<td>意大利</td>
<td>皮兰德娄</td>
</tr>
<tr>
<td>已故的帕斯卡尔</td>
<td>意大利</td>
<td>皮兰德娄</td>
</tr>
<tr>
<td>沉船</td>
<td>印度</td>
<td>泰戈尔</td>
</tr>
<tr>
<td>戈拉</td>
<td>印度</td>
<td>泰戈尔</td>
</tr>
<tr>
<td>斯里甘特</td>
<td>印度</td>
<td>查特吉</td>
</tr>
<tr>
<td>仁爱道院</td>
<td>印度</td>
<td>普列姆昌德</td>
</tr>
<tr>
<td>半斤小麦</td>
<td>印度</td>
<td>普列姆昌德</td>
</tr>
<tr>
<td>有产业的人</td>
<td>英国</td>
<td>高尔斯华绥</td>
</tr>
<tr>
<td>穿破裤子的慈善家</td>
<td>英国</td>
<td>特莱赛尔</td>
</tr>
<tr>
<td><strong>人生的枷锁</strong></td>
<td>英国</td>
<td>毛姆</td>
</tr>
<tr>
<td>看得见风景房间</td>
<td>英国</td>
<td>福斯特</td>
</tr>
<tr>
<td>印度之行</td>
<td>英国</td>
<td>福斯特</td>
</tr>
<tr>
<td>密林中的村庄</td>
<td>英国</td>
<td>伦纳德·伍尔夫</td>
</tr>
<tr>
<td>达洛卫夫人</td>
<td>英国</td>
<td>弗吉尼亚·伍尔夫</td>
</tr>
<tr>
<td>到灯塔去</td>
<td>英国</td>
<td>弗吉尼亚·伍尔夫</td>
</tr>
<tr>
<td><strong>儿子与情人</strong></td>
<td>英国</td>
<td>劳伦斯</td>
</tr>
<tr>
<td><strong>虹</strong></td>
<td>英国</td>
<td>劳伦斯</td>
</tr>
<tr>
<td>查泰莱夫人的情人</td>
<td>英国</td>
<td>劳伦斯</td>
</tr>
</tbody></table>
<hr>
<h2 id="20世纪中期卷"><a href="#20世纪中期卷" class="headerlink" title="20世纪中期卷"></a>20世纪中期卷</h2><table>
<thead>
<tr>
<th>书名</th>
<th>国籍</th>
<th>作者</th>
</tr>
</thead>
<tbody><tr>
<td>小径分岔的花园</td>
<td>阿根廷</td>
<td>博尔赫斯</td>
</tr>
<tr>
<td>环形废墟</td>
<td>阿根廷</td>
<td>博尔赫斯</td>
</tr>
<tr>
<td>人树</td>
<td>澳大利亚</td>
<td>怀特</td>
</tr>
<tr>
<td>一杯茶</td>
<td>澳大利亚</td>
<td>怀特</td>
</tr>
<tr>
<td><strong>象棋的故事</strong></td>
<td>奥地利</td>
<td>茨威格</td>
</tr>
<tr>
<td>无边的土地</td>
<td>巴西</td>
<td>亚马多</td>
</tr>
<tr>
<td>绿蒂在魏玛</td>
<td>德国</td>
<td>托马斯·曼</td>
</tr>
<tr>
<td>玻璃球游戏</td>
<td>德国</td>
<td>黑塞</td>
</tr>
<tr>
<td>戈雅</td>
<td>德国</td>
<td>福伊希特万格</td>
</tr>
<tr>
<td><strong>凯旋门</strong></td>
<td>德国</td>
<td>雷马克</td>
</tr>
<tr>
<td>第七个十字架</td>
<td>德国</td>
<td>西格斯</td>
</tr>
<tr>
<td>迷惘</td>
<td>德国</td>
<td>卡内蒂</td>
</tr>
<tr>
<td>小丑之见</td>
<td>德国</td>
<td>伯尔</td>
</tr>
<tr>
<td>淡漠的人</td>
<td>德国</td>
<td>伦茨</td>
</tr>
<tr>
<td>铁皮鼓</td>
<td>德国</td>
<td>格拉斯</td>
</tr>
<tr>
<td>猫与鼠</td>
<td>德国</td>
<td>格拉斯</td>
</tr>
<tr>
<td>分裂的天空</td>
<td>德国</td>
<td>沃尔夫</td>
</tr>
<tr>
<td>俄罗斯森林</td>
<td>俄罗斯</td>
<td>列昂诺夫</td>
</tr>
<tr>
<td>伊万·杰尼索维奇的一天</td>
<td>俄罗斯</td>
<td>索尔仁尼琴</td>
</tr>
<tr>
<td>癌病房</td>
<td>俄罗斯</td>
<td>索尔仁尼琴</td>
</tr>
<tr>
<td>蒂博一家</td>
<td>法国</td>
<td>马丁·杜·加尔</td>
</tr>
<tr>
<td>蛇结</td>
<td>法国</td>
<td>莫里亚克</td>
</tr>
<tr>
<td>小王子</td>
<td>法国</td>
<td>圣埃克絮佩里</td>
</tr>
<tr>
<td>人的命运</td>
<td>法国</td>
<td>马尔罗</td>
</tr>
<tr>
<td>法兰西组曲</td>
<td>法国</td>
<td>内米洛夫斯基</td>
</tr>
<tr>
<td>恶心</td>
<td>法国</td>
<td>萨特</td>
</tr>
<tr>
<td>墙</td>
<td>法国</td>
<td>萨特</td>
</tr>
<tr>
<td><strong>局外人</strong></td>
<td>法国</td>
<td>加缪</td>
</tr>
<tr>
<td><strong>鼠疫</strong></td>
<td>法国</td>
<td>加缪</td>
</tr>
<tr>
<td>弗兰德公路</td>
<td>法国</td>
<td>西蒙</td>
</tr>
<tr>
<td>琴声如诉</td>
<td>法国</td>
<td>杜拉斯</td>
</tr>
<tr>
<td>橡皮</td>
<td>法国</td>
<td>罗伯-格里耶</td>
</tr>
<tr>
<td>窥视者</td>
<td>法国</td>
<td>罗伯-格里耶</td>
</tr>
<tr>
<td>变</td>
<td>法国</td>
<td>布托尔</td>
</tr>
<tr>
<td>你好，忧愁</td>
<td>法国</td>
<td>萨冈</td>
</tr>
<tr>
<td>伊萨贝尔在马孔多观雨时的独白</td>
<td>哥伦比亚</td>
<td>马尔克斯</td>
</tr>
<tr>
<td>百年孤独</td>
<td>哥伦比亚</td>
<td>马尔克斯</td>
</tr>
<tr>
<td>消失了的足迹</td>
<td>古巴</td>
<td>卡彭铁尔</td>
</tr>
<tr>
<td>查密莉雅</td>
<td>吉尔吉斯斯坦</td>
<td>艾特玛托夫</td>
</tr>
<tr>
<td>愚人船</td>
<td>美国</td>
<td>波特</td>
</tr>
<tr>
<td>北回归线</td>
<td>美国</td>
<td>米勒</td>
</tr>
<tr>
<td>夜色温柔</td>
<td>美国</td>
<td>菲茨杰拉德</td>
</tr>
<tr>
<td>八月之光</td>
<td>美国</td>
<td>福克纳</td>
</tr>
<tr>
<td>押沙龙，押沙龙！</td>
<td>美国</td>
<td>福克纳</td>
</tr>
<tr>
<td>熊</td>
<td>美国</td>
<td>福克纳</td>
</tr>
<tr>
<td>乞力马扎罗的雪</td>
<td>美国</td>
<td>海明威</td>
</tr>
<tr>
<td><strong>老人与海</strong></td>
<td>美国</td>
<td>海明威</td>
</tr>
<tr>
<td><strong>洛丽塔</strong></td>
<td>美国</td>
<td>博纳科夫</td>
</tr>
<tr>
<td>市场街的斯宾诺莎</td>
<td>美国</td>
<td>辛格</td>
</tr>
<tr>
<td>店员</td>
<td>美国</td>
<td>马拉默德</td>
</tr>
<tr>
<td>魔桶</td>
<td>美国</td>
<td>马拉默德</td>
</tr>
<tr>
<td>赫索格</td>
<td>美国</td>
<td>贝娄</td>
</tr>
<tr>
<td>伤心咖啡馆之歌</td>
<td>美国</td>
<td>麦卡勒斯</td>
</tr>
<tr>
<td>麦田里的守望者</td>
<td>美国</td>
<td>塞林格</td>
</tr>
<tr>
<td>在路上</td>
<td>美国</td>
<td>凯鲁亚克</td>
</tr>
<tr>
<td>五号屠场</td>
<td>美国</td>
<td>冯内古特</td>
</tr>
<tr>
<td><strong>第二十二条军规</strong></td>
<td>美国</td>
<td>海勒</td>
</tr>
<tr>
<td>裸者与死者</td>
<td>美国</td>
<td>梅勒</td>
</tr>
<tr>
<td>好人难寻</td>
<td>美国</td>
<td>奥康纳</td>
</tr>
<tr>
<td>他们</td>
<td>美国</td>
<td>奥茨</td>
</tr>
<tr>
<td>城市与狗</td>
<td>秘鲁</td>
<td>略萨</td>
</tr>
<tr>
<td>最明净的地区</td>
<td>墨西哥</td>
<td>富恩特斯</td>
</tr>
<tr>
<td>诺言</td>
<td>瑞士</td>
<td>迪伦马特</td>
</tr>
<tr>
<td>细雪</td>
<td>日本</td>
<td>谷崎润一郎</td>
</tr>
<tr>
<td>上海</td>
<td>日本</td>
<td>横光利一</td>
</tr>
<tr>
<td>来到农村的文工队</td>
<td>日本</td>
<td>德永直</td>
</tr>
<tr>
<td><strong>雪国</strong></td>
<td>日本</td>
<td>川端康成</td>
</tr>
<tr>
<td>睡美人</td>
<td>日本</td>
<td>川端康成</td>
</tr>
<tr>
<td>“帝国银行事件”之谜</td>
<td>日本</td>
<td>松本清账</td>
</tr>
<tr>
<td>西阵之蝶</td>
<td>日本</td>
<td>水上勉</td>
</tr>
<tr>
<td>骏河夫人</td>
<td>日本</td>
<td>司马辽太郎</td>
</tr>
<tr>
<td>潮骚</td>
<td>日本</td>
<td>三岛由纪夫</td>
</tr>
<tr>
<td>金阁寺</td>
<td>日本</td>
<td>三岛由纪夫</td>
</tr>
<tr>
<td>黑衣</td>
<td>日本</td>
<td>有吉佐和子</td>
</tr>
<tr>
<td>饲育</td>
<td>日本</td>
<td>大江健三郎</td>
</tr>
<tr>
<td>万延元年的足球</td>
<td>日本</td>
<td>大江健三郎</td>
</tr>
<tr>
<td>苦难的历程</td>
<td>苏联</td>
<td>阿列克赛·托尔斯泰</td>
</tr>
<tr>
<td><strong>日瓦戈医生</strong></td>
<td>苏联</td>
<td>帕斯捷尔纳克</td>
</tr>
<tr>
<td><strong>大师和玛格丽特</strong></td>
<td>苏联</td>
<td>布尔加科夫</td>
</tr>
<tr>
<td>静静的顿河</td>
<td>苏联</td>
<td>肖洛霍夫</td>
</tr>
<tr>
<td>一个人的遭遇</td>
<td>苏联</td>
<td>肖洛霍夫</td>
</tr>
<tr>
<td>基督的最后诱惑</td>
<td>希腊</td>
<td>卡赞扎基斯</td>
</tr>
<tr>
<td>房间与街道</td>
<td>意大利</td>
<td>摩拉维亚</td>
</tr>
<tr>
<td>分成两半的子爵</td>
<td>意大利</td>
<td>卡尔维诺</td>
</tr>
<tr>
<td><strong>刀锋</strong></td>
<td>英国</td>
<td>毛姆</td>
</tr>
<tr>
<td>海浪</td>
<td>英国</td>
<td>伍尔夫</td>
</tr>
<tr>
<td>美妙的新世界</td>
<td>英国</td>
<td>赫胥黎</td>
</tr>
<tr>
<td>城堡</td>
<td>英国</td>
<td>克罗宁</td>
</tr>
<tr>
<td><strong>一九八四</strong></td>
<td>英国</td>
<td>奥威尔</td>
</tr>
<tr>
<td>问题的核心</td>
<td>英国</td>
<td>格林</td>
</tr>
<tr>
<td>蝇王</td>
<td>英国</td>
<td>戈尔丁</td>
</tr>
<tr>
<td>发条橙</td>
<td>英国</td>
<td>伯吉斯</td>
</tr>
<tr>
<td>沙堡</td>
<td>英国</td>
<td>默多克</td>
</tr>
<tr>
<td>金色笔记</td>
<td>英国</td>
<td>莱辛</td>
</tr>
<tr>
<td>幸运的吉姆</td>
<td>英国</td>
<td>艾米斯</td>
</tr>
<tr>
<td>法国中尉的女人</td>
<td>英国</td>
<td>福尔斯</td>
</tr>
<tr>
<td>戈丹</td>
<td>印度</td>
<td>普列姆昌德</td>
</tr>
<tr>
<td>黑水洋彼岸</td>
<td>印度</td>
<td>安纳德</td>
</tr>
</tbody></table>
<hr>
<h2 id="20世纪后期卷"><a href="#20世纪后期卷" class="headerlink" title="20世纪后期卷"></a>20世纪后期卷</h2><table>
<thead>
<tr>
<th>书名</th>
<th>国籍</th>
<th>作者</th>
</tr>
</thead>
<tbody><tr>
<td>蜘蛛女之吻</td>
<td>阿根廷</td>
<td>普伊格</td>
</tr>
<tr>
<td>平民史诗</td>
<td>埃及</td>
<td>马哈福兹</td>
</tr>
<tr>
<td>风暴眼</td>
<td>澳大利亚</td>
<td>怀特</td>
</tr>
<tr>
<td>美好的美好的时光</td>
<td>奥地利</td>
<td>耶利内克</td>
</tr>
<tr>
<td>钢琴教师</td>
<td>奥地利</td>
<td>耶利内克</td>
</tr>
<tr>
<td>情欲</td>
<td>奥地利</td>
<td>耶利内克</td>
</tr>
<tr>
<td>浪女回归</td>
<td>巴西</td>
<td>亚马多</td>
</tr>
<tr>
<td>我坐在彼得拉河畔哭泣</td>
<td>巴西</td>
<td>科埃略</td>
</tr>
<tr>
<td>韦罗妮卡决定去死</td>
<td>巴西</td>
<td>科埃略</td>
</tr>
<tr>
<td>方尖碑</td>
<td>白俄罗斯</td>
<td>贝科夫</td>
</tr>
<tr>
<td>战争中没有女性</td>
<td>白俄罗斯</td>
<td>阿列克茜叶维契</td>
</tr>
<tr>
<td>惊马奔逃</td>
<td>德国</td>
<td>瓦尔泽</td>
</tr>
<tr>
<td>我的世纪</td>
<td>德国</td>
<td>格拉斯</td>
</tr>
<tr>
<td>献词</td>
<td>德国</td>
<td>施特劳斯</td>
</tr>
<tr>
<td>香水-一个谋杀犯的故事</td>
<td>德国</td>
<td>聚斯金德</td>
</tr>
<tr>
<td>白比姆黑耳朵</td>
<td>俄罗斯</td>
<td>特罗耶波尔斯基</td>
</tr>
<tr>
<td>一幅画</td>
<td>俄罗斯</td>
<td>格拉宁</td>
</tr>
<tr>
<td>永远十九岁</td>
<td>俄罗斯</td>
<td>巴拉克诺夫</td>
</tr>
<tr>
<td>百慕大三角</td>
<td>俄罗斯</td>
<td>邦达列夫</td>
</tr>
<tr>
<td>鱼王</td>
<td>俄罗斯</td>
<td>阿斯塔菲耶夫</td>
</tr>
<tr>
<td>被取消的演出</td>
<td>俄罗斯</td>
<td>奥库扎瓦</td>
</tr>
<tr>
<td>活下去，并且要记住</td>
<td>俄罗斯</td>
<td>拉斯普京</td>
</tr>
<tr>
<td>告别马焦拉</td>
<td>俄罗斯</td>
<td>拉斯普京</td>
</tr>
<tr>
<td>命运线</td>
<td>俄罗斯</td>
<td>哈里托诺夫</td>
</tr>
<tr>
<td>书市上的斯薇特兰娜</td>
<td>俄罗斯</td>
<td>马卡宁</td>
</tr>
<tr>
<td>美狄娅和她的孩子们</td>
<td>俄罗斯</td>
<td>乌利茨卡娅</td>
</tr>
<tr>
<td>夏伯阳与虚空</td>
<td>俄罗斯</td>
<td>佩列文</td>
</tr>
<tr>
<td>乡间的房子</td>
<td>俄罗斯</td>
<td>瓦尔拉莫夫</td>
</tr>
<tr>
<td>暗店街</td>
<td>法国</td>
<td>莫迪亚诺</td>
</tr>
<tr>
<td>我走了</td>
<td>法国</td>
<td>艾什诺兹</td>
</tr>
<tr>
<td>流浪的星星</td>
<td>法国</td>
<td>克莱齐奥</td>
</tr>
<tr>
<td><strong>霍乱时期的爱情</strong></td>
<td>哥伦比亚</td>
<td>马尔克斯</td>
</tr>
<tr>
<td>乙火</td>
<td>韩国</td>
<td>金东里</td>
</tr>
<tr>
<td>一日长于百年</td>
<td>吉尔吉斯斯坦</td>
<td>艾特玛托夫</td>
</tr>
<tr>
<td>断头台</td>
<td>吉尔吉斯斯坦</td>
<td>艾特玛托夫</td>
</tr>
<tr>
<td>斯通家史札记</td>
<td>加拿大</td>
<td>希尔兹</td>
</tr>
<tr>
<td>笑忘录</td>
<td>捷克</td>
<td>昆拉德</td>
</tr>
<tr>
<td><strong>不能承受的生命之轻</strong></td>
<td>捷克</td>
<td>昆拉德</td>
</tr>
<tr>
<td>冤家，一个爱情故事</td>
<td>美国</td>
<td>辛格</td>
</tr>
<tr>
<td>童爱</td>
<td>美国</td>
<td>辛格</td>
</tr>
<tr>
<td>杜宾的传记</td>
<td>美国</td>
<td>马拉默德</td>
</tr>
<tr>
<td>洪堡的礼物</td>
<td>美国</td>
<td>贝娄</td>
</tr>
<tr>
<td>更多的人死于心碎</td>
<td>美国</td>
<td>贝娄</td>
</tr>
<tr>
<td>时震</td>
<td>美国</td>
<td>冯内古特</td>
</tr>
<tr>
<td>刽子手之歌</td>
<td>美国</td>
<td>梅勒</td>
</tr>
<tr>
<td>苏菲的抉择</td>
<td>美国</td>
<td>斯泰伦</td>
</tr>
<tr>
<td>情欲艺术家</td>
<td>美国</td>
<td>霍克斯</td>
</tr>
<tr>
<td>铁草</td>
<td>美国</td>
<td>肯尼迪</td>
</tr>
<tr>
<td>最蓝的眼睛</td>
<td>美国</td>
<td>莫里森</td>
</tr>
<tr>
<td>所罗门之歌</td>
<td>美国</td>
<td>莫里森</td>
</tr>
<tr>
<td>白雪公主后传</td>
<td>美国</td>
<td>巴塞尔姆</td>
</tr>
<tr>
<td>拉格泰姆时代</td>
<td>美国</td>
<td>多克特罗</td>
</tr>
<tr>
<td>兔子回家</td>
<td>美国</td>
<td>厄普代克</td>
</tr>
<tr>
<td>变形记</td>
<td>美国</td>
<td>厄普代克</td>
</tr>
<tr>
<td>反生活</td>
<td>美国</td>
<td>罗斯</td>
</tr>
<tr>
<td>人性的污点</td>
<td>美国</td>
<td>罗斯</td>
</tr>
<tr>
<td>遗产-一个真实的故事</td>
<td>美国</td>
<td>罗斯</td>
</tr>
<tr>
<td>骏马长嘶</td>
<td>美国</td>
<td>麦卡锡</td>
</tr>
<tr>
<td>孤独鸽</td>
<td>美国</td>
<td>麦克默特里</td>
</tr>
<tr>
<td>葡萄园</td>
<td>美国</td>
<td>品钦</td>
</tr>
<tr>
<td>幽灵之家</td>
<td>美国</td>
<td>阿连德</td>
</tr>
<tr>
<td>不规则飞行</td>
<td>美国</td>
<td>纳尔逊</td>
</tr>
<tr>
<td>紫色</td>
<td>美国</td>
<td>沃克</td>
</tr>
<tr>
<td>纽约女人未眠夜</td>
<td>美国</td>
<td>提尔曼</td>
</tr>
<tr>
<td>一千英亩</td>
<td>美国</td>
<td>斯迈利</td>
</tr>
<tr>
<td>时时刻刻</td>
<td>美国</td>
<td>坎宁安</td>
</tr>
<tr>
<td>达·芬奇密码</td>
<td>美国</td>
<td>布朗</td>
</tr>
<tr>
<td>神圣的夜晚</td>
<td>摩洛哥</td>
<td>杰伦</td>
</tr>
<tr>
<td>帝国轶闻</td>
<td>墨西哥</td>
<td>帕索</td>
</tr>
<tr>
<td>七月的人民</td>
<td>南非</td>
<td>戈迪默</td>
</tr>
<tr>
<td>耻</td>
<td>南非</td>
<td>库切</td>
</tr>
<tr>
<td>修道院纪事</td>
<td>葡萄牙</td>
<td>萨拉马戈</td>
</tr>
<tr>
<td>失明症漫记</td>
<td>葡萄牙</td>
<td>萨拉马戈</td>
</tr>
<tr>
<td>失乐园</td>
<td>日本</td>
<td>渡边淳一</td>
</tr>
<tr>
<td><strong>挪威的森林</strong></td>
<td>日本</td>
<td>村上春树</td>
</tr>
<tr>
<td>无限近似于透明的蓝</td>
<td>日本</td>
<td>村上龙</td>
</tr>
<tr>
<td>厨房</td>
<td>日本</td>
<td>吉本芭娜娜</td>
</tr>
<tr>
<td>印第安的最后夏天</td>
<td>瑞士</td>
<td>谢赛克斯</td>
</tr>
<tr>
<td>哈扎尔辞典</td>
<td>塞尔维亚</td>
<td>帕维奇</td>
</tr>
<tr>
<td>老人</td>
<td>苏联</td>
<td>特里丰诺夫</td>
</tr>
<tr>
<td>红莓</td>
<td>苏联</td>
<td>舒克申</td>
</tr>
<tr>
<td>我的名字叫红</td>
<td>土耳其</td>
<td>帕慕克</td>
</tr>
<tr>
<td>独裁者的葬礼</td>
<td>委内瑞拉</td>
<td>彼特里</td>
</tr>
<tr>
<td>请听清风倾诉</td>
<td>乌拉圭</td>
<td>奥内蒂</td>
</tr>
<tr>
<td>为亡灵弹奏</td>
<td>西班牙</td>
<td>塞拉</td>
</tr>
<tr>
<td>无命运的人生</td>
<td>匈牙利</td>
<td>凯尔泰斯</td>
</tr>
<tr>
<td>蓝山</td>
<td>以色列</td>
<td>沙莱夫</td>
</tr>
<tr>
<td>玫瑰的名字</td>
<td>意大利</td>
<td>埃科</td>
</tr>
<tr>
<td>阿纳泰的贝壳</td>
<td>意大利</td>
<td>斯戈隆</td>
</tr>
<tr>
<td>人性的因素</td>
<td>英国</td>
<td>格林</td>
</tr>
<tr>
<td>河湾</td>
<td>英国</td>
<td>奈保尔</td>
</tr>
<tr>
<td>抵达之谜</td>
<td>英国</td>
<td>奈保尔</td>
</tr>
<tr>
<td>来自无人地带的明信片</td>
<td>英国</td>
<td>钱伯斯</td>
</tr>
<tr>
<td>隐之书</td>
<td>英国</td>
<td>拜厄特</td>
</tr>
<tr>
<td>时间中的孩子</td>
<td>英国</td>
<td>麦克尤恩</td>
</tr>
<tr>
<td>化学</td>
<td>英国</td>
<td>斯威夫特</td>
</tr>
<tr>
<td>长日留痕</td>
<td>英国</td>
<td>石黑一雄</td>
</tr>
<tr>
<td>卑微的神灵</td>
<td>印度</td>
<td>罗易</td>
</tr>
<tr>
<td>夜阑更深</td>
<td>印度尼西亚</td>
<td>维查雅</td>
</tr>
<tr>
<td>人世间</td>
<td>印度尼西亚</td>
<td>普拉姆迪亚</td>
</tr>
<tr>
<td>旁边的花园</td>
<td>智利</td>
<td>多诺索</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>笔记</category>
      </categories>
      <tags>
        <tag>小说</tag>
      </tags>
  </entry>
</search>
